<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>STep by STep</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="STep by STep">
<meta property="og:url" content="http://sineyuan.github.io/index.html">
<meta property="og:site_name" content="STep by STep">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="STep by STep">
<meta name="twitter:description">
  
  
    <link rel="icon" href="/favicon.png">
  
  <!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'> -->
  <!-- <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css"> -->
  <link href="//fonts.useso.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
  <link href='//fonts.useso.com/css?family=Open+Sans:300,600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <a href="/" class="logo">STep by STep</a>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about/index.html">About</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://sineyuan.github.io"></form>
        </div>
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
        
        
          <a id="nav-github-link" class="nav-icon" href="https://github.com/SineYuan" title="Fork me on GitHub"></a>
        
      </nav>
    </div>
  </div>
</header>
      <nav id="mobile-nav" class="off">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about/index.html" class="mobile-nav-link">About</a>
  
  <div id="search-form-wrap-mobile">
    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://sineyuan.github.io"></form>
  </div>
</nav>
      <div class="outer">
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/01/27/go-naming/">(è¯‘)Go naming conventions</a>
          </li>
        
          <li>
            <a href="/2016/08/28/go-error-handle/">Golangé”™è¯¯å¤„ç†</a>
          </li>
        
          <li>
            <a href="/2016/05/29/deploy-k8s-on-coreos/">CoreOSéƒ¨ç½²kubernetes</a>
          </li>
        
          <li>
            <a href="/2016/05/29/coreos-osx-without-vagrant/">OSXä¸Šæ‘†è„±vagrantæ­å»ºCoreOSé›†ç¾¤</a>
          </li>
        
          <li>
            <a href="/2016/01/25/tornado-source-code-3/">tornadoæºç åˆ†æç¬”è®°(3)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://hexo.io">Hexo</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
        <section id="main">
  
    <article id="post-go-naming" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/27/go-naming/" class="article-date">
  <time datetime="2017-01-26T16:00:00.000Z" itemprop="datePublished">2017-01-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/27/go-naming/">(è¯‘)Go naming conventions</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>æœ¬æ–‡çš„å†…å®¹æ˜¯Andrew Gerrandåœ¨Meetup Golang Parisä¸Šä¸€æ¬¡æ¼”è®²slideçš„ç¿»è¯‘(<a href="https://www.youtube.com/watch?v=sFUSP8Au_PE" target="_blank" rel="external">youtube</a>ï¼Œ<a href="https://talks.golang.org/2014/names.slide#1" target="_blank" rel="external">slide</a>)ï¼Œå†…å®¹æ˜¯Goé‡Œé¢çš„ä¸€äº›å‘½åçš„è§„èŒƒä¸å»ºè®®ã€‚å†…å®¹ä¸é”™ï¼Œåœ¨è¿™é‡Œè®°å½•åˆ†äº«ã€‚</p>
<h2 id="Names_matter">Names matter</h2><p>å¯è¯»æ€§å®šä¹‰ä»£ç çš„è´¨é‡ã€‚</p>
<p>å¥½çš„å‘½åå¯¹å¯è¯»æ€§éå¸¸é‡è¦ã€‚</p>
<p>å¥½çš„å‘½åæ˜¯: </p>
<ul>
<li>è¿ç»­(å®¹æ˜“ç†è§£)</li>
<li>ç®€çŸ­(ä¾¿äºè¾“å…¥)</li>
<li>å‡†ç¡®(æ˜“äºç†è§£)</li>
</ul>
<h2 id="A_rule_of_thumb">A rule of thumb</h2><p>ä¸€ä¸ªå¸¸ç”¨çš„ç»éªŒæ³•åˆ™æ˜¯ï¼šä¸€ä¸ªå‘½åå£°æ˜ä¸ä½¿ç”¨çš„åœ°æ–¹çš„è·ç¦»è¶Šå¤§ï¼Œé‚£ä¹ˆè¿™ä¸ªåå­—åº”è¯¥è¶Šé•¿ã€‚</p>
<h2 id="Use_MixedCase">Use MixedCase</h2><p>åœ¨Goåº”ä½¿ç”¨é©¼å³°å‘½åæ³•(ä¸è¦ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å)ã€‚</p>
<p>é¦–å­—æ¯åº”è¯¥å¤§å†™ï¼Œåƒ<code>ServeHTTP</code> å’Œ <code>IDProcessor</code></p>
<h2 id="Local_variables">Local variables</h2><p>æœ¬åœ°å˜é‡åº”ä¿æŒç®€çŸ­ï¼Œé•¿çŸ­å‘½åå°†æœ‰ç¢é˜…è¯»ã€‚</p>
<p>ä¾‹å¦‚ä¸€äº›å¸¸ç”¨çš„çº¦å®šï¼š<br>ä½¿ç”¨ <code>i</code> è¡¨ç¤ºç´¢å¼•ã€‚<br>ä½¿ç”¨ <code>r</code> è¡¨ç¤ºreaderã€‚</p>
<p>é•¿å‘½åå¯èƒ½å¯¹äºå¾ˆé•¿çš„å‡½æ•°æˆ–æœ‰å¾ˆå¯¹æœ¬åœ°å˜é‡çš„å‡½æ•°å¾ˆæœ‰ç”¨ï¼Œä½†é‚£é€šå¸¸è¡¨ç¤ºä½ çš„ä»£ç éœ€è¦é‡æ„äº†ã€‚</p>
<h3 id="åğŸŒ°">åğŸŒ°</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func RuneCount(buffer []<span class="keyword">byte</span>) <span class="keyword">int</span> &#123;</span><br><span class="line">    <span class="keyword">index</span>, <span class="keyword">count</span> := <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">index</span> &lt; len(buffer) &#123;</span><br><span class="line">        <span class="keyword">if</span> buffer[<span class="keyword">index</span>] &lt; RuneSelf &#123;</span><br><span class="line">            <span class="keyword">index</span>++</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _, size := DecodeRune(buffer[<span class="keyword">index</span>:])</span><br><span class="line">            <span class="keyword">index</span> += size</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">count</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¥½ğŸŒ°">å¥½ğŸŒ°</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func RuneCount(b []<span class="typename">byte</span>) <span class="typename">int</span> &#123;</span><br><span class="line">    i, <span class="string">n :</span>= <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i &lt; len(b) &#123;</span><br><span class="line">        <span class="keyword">if</span> b[i] &lt; RuneSelf &#123;</span><br><span class="line">            i++</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _, <span class="string">size :</span>= DecodeRune(b[<span class="string">i:</span>])</span><br><span class="line">            i += size</span><br><span class="line">        &#125;</span><br><span class="line">        n++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å‚æ•°">å‚æ•°</h2><p>å‡½æ•°çš„å‚æ•°ä½œç”¨åƒæœ¬åœ°å˜é‡ï¼Œä½†å®ƒä»¬è¿˜å…·æœ‰æ–‡æ¡£çš„åŠŸèƒ½ã€‚</p>
<p>å½“å‚æ•°ç±»å‹å…·æœ‰æè¿°æ€§æ—¶ï¼Œä½¿ç”¨çŸ­å‘½åã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">AfterFunc</span><span class="params">(d Duration, f <span class="keyword">func</span><span class="params">()</span></span></span>) *<span class="type">Timer</span></span><br><span class="line"></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">Escape</span><span class="params">(w io.Writer, s []byte)</span></span></span><br></pre></td></tr></table></figure>
<p>å½“å‚æ•°ç±»å‹å¾ˆæ¨¡ç³Šæ—¶(ä¾‹å¦‚åŸç”Ÿç±»å‹ï¼Œç›¸åŒçš„ç±»å‹çš„å‚æ•°æ—¶)ï¼Œé‚£ä¹ˆå‚æ•°åå­—éœ€è¦åƒæ–‡æ¡£ä¸€æ ·è¯´æ˜ã€‚<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">Unix</span><span class="params">(sec, nsec int64)</span></span> <span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">HasPrefix</span><span class="params">(s, <span class="keyword">prefix</span> []byte)</span></span> bool</span><br></pre></td></tr></table></figure></p>
<h2 id="è¿”å›å€¼">è¿”å›å€¼</h2><p>å¯¹äºä¸€ä¸ªå¯¹å¤–å‘å¸ƒçš„å‡½æ•°ï¼Œè¿”å›å€¼åº”å‘½ååº”åƒæ–‡æ¡£ä¸€æ ·è¯´æ˜è¿”å›å€¼çš„ä½œç”¨ã€‚</p>
<p>å¥½çš„ä¾‹å­ï¼š<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Copy</span><span class="params">(dst Writer, src Reader)</span> <span class="params">(written int64, err error)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ScanBytes</span><span class="params">(data []byte, atEOF bool)</span> <span class="params">(advance int, token []byte, err error)</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="Receivers">Receivers</h2><p>Receiversæ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„å‚æ•°</p>
<p>é€šå¸¸æƒ…å†µï¼Œä½¿ç”¨ä¸€åˆ°ä¸¤ä¸ªå…¶ç±»å‹ç®€å†™çš„å­—ç¬¦è¡¨ç¤ºï¼Œå› ä¸ºåœ¨æ–¹æ³•é‡Œé¢ä»–ä»¬ä¼šç»å¸¸å‡ºç°</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Read</span><span class="params">(p []byte)</span> <span class="params">(n int, err error)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sh serverHandler)</span> <span class="title">ServeHTTP</span><span class="params">(rw ResponseWriter, req *Request)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Rectangle)</span> <span class="title">Size</span><span class="params">()</span> <span class="title">Point</span></span></span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªç±»å‹çš„æ–¹æ³•Receiverå‘½ååº”ä¿æŒä¸€è‡´(ä¸è¦åœ¨ä¸€ä¸ªæ–¹æ³•é‡Œé¢ç”¨<code>r</code>è€Œåœ¨å¦ä¸€ä¸ªæ–¹æ³•é‡Œç”¨<code>rdr</code>)</p>
<h2 id="Exported_package-level_names">Exported package-level names</h2><p>ä¸€ä¸ªåŒ…çš„å¯¼å‡ºçš„åå­—è¢«å…¶åŒ…å‘½ä¿®é¥°ï¼Œæ—¶æ—¶é“­è®°è¿™ä¸€ç‚¹ã€‚<br>æ‰€ä»¥åœ¨æ ‡å‡†åº“é‡Œé¢æœ‰<code>bytes.Buffer</code>å’Œ<code>strings.Reader</code>ï¼Œè€Œä¸æ˜¯<code>bytes.ByteBuffer</code>,<code>strings.StringReader</code></p>
<h2 id="æ¥å£ç±»å‹">æ¥å£ç±»å‹</h2><p>å¦‚æœä¸€ä¸ªæ¥å£é‡Œé¢åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£é€šå¸¸ç»™æ–¹æ³•ååé¢åŠ ä¸€ä¸ªâ€™erâ€™å°±å¥½äº†ã€‚</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader interface &#123;</span><br><span class="line">    <span class="keyword">Read</span>(p []byte) (<span class="keyword">n</span> int, <span class="keyword">err</span> <span class="keyword">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è™½ç„¶æœ‰æ—¶è‹±è¯­è¯­æ³•ä¸Šæ˜¯ä¸å¯¹çš„ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯è¿™ä¹ˆåš(but we do it anyway)<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="typedef"><span class="keyword">type</span> <span class="type">Execer</span> interface <span class="container">&#123;</span><br><span class="line">    <span class="type">Exec</span>(query string, args []<span class="type">Value</span>) (<span class="type">Result</span>, error)</span><br><span class="line">&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>æœ‰æ—¶è¦åšä¸€äº›è½¬æ¢çœ‹èµ·æ¥æ›´å¥½<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="typedef"><span class="keyword">type</span> <span class="type">ByteReader</span> interface <span class="container">&#123;</span><br><span class="line">    <span class="type">ReadByte</span>() (c byte, err error)</span><br><span class="line">&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>ä½†ä¸€ä¸ªæ¥å£åŒ…å«å¤šä¸ªæ–¹æ³•æ˜¯ï¼Œé€‰æ‹©åå­—éœ€è¦å‡†ç¡®çš„æè¿°è¿™ä¸ªå€Ÿå£çš„ä½œç”¨(ä¾‹å¦‚: <code>net.Conn</code>, <code>http.ResponseWriter</code>, <code>io.ReadWriter</code>)</p>
<h2 id="Error">Error</h2><p>é”™è¯¯ç±»å‹å‘½åç±»ä¼¼<code>FooError</code>:</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="constant">ExitError</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é”™è¯¯å€¼å‘½åç±»ä¼¼<code>ErrFoo</code>:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">var</span> ErrFormat = errors.<span class="function"><span class="title">New</span><span class="params">(<span class="string">"image: unknown format"</span>)</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="åŒ…å‘½å">åŒ…å‘½å</h2><p>å¯¹å¤–å‘å¸ƒçš„åŒ…ååº”è¯¥è¯´æ˜åŒ…çš„ä½œç”¨</p>
<p>é¿å…ä½¿ç”¨utilï¼Œcommonï¼Œç­‰ç­‰</p>
<h2 id="Import_paths">Import paths</h2><p>åŒ…çš„æœ€åä¸€ä¸ªéƒ¨åˆ†çš„è·¯å¾„åº”å’ŒåŒ…åç›¸åŒã€‚<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"compress/gzip"</span> <span class="comment">// package gzip</span></span><br></pre></td></tr></table></figure></p>
<p>é¿å…åœ¨åŒ…è·¯å¾„ä¸Šç»“å·´(233)ã€‚</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"code.google.com/p/goauth2/oauth2"</span> <span class="comment">// bad; my fault</span></span><br></pre></td></tr></table></figure>
<p>å¯¹äºåº“æ¥è¯´ï¼Œé€šå¸¸å°†ä»£ç æ”¾åœ¨æ ¹ç›®å½•ä¸‹ã€‚<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"github.com/golang/oauth2"</span> <span class="comment">// package oauth2</span></span><br></pre></td></tr></table></figure></p>
<p>é¿å…å¤§å†™å­—æ¯(ä¸æ˜¯æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿéƒ½æ˜¯å¤§å°å†™æ•æ„Ÿçš„)ã€‚</p>
<h2 id="æ ‡å‡†åº“">æ ‡å‡†åº“</h2><p>æ–‡ä¸­è®¸å¤šä¾‹å­éƒ½æ˜¯æ¥è‡ªæ ‡å‡†åº“ã€‚</p>
<p>æ ‡å‡†åº“æ˜¯ä¸ªå¯»æ‰¾ä¼˜ç§€Goä»£ç çš„åœ°æ–¹ï¼Œå¸¸çœ‹å¸¸æ–°ã€‚</p>
<p><em>ä½†è¯·è®°ä½</em>:</p>
<blockquote>
<p>When the standard library was written, we were still learning.<br>Most of it we got right, but we made some mistakes.</p>
</blockquote>
<h2 id="Conclusion">Conclusion</h2><p>Use short names.<br>ä½¿ç”¨çŸ­çš„åå­—</p>
<p>Think about context.<br>å¤šæ€è€ƒä¸Šä¸‹æ–‡</p>
<p>Use your judgment.<br>è¦æœ‰è‡ªå·±çš„åˆ¤æ–­</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2017/01/27/go-naming/" data-id="ciygp2sng0000wb13brv1ou3z" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2017/01/27/go-naming/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-go-error-handle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/28/go-error-handle/" class="article-date">
  <time datetime="2016-08-27T17:25:03.000Z" itemprop="datePublished">2016-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/28/go-error-handle/">Golangé”™è¯¯å¤„ç†</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>æœ¬æ–‡æ˜¯GopherCon 2016çš„æ¼”è®²<a href="https://www.youtube.com/watch?v=lsBF58Q-DnY" target="_blank" rel="external">Dont Just Check Errors Handle Them Gracefully</a>çš„ç¬”è®°ï¼Œè¯¦æƒ…å¯ç‚¹å‡»é“¾æ¥è§‚çœ‹(è¯·å¸¦æ¢¯å­ä¸Šæ²¹ç®¡)</p>
<h2 id="å¸¸è§é”™è¯¯å¤„ç†ç­–ç•¥">å¸¸è§é”™è¯¯å¤„ç†ç­–ç•¥</h2><h3 id="Sentiel_errors">Sentiel errors</h3><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err == ErrSomething &#123; <span class="attribute">...</span> &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯æœ€å¸¸è§çš„å¤„ç†æ–¹æ³•ï¼Œé€šè¿‡åˆ¤æ–­é”™è¯¯ç±»å‹æ¥åšç›¸åº”çš„å¤„ç†ã€‚å¸¸è§çš„æœ‰</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">io<span class="class">.EOF</span></span><br><span class="line">syscall<span class="class">.ENOENT</span></span><br><span class="line">go/build<span class="class">.NoGoError</span></span><br><span class="line">path/filepath.SkipDir</span><br></pre></td></tr></table></figure>
<p>ä½†è¿™ç§å¤„ç†æ–¹æ³•æ˜¯æœ€ä¸çµæ´»çš„ä¸€ç§æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»çŸ¥é“ç¡®å®šçš„é”™è¯¯ç±»å‹ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦ä½¿ç”¨è‡ªå®šä¹‰çš„ä¸€äº›é”™è¯¯ç±»å‹ï¼Œå½“æˆ‘ä»¬çš„ä»£ç ä½œä¸ºä¸€ä¸ªpackageå¯¼å‡ºæ—¶ï¼Œé”™è¯¯å˜æˆäº†apiçš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·å°±æœ‰äº†å¼ºè€¦åˆï¼Œä»¥åè¦æ˜¯ä¿®æ”¹é”™è¯¯ä¼šå¾ˆéº»çƒ¦ã€‚</p>
<p>å¦å¤–ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨<code>fmt.Errorf</code>çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡åˆ¤æ–­é”™è¯¯stringçš„å†…å®¹æ¥åŒºåˆ†é”™è¯¯ï¼Œå¦‚ï¼š</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">func</span> <span class="tag">readfile</span>(<span class="tag">path</span> <span class="tag">string</span>) <span class="tag">error</span> <span class="rules">&#123;</span><br><span class="line">		<span class="rule"><span class="attribute">err </span>:<span class="value">= <span class="function">openfile</span>(path)</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">				return fmt.<span class="function">Errorf</span>(<span class="string">"cannot open file: %v"</span>, err)</span><br><span class="line">		</span></span></span>&#125;</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">func</span> <span class="tag">main</span>() <span class="rules">&#123;</span><br><span class="line">		<span class="rule"><span class="attribute">err </span>:<span class="value">= <span class="function">readfile</span>(<span class="string">".bash"</span>)</span><br><span class="line">		if strings.<span class="function">Contains</span>(err.<span class="function">Error</span>(), <span class="string">"not found"</span>) &#123;</span><br><span class="line">				// handle error</span><br><span class="line">		</span></span></span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ç§éå¸¸ç³Ÿç³•çš„åšæ³•ï¼Œå½“é”™è¯¯ä¿¡æ¯æ”¹å˜æ—¶ï¼Œå¯¹åº”çš„é”™è¯¯å¤„ç†ä¹Ÿè¦ç›¸åº”æ”¹å˜ï¼Œ å¦å¤–è¿˜è¦æ€§èƒ½çš„é—®é¢˜ã€‚</p>
<p>é™¤éæ˜¯æ ‡å‡†åº“é‡Œé¢çš„å‡½æ•°ï¼Œå¦åˆ™é¿å…ä½¿ç”¨Sentiel errors</p>
<h3 id="Error_Types">Error Types</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">err</span>, ok := <span class="keyword">err</span>.(SomeType); ok &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>é…åˆType assertionä½¿ç”¨</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">err :</span>= somethint()</span><br><span class="line"><span class="keyword">switch</span> <span class="string">err :</span>= err.(type) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">nil:</span></span><br><span class="line">		<span class="comment">// call succeed</span></span><br><span class="line"><span class="keyword">case</span> *os.<span class="string">PathError:</span></span><br><span class="line">		<span class="comment">// handle PathError</span></span><br><span class="line"><span class="string">default:</span></span><br><span class="line">		<span class="comment">// handle Unknow error			</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå…¶å®æ²¡ä»€ä¹ˆå¥½è®²çš„ï¼ŒåŒæ ·çš„ï¼ŒError Typesä¹Ÿä¼šé€ æˆåŒ…ä¹‹é—´çš„å¼ºè€¦åˆï¼Œé™¤éæ˜¯åœ¨åŒ…å†…éƒ¨ä½¿ç”¨ï¼Œå¦åˆ™ä¸æ¨èä½¿ç”¨</p>
<h3 id="Opaque_errors">Opaque errors</h3><p>Opaqueæ˜¯ä¸é€æ˜çš„æ„æ€ï¼Œè¿™ä¸ªæ˜¯è®²è€…è‡ªå·±çš„å«æ³•ï¼Œå…·ä½“çš„æ€æƒ³å°±æ˜¯:</p>
<blockquote>
<p>Assert errors for behaviour, not type<br>é€šè¿‡è¡Œä¸ºæ¥åˆ¤æ–­é”™è¯¯è€Œä¸æ˜¯ç±»å‹</p>
</blockquote>
<p>è¯´èµ·è¡Œä¸ºï¼Œå¾ˆè‡ªç„¶çš„å°±è”æƒ³åˆ°äº†interfaceï¼Œå¯¹çš„ï¼Œä¸ä½¿ç”¨typeï¼Œä½¿ç”¨interfaceæ¥å¤„ç†ã€‚</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> temporary interface &#123;</span><br><span class="line">		Tepporary() bool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func IsTemporary(<span class="keyword">err</span> <span class="keyword">error</span>) bool &#123;</span><br><span class="line">		<span class="keyword">te</span>, ok := <span class="keyword">err</span>.(temporary)</span><br><span class="line">		<span class="keyword">return</span> ok &amp;&amp; <span class="keyword">te</span>.Temporary()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹æ³•çš„è€¦åˆåº¦æ›´ä½ä¸€äº›ï¼Œä¸è¿‡æ— æ³•å®Œå…¨é¿å…ä¾èµ–åº¦ï¼Œæ¯•ç«Ÿinterfaceä¹Ÿæ˜¯apiçš„ä¸€éƒ¨åˆ†ã€‚</p>
<h2 id="Donâ€™t_just_check_errors,_handle_then_greacefully">Donâ€™t just check errors, handle then greacefully</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™åº”è¯¥æœ€å¸¸è§çš„é”™è¯¯å¤„ç†ï¼Œä¸è¿‡æƒ³æƒ³å½“ä¸€ä¸ªé”™è¯¯ç»è¿‡å±‚å±‚çš„returnï¼Œå½“åˆ°è¾¾æœ€å¤–é¢çš„logè®°å½•äº†ä¸‹æ¥ã€‚ä½†å½“ä½ debugæŸ¥æ‰¾æ—¥å¿—æ—¶åªçœ‹åˆ°ä¸€å¥</p>
<blockquote>
<p>No such file or directory</p>
</blockquote>
<p>å¿ƒé‡Œä¼šä¸ä¼šä¸‡åŒ¹è‰æ³¥é©¬å¥”è…¾(â•¯â€µâ–¡â€²)â•¯ï¸µâ”´â”€â”´  </p>
<p>æ˜¯çš„ï¼Œè¿™ç§æ–¹æ³•åå¤„å°±æ˜¯ç ´åäº†é”™è¯¯å‘ç”Ÿçš„ä¸Šçº¿æ–‡ç¯å¢ƒï¼Œdebugèµ·æ¥å°±å¾ˆå›°éš¾ã€‚</p>
<p>å½“ç„¶æˆ‘ä»¬ä½¿ç”¨<code>fmt.Errorf</code>ä¸ºé”™è¯¯åŠ ä¸Šä¸€äº›ä¿¡æ¯</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">AuthenticatRequest</span><span class="params">(r *Request)</span></span> error &#123;</span><br><span class="line">		err := authenticate(r.<span class="type">User</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.<span class="type">Errorf</span>(<span class="string">"authenticat failed: %v"</span>, err)</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æ›´ä¼˜é›…ä¸€ç‚¹ï¼Œè®²è€…æä¾›äº†ä¸€ä¸ªåŒ…<code>github.com/pkg/errors</code>åšè¿™ä¸ªäº‹æƒ…ã€‚</p>
<p>è¿™ä¸ªåŒ…çš„apiä¹Ÿå¾ˆç®€å•</p>
<h4 id="errors-New">errors.New</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">err := errors.<span class="function"><span class="title">New</span><span class="params">(<span class="string">"kerboom"</span>)</span></span></span><br><span class="line">fmt.<span class="function"><span class="title">Printf</span><span class="params">(<span class="string">"%v\n"</span>, err)</span></span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>errors.New</code>æ–°å»ºçš„erræ‰“å°æ—¶ä¼šå±•ç¤ºå‡ºè°ƒç”¨å †æ ˆ</p>
<h4 id="errors-Wrap">errors.Wrap</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">err := errors.Warp(</span><br><span class="line">			syscall<span class="class">.EBADF</span>, <span class="string">"couldn't write to stream"</span>)</span><br><span class="line">fmt.<span class="function"><span class="title">Printf</span><span class="params">(<span class="string">"%v\n"</span>, err)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡º			</span></span><br><span class="line">ï¼ï¼ couldn<span class="string">'t write to stream: bad file descriptor</span></span><br></pre></td></tr></table></figure>
<h4 id="errors-Cause">errors.Cause</h4><p>æœ‰Wrapæ–¹æ³•é‚£ä¹Ÿä¼šæœ‰UnWrapçš„æ–¹æ³•ï¼Œè¿™å°±æ˜¯<code>errors.Cause</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errors.<span class="function"><span class="title">Cause</span><span class="params">(err)</span></span>  <span class="comment">// è¿”å›Wrapä¹‹å‰çš„error</span></span><br></pre></td></tr></table></figure>
<p>å‰é¢çš„ä¾‹å­éœ€è¦æ”¹æˆè¿™æ ·</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> temporary interface &#123;</span><br><span class="line">		Tepporary() bool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func IsTemporary(<span class="keyword">err</span> <span class="keyword">error</span>) bool &#123;</span><br><span class="line">		<span class="keyword">te</span>, ok := <span class="keyword">err</span>.Cause(<span class="keyword">err</span>).(temporary)</span><br><span class="line">		<span class="keyword">return</span> ok &amp;&amp; <span class="keyword">te</span>.Temporary()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>github.com/pkg/errors</code>ä»£ç ä¹Ÿå°±å‡ ç™¾è¡Œï¼Œè¿˜æ˜¯å¾ˆä¸é”™çš„ï¼Œå€¼å¾—æ¨èã€‚</p>
<p>ä»¥ä¸Š</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/08/28/go-error-handle/" data-id="ciygo85oz00093x134ycsjabm" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/08/28/go-error-handle/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-deploy-k8s-on-coreos" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/29/deploy-k8s-on-coreos/" class="article-date">
  <time datetime="2016-05-29T14:07:38.000Z" itemprop="datePublished">2016-05-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/29/deploy-k8s-on-coreos/">CoreOSéƒ¨ç½²kubernetes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h2><h3 id="ä¸‹è½½Kubernetes">ä¸‹è½½Kubernetes</h3><p>åœ¨<a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="external">github</a>ä¸‹è½½æœ€æ–°çš„kuberbetesäºŒè¿›åˆ¶åŒ…ï¼Œè¿™é‡Œæˆ‘ä¸‹è½½çš„æ˜¯v1.2.4çš„ç‰ˆæœ¬ã€‚</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf kubernetes<span class="class">.tar</span><span class="class">.gz</span></span><br><span class="line">cd kubernetes</span><br><span class="line"><span class="comment">// è§£å‹amd64çš„ç‰ˆæœ¬</span></span><br><span class="line">tar zxvf kubernetes/server/kubernetes-server-linux-amd64<span class="class">.tar</span><span class="class">.gz</span></span><br><span class="line">cd kubernetes/server/kubernetes/server/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†ä¸‹åˆ—æ–‡ä»¶å¤åˆ¶åˆ°å„ä¸ªèŠ‚ç‚¹ä¸Š</span></span><br><span class="line">cp kube-apiserver kube-proxy kubelet kube-scheduler kube-controller-manager /opt/bin</span><br></pre></td></tr></table></figure>
<p>å°†kube-apiserver kube-proxy kubelet kube-scheduler kube-controller-managerå¤åˆ¶åˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ‘è¿™é‡Œæ”¾åˆ°å„ä¸ªèŠ‚ç‚¹åˆ°<code>/opt/bin</code>æ–‡ä»¶å¤¹é‡Œ</p>
<h3 id="å¯åŠ¨etcd">å¯åŠ¨etcd</h3><p>å¯ä»¥å‚è€ƒ<a href="http://sineyuan.github.io/2016/05/29/coreos-osx-without-vagrant/">å‰æ–‡</a>ã€‚ç¡®ä¿etcdctlå‘½ä»¤å¯ç”¨ã€‚åœ¨è¿™é‡Œæˆ‘ç”¨etcd2ä»£æ›¿etcd</p>
<h2 id="é…ç½®ç½‘ç»œ">é…ç½®ç½‘ç»œ</h2><p>ç”±äºæ¯ä¸ªèŠ‚ç‚¹dockerå®¹å™¨çš„ipå¯èƒ½æ˜¯ç›¸åŒçš„ï¼Œä¸ºäº†ä½¿ä¸åŒèŠ‚ç‚¹ä¸Šçš„dockerå®¹å™¨èƒ½å¤Ÿäº’ç›¸è¿æ¥ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€ç§æ–¹æ³•æ¥ç»Ÿä¸€åˆ†é…æ¯ä¸ªèŠ‚ç‚¹çš„dockerå®¹å™¨ipï¼Œé˜²æ­¢å†²çªï¼Œå¹¶æä¾›ä¸åŒèŠ‚ç‚¹å®¹å™¨çš„è¿æ¥èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯SDN(software defined network) kubernetesæ²¡æœ‰æä¾›è¿™ä¸ªåŠŸèƒ½ï¼Œä¸è¿‡æœ‰è®¸å¤šçš„kubernetesç¤¾åŒºæœ‰è®¸å¤šè§£å†³æ–¹æ¡ˆã€‚å¦‚<code>flannel</code>,<code>calico</code>, <code>OVS</code> ç­‰</p>
<p>è¿™é‡Œæˆ‘é€‰ç”¨CoreOSçš„flannel</p>
<p>flannelä½¿ç”¨etcdæ¥ä¿å­˜å­ç½‘ipç­‰åˆ†é…ï¼Œæ–°åŠ å…¥èŠ‚ç‚¹çš„flannedé€šè¿‡è®¿é—®etcdæ¥è·å–ä¸€ä¸ªå¯ç”¨çš„å­ç½‘ç½‘æ®µï¼Œå¹¶è´Ÿè´£å®¹å™¨é—´çš„ä»£ç†è½¬å‘ã€‚</p>
<p>åœ¨CoreOSä¸­è‡ªå¸¦flannel.serviceï¼Œä½†å®é™…ä¸ŠCoreOSä¸ºäº†èŠ‚çœç©ºé—´ï¼Œè¿™ä¸ªserviceå®é™…ä¸Šæ˜¯è¿è¡Œäº†ä¸€ä¸ªflannelçš„dockerå®¹å™¨ï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶éœ€è¦ä»ç½‘ç»œä¸‹è½½flannelçš„é•œåƒã€‚ç”±äºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶åŒ…å§ã€‚</p>
<p>åœ¨<a href="https://github.com/coreos/flannel" target="_blank" rel="external">https://github.com/coreos/flannel</a>ä¸‹è½½æœ€æ–°çš„releaseï¼Œè§£å‹å‡ºflanneldï¼ŒåŒæ ·æ”¾å…¥<code>/opt/bin</code>é‡Œ</p>
<p>åœ¨æ‰€æœ‰èŠ‚ç‚¹<code>/etc/systemd/system/*.service</code>é‡Œæ·»åŠ <code>flannel.service</code>æ–‡ä»¶</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Flannel network fabric for CoreOS</span></span></span><br><span class="line"><span class="setting">Requires=<span class="value">etcd2.service</span></span></span><br><span class="line"><span class="setting">After=<span class="value">etcd2.service</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Service]</span></span><br><span class="line"><span class="setting">EnvironmentFile=<span class="value">/etc/environment</span></span></span><br><span class="line"><span class="setting">ExecStartPre=<span class="value">-/bin/bash -c <span class="string">"until /usr/bin/etcdctl set /coreos.com/network/config '&#123;\"Network\": \"10.100.0.0/16\"&#125;'; do echo \"waiting for etcd to become available...\"; sleep 5; done"</span></span></span></span><br><span class="line"><span class="setting">ExecStart=<span class="value">/opt/bin/flanneld -iface=<span class="variable">$private_ipv4</span></span></span></span><br><span class="line"><span class="setting">ExecStartPost=<span class="value">-/bin/bash -c <span class="string">"until [ -e /run/flannel/subnet.env ]; do echo \"waiting for write.\"; sleep 3; done"</span></span></span></span><br><span class="line"><span class="setting">Restart=<span class="value"><span class="keyword">on</span>-failure</span></span></span><br><span class="line"><span class="setting">RestartSec=<span class="value"><span class="number">5</span></span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Install]</span></span><br><span class="line"><span class="setting">WantedBy=<span class="value">multi-user.target</span></span></span><br></pre></td></tr></table></figure>
<p>flanneldæˆåŠŸè·å–åˆ°å­ç½‘ç½‘æ®µåä¼šä»¥ç¯å¢ƒå˜é‡çš„å½¢å¼ä¿å­˜åœ¨<code>/run/flannel/subnet.env</code>æ–‡ä»¶é‡Œã€‚æˆ‘ä»¬å†ä¿®æ”¹<code>docker.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Docker Application Container Engine</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">http://docs.docker.com</span></span></span><br><span class="line"><span class="setting">After=<span class="value">docker.socket early-docker.target network.target flannel.service</span></span></span><br><span class="line"><span class="setting">Requires=<span class="value">docker.socket early-docker.target flannel.service</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Service]</span></span><br><span class="line"><span class="setting">Environment=<span class="value"><span class="string">"DOCKER_CGROUPS=--exec-opt native.cgroupdriver=systemd"</span></span></span></span><br><span class="line"><span class="setting">EnvironmentFile=<span class="value">/run/flannel/subnet.env</span></span></span><br><span class="line"><span class="setting">MountFlags=<span class="value">slave</span></span></span><br><span class="line"><span class="setting">LimitNOFILE=<span class="value"><span class="number">1048576</span></span></span></span><br><span class="line"><span class="setting">LimitNPROC=<span class="value"><span class="number">1048576</span></span></span></span><br><span class="line"><span class="setting">ExecStartPre=<span class="value">-/usr/bin/ip link set dev docker0 down</span></span></span><br><span class="line"><span class="setting">ExecStartPre=<span class="value">-/usr/sbin/brctl delbr docker0</span></span></span><br><span class="line"><span class="setting">ExecStart=<span class="value">/usr/lib/coreos/dockerd daemon --host=fd:// <span class="variable">$DOCKER_OPTS</span> <span class="variable">$DOCKER_CGROU</span> --bip=<span class="variable">$&#123;FLANNEL_SUBNET&#125;</span> --mtu=<span class="variable">$&#123;FLANNEL_MTU&#125;</span> <span class="variable">$DOCKER_OPTS</span></span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Install]</span></span><br><span class="line"><span class="setting">WantedBy=<span class="value">multi-user.target</span></span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨subnet.envä¸­çš„å‚æ•°å¯åŠ¨docker service, ä¿è¯ä¸åŒèŠ‚ç‚¹çš„dockerå®¹å™¨ç½‘æ®µä¸åŒã€‚</p>
<h3 id="é…ç½®kubernetesç»„ä»¶">é…ç½®kubernetesç»„ä»¶</h3><p>etcdå’Œç½‘ç»œé…ç½®å¥½äº†ä»¥ååé¢çš„å°±æ²¡ä»€ä¹ˆçš„äº†ã€‚<br>åœ¨<code>/etc/systemd/system/*.service</code>ä¸‹åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶æ–¹ä¾¿æˆ‘ä»¬ç®¡ç†è¿™äº›æœåŠ¡</p>
<p>åœ¨masterèŠ‚ç‚¹åˆ›å»º</p>
<p><code>kube-apiserver.service</code></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">Requires=etcd2.service</span><br><span class="line">After=etcd2.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/opt/bin/kube-apiserver \</span><br><span class="line">        -<span class="ruby">-allow-privileged=<span class="keyword">true</span> \</span><br><span class="line"></span>        -<span class="ruby">-etcd-servers=<span class="symbol">http:</span>/<span class="regexp">/$private_ipv4:2379 \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-insecure-bind-address=0.0.0.0 \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-advertise-address=$private_ipv4 \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-service-cluster-ip-range=10.100.0.0/</span><span class="number">16</span> \</span><br><span class="line"></span>        -<span class="ruby">-runtime-config=extensions/v1beta1/daemonsets=<span class="keyword">true</span>,extensions/v1beta1/deployments=<span class="keyword">true</span>,extensions/v1beta1/ingress=<span class="keyword">true</span> \</span><br><span class="line"></span>        -<span class="ruby">-logtostderr=<span class="keyword">true</span></span><br><span class="line"></span>Restart=always</span><br><span class="line">RestartSec=10</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>kube-controller-manager.service</code></p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line"><span class="constant">Description</span>=Kubernetes Controller Manager</span><br><span class="line"><span class="constant">Documentation</span>=https:<span class="comment">//github.com/GoogleCloudPlatform/kubernetes</span></span><br><span class="line"><span class="constant">Requires</span>=kube-apiserver.service</span><br><span class="line"><span class="constant">After</span>=kube-apiserver.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="constant">ExecStart</span>=/opt/bin/kube-controller-manager \</span><br><span class="line">        --master=$private_ipv4:<span class="number">8080</span> \</span><br><span class="line">        --logtostderr=<span class="literal">true</span></span><br><span class="line"><span class="constant">Restart</span>=always</span><br><span class="line"><span class="constant">RestartSec</span>=<span class="number">10</span></span><br><span class="line">[Install]</span><br><span class="line"><span class="constant">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>kube-scheduler.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Kubernetes Scheduler</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">https://github.com/GoogleCloudPlatform/kubernetes</span></span></span><br><span class="line"><span class="setting">Requires=<span class="value">kube-apiserver.service</span></span></span><br><span class="line"><span class="setting">After=<span class="value">kube-apiserver.service</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Service]</span></span><br><span class="line"><span class="setting">ExecStart=<span class="value">/opt/bin/kube-scheduler --master=<span class="variable">$private_ipv4</span>:<span class="number">8080</span> --logtostderr=<span class="keyword">true</span></span></span></span><br><span class="line"><span class="setting">Restart=<span class="value">always</span></span></span><br><span class="line"><span class="setting">RestartSec=<span class="value"><span class="number">10</span></span></span></span><br><span class="line"><span class="title">[Install]</span></span><br><span class="line"><span class="setting">WantedBy=<span class="value">multi-user.target</span></span></span><br></pre></td></tr></table></figure>
<p>åœ¨nodeèŠ‚ç‚¹åˆ›å»º</p>
<p><code>kubelet.service</code></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line"> Description=Kubernetes Kubelet</span><br><span class="line"> Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"> After=docker.service</span><br><span class="line"> Requires=docker.service</span><br><span class="line"></span><br><span class="line"> [Service]</span><br><span class="line"> ExecStartPre=/usr/bin/mkdir -p /etc/kubernetes/manifests</span><br><span class="line"> ExecStart=/opt/bin/kubelet \</span><br><span class="line">        -<span class="ruby">-address=<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> \</span><br><span class="line"></span>        -<span class="ruby">-allow-privileged=<span class="keyword">true</span> \</span><br><span class="line"></span>        -<span class="ruby">-cluster-dns=<span class="number">10.100</span>.<span class="number">0</span>.<span class="number">10</span> \</span><br><span class="line"></span>        -<span class="ruby">-cluster-domain=cluster.local \</span><br><span class="line"></span>        -<span class="ruby">-config=<span class="regexp">/etc/kubernetes</span><span class="regexp">/manifests \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-hostname-override=$private_ipv4 \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-api-servers=http:/</span><span class="regexp">/&lt;API_SERVER_IP&gt;:8080 \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-pod-infra-container-image="kubernetes/pause</span><span class="string">" \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="string">-network-plugin-dir=/etc/cni/net.d \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="string">-network-plugin=cni \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="string">-logtostderr=true</span><br><span class="line"></span></span> Restart=always</span><br><span class="line"> RestartSec=10</span><br><span class="line"></span><br><span class="line"> [Install]</span><br><span class="line"> WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>kube-proxy.service</code></p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">Unit]</span><br><span class="line">Description</span>=Kubernetes Proxy</span><br><span class="line"><span class="constant">Documentation</span>=https:<span class="comment">//github.com/GoogleCloudPlatform/kubernetes</span></span><br><span class="line"><span class="constant">Requires</span>=kubelet.service</span><br><span class="line"><span class="constant">After</span>=kubelet.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="constant">ExecStart</span>=/opt/bin/kube-proxy \</span><br><span class="line">        --master=http:<span class="comment">//&lt;API_SERVER_IP&gt;:8080 \</span></span><br><span class="line">        --proxy-mode=iptables \</span><br><span class="line">        --logtostderr=<span class="literal">true</span></span><br><span class="line"><span class="constant">Restart</span>=always</span><br><span class="line"><span class="constant">RestartSec</span>=<span class="number">10</span></span><br><span class="line">[Install]</span><br><span class="line"><span class="constant">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p><api_server_ip>éƒ¨åˆ†æ›¿æ¢æˆmasterçš„ip</api_server_ip></p>
<h3 id="å°è¯•ç‰›åˆ€">å°è¯•ç‰›åˆ€</h3><p>å¯åŠ¨ä¸Šé¢çš„æ‰€ä»¥service kubernetesé›†ç¾¤åº”è¯¥å°±æ­å»ºèµ·æ¥äº†ã€‚æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹</p>
<p>æ–°å»ºä¸€ä¸ª<code>nginx.yaml</code></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: extensions/v1beta1</span><br><span class="line"><span class="attribute">kind</span>: Deployment</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: my-nginx</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">replicas</span>: <span class="number">2</span></span><br><span class="line">  <span class="attribute">template</span>:</span><br><span class="line">    <span class="attribute">metadata</span>:</span><br><span class="line">      <span class="attribute">labels</span>:</span><br><span class="line">        <span class="attribute">run</span>: my-nginx</span><br><span class="line">    <span class="attribute">spec</span>:</span><br><span class="line">      <span class="attribute">containers</span>:</span><br><span class="line">      - <span class="attribute">name</span>: my-nginx</span><br><span class="line">        <span class="attribute">image</span>: <span class="attribute">nginx</span>:alpine</span><br><span class="line">        <span class="attribute">ports</span>:</span><br><span class="line">        - <span class="attribute">containerPort</span>: <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; create -f ./nginx.yaml</span><br><span class="line"><span class="comment">// æŸ¥çœ‹podè¿è¡ŒçŠ¶å†µ</span></span><br><span class="line">&gt; kubectl get pods -l run=my-nginx -o wide</span><br><span class="line">NAME                        READY     STATUS    RESTARTS   AGE       NODE</span><br><span class="line">my-nginx-<span class="number">2643493705</span>-<span class="number">274</span>ab   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">1</span>m        <span class="number">192.168</span><span class="number">.64</span><span class="number">.9</span></span><br><span class="line">my-nginx-<span class="number">2643493705</span>-<span class="number">8</span>wr06   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">1</span>m        <span class="number">192.168</span><span class="number">.64</span><span class="number">.109</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯åŠ¨äº†ä¸¤ä¸ªnginxçš„pod</p>
<p>æŸ¥çœ‹æ¯ä¸ªpodçš„ip</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; kubectl get pods -l run=my-nginx -o yaml | grep podIP</span><br><span class="line">    podIP: <span class="number">10.100</span><span class="number">.73</span><span class="number">.2</span></span><br><span class="line">    podIP: <span class="number">10.100</span><span class="number">.63</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åœ¨å†…ä»»ä¸€å°æœºä¸Šæ‰§è¡Œ</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl <span class="string">http:</span><span class="comment">//10.100.73.2</span></span><br></pre></td></tr></table></figure>
<p>åº”è¯¥ä¼šçœ‹åˆ°nginxçš„æ¬¢è¿é¡µé¢æ‰“å°å‡ºæ¥ã€‚</p>
<hr>
<p>å‚è€ƒèµ„æ–™</p>
<p>[1]<a href="http://qiankunli.github.io/2015/01/29/Kubernetes_installation.html" target="_blank" rel="external">http://qiankunli.github.io/2015/01/29/Kubernetes_installation.html</a></p>
<p>[2]<a href="https://github.com/shenshouer/calico-kubernetes" target="_blank" rel="external">https://github.com/shenshouer/calico-kubernetes</a> </p>
<p>[3]<a href="http://qinghua.github.io/kubernetes-in-mesos-8/" target="_blank" rel="external">http://qinghua.github.io/kubernetes-in-mesos-8/</a> </p>
<p>[4]<a href="http://kubernetes.io/docs/user-guide/connecting-applications/" target="_blank" rel="external">http://kubernetes.io/docs/user-guide/connecting-applications/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/05/29/deploy-k8s-on-coreos/" data-id="ciygo85p0000a3x13cxun1y9f" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/05/29/deploy-k8s-on-coreos/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-coreos-osx-without-vagrant" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/29/coreos-osx-without-vagrant/" class="article-date">
  <time datetime="2016-05-29T03:35:27.000Z" itemprop="datePublished">2016-05-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/29/coreos-osx-without-vagrant/">OSXä¸Šæ‘†è„±vagrantæ­å»ºCoreOSé›†ç¾¤</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä¸€èˆ¬æˆ‘ä»¬åœ¨OSXä¸‹ä½¿ç”¨vagrantï¼‹virtualboxéƒ¨ç½²è™šæ‹Ÿæœºé›†ç¾¤åšå¼€å‘æµ‹è¯•ã€‚ç°åœ¨æˆ‘ä»¬è¿˜å¯ä»¥æœ‰æ›´è½»é‡çš„é€‰æ‹©â€”â€”<a href="https://github.com/xhyve-xyz/xhyve" target="_blank" rel="external">xhyve</a>ã€‚xhyveæ˜¯FreeBSD ä¸‹çš„è™šæ‹ŸæŠ€æœ¯ <a href="http://bhyve.org/" target="_blank" rel="external">bhyve</a> (The BSD Hypervisor) çš„OSXç§»æ¤ï¼Œåœ¨OS X 10.10.3 Yosemite ä¹‹åçš„ç‰ˆæœ¬ä¸­å¯ä»¥ä½¿ç”¨ã€‚ç”±äºxhyveæ˜¯åŸºäºFreeBSDåŸç”Ÿçš„è™šæ‹Ÿæ–¹æ¡ˆï¼Œæ‰€ä»¥å®ƒæ€§èƒ½å¥½å¹¶ä¸”éå¸¸çš„è½»é‡ï¼Œåªæœ‰ 230 KBï¼Œä¸ä¾èµ–å…¶ä»–è½¯ä»¶æˆ–åº“ã€‚å½“xhyveå‘å¸ƒæ—¶CoreOSå¿«é€Ÿçš„è·Ÿè¿›ï¼Œæ¨å‡ºäº†åŸºäºxhyveçš„<a href="https://github.com/coreos/coreos-xhyve" target="_blank" rel="external">coreos-xhyve</a>ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<a href="https://github.com/TheNewNormal/corectl" target="_blank" rel="external">corectl</a>â€”â€”ä¸€ä¸ªcoreos-xhyveçš„å‘½ä»¤è¡Œå·¥å…·æ¥æ­å»ºCoreOSé›†ç¾¤ã€‚</p>
<h2 id="å®‰è£…corectl">å®‰è£…corectl</h2><p>æœ€å¿«çš„æ–¹æ³•ä½¿ç”¨brew</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">brew </span>install corectl</span><br></pre></td></tr></table></figure>
<p>ä»æºç ç¼–è¯‘</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github<span class="class">.com</span>:TheNewNormal/corectl<span class="class">.git</span></span><br><span class="line">cd corectl</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>å®‰è£…å¥½åè¿è¡Œ<code>corectl -h</code>å¯ä»¥çœ‹åˆ°æ‰€æ”¯æŒçš„å‘½ä»¤</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">corectl -h</span><br><span class="line">CoreOS over OSX made simple.</span><br><span class="line">â¯â¯â¯ <span class="keyword">http</span>://github.com/TheNewNormal/corectl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  corectl [flags]</span><br><span class="line">  corectl [<span class="command"><span class="keyword">command</span>]</span></span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  rm          Removes <span class="constant">one</span> <span class="operator">or</span> more CoreOS images <span class="built_in">from</span> <span class="built_in">local</span> fs</span><br><span class="line">  <span class="built_in">kill</span>        Halts <span class="constant">one</span> <span class="operator">or</span> more running CoreOS instances</span><br><span class="line">  ls          Lists locally available CoreOS images</span><br><span class="line">  <span class="built_in">load</span>        Loads CoreOS instances defined <span class="operator">in</span> <span class="operator">an</span> instrumentation <span class="built_in">file</span>.</span><br><span class="line">  <span class="built_in">version</span>     Shows corectl <span class="built_in">version</span> information</span><br><span class="line">  ps          Lists running CoreOS instances</span><br><span class="line">  query       Display information about <span class="operator">the</span> running CoreOS instances</span><br><span class="line">  pull        Pulls <span class="operator">a</span> CoreOS image <span class="built_in">from</span> upstream</span><br><span class="line">  run         Starts <span class="operator">a</span> <span class="built_in">new</span> CoreOS instance</span><br><span class="line">  ssh         Attach <span class="built_in">to</span> <span class="operator">or</span> run commands inside <span class="operator">a</span> running CoreOS instance</span><br><span class="line">  <span class="built_in">put</span>         copy <span class="built_in">file</span> <span class="built_in">to</span> inside VM</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      <span class="comment">--debug   adds extra verbosity, and options, for debugging purposes and/or power users</span></span><br><span class="line"></span><br><span class="line">Use <span class="string">"corectl [command] --help"</span> <span class="keyword">for</span> more information about <span class="operator">a</span> <span class="command"><span class="keyword">command</span>.</span></span><br><span class="line"></span><br><span class="line">All flags can also be configured via <span class="built_in">upper</span>-<span class="keyword">case</span> environment variables prefixed <span class="operator">with</span> <span class="string">"COREOS_"</span></span><br><span class="line">For example, <span class="string">"--debug"</span> =&gt; <span class="string">"COREOS_DEBUG"</span></span><br></pre></td></tr></table></figure>
<h2 id="è¿è¡ŒCoreOS_VM">è¿è¡ŒCoreOS VM</h2><h3 id="åŠ è½½é•œåƒ">åŠ è½½é•œåƒ</h3><p>ç¬¬ä¸€æ¬¡è¾“å…¥<code>sudo corectl run</code>å³ä¼šè‡ªåŠ¨ä¸‹è½½æœ€æ–°çš„ CoreOS Alpha é•œåƒå¹¶åŠ è½½è¿è¡Œï¼Œé•œåƒæ–‡ä»¶æ”¾ç½®çš„ä½ç½®æ˜¯<code>$HOME/.coreos/</code></p>
<p>runçš„å‚æ•°è¿˜æœ‰</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line">  corectl run [flags]</span><br><span class="line"></span><br><span class="line">Aliases:</span><br><span class="line">  run, start</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      -<span class="ruby">-cdrom string          append an <span class="constant">CDROM</span> (.iso) to <span class="constant">VM</span></span><br><span class="line"></span>      -<span class="ruby">-channel string        <span class="constant">CoreOS</span> channel (default <span class="string">"alpha"</span>)</span><br><span class="line"></span>      -<span class="ruby">-cloud_config string   cloud-config file location (either a remote <span class="constant">URL</span> <span class="keyword">or</span> a local path)</span><br><span class="line"></span>      -<span class="ruby">-cpus int              <span class="constant">VM</span><span class="string">'s vCPUS (default 1)</span><br><span class="line"></span></span>  -<span class="ruby"><span class="string">d, --detached              starts the VM in detached (background) mode</span><br><span class="line"></span></span>  -<span class="ruby"><span class="string">h, --help                  help for run</span><br><span class="line"></span></span>  -<span class="ruby"><span class="string">l, --local latest          consumes whatever image is latest locally instead of looking online unless there'</span>s nothing available.</span><br><span class="line"></span>      -<span class="ruby">-memory int            <span class="constant">VM</span><span class="string">'s RAM, in MB, per instance (1024 &lt; memory &lt; 8192) (default 1024)</span><br><span class="line"></span></span>  -<span class="ruby"><span class="string">n, --name string           names the VM. (if absent defaults to VM'</span>s <span class="constant">UUID</span>)</span><br><span class="line"></span>      -<span class="ruby">-root string           append a (persistent) root volume to <span class="constant">VM</span></span><br><span class="line"></span>      -<span class="ruby">-sshkey string         <span class="constant">VM</span><span class="string">'s default ssh key</span><br><span class="line"></span></span>      -<span class="ruby"><span class="string">-tap string            append tap interface to VM</span><br><span class="line"></span></span>      -<span class="ruby"><span class="string">-uuid string           VM'</span>s <span class="constant">UUID</span> (default <span class="string">"random"</span>)</span><br><span class="line"></span>      -<span class="ruby">-version string        <span class="constant">CoreOS</span> version (default <span class="string">"latest"</span>)</span><br><span class="line"></span>      -<span class="ruby">-volume value          append disk volumes to <span class="constant">VM</span> (default [])</span><br><span class="line"></span></span><br><span class="line">Global Flags:</span><br><span class="line">      -<span class="ruby">-debug   adds extra verbosity, <span class="keyword">and</span> options, <span class="keyword">for</span> debugging purposes <span class="keyword">and</span>/<span class="keyword">or</span> power users</span><br><span class="line"></span></span><br><span class="line">All flags can also be configured via upper-case environment variables prefixed with "COREOS_"</span><br><span class="line">For example, "--debug" =&gt; "COREOS_DEBUG"</span><br></pre></td></tr></table></figure>
<p>æƒ³ä½¿ç”¨ä¸åŒçš„é•œåƒç‰ˆæœ¬å¯ä»¥ç”±<code>--channel alpha/beta/stable</code>æŒ‡å®š</p>
<h3 id="æ•°æ®æŒä¹…åŒ–">æ•°æ®æŒä¹…åŒ–</h3><p>å…ˆæ–°å»ºä¸€ä¸ª5Gçš„persistent.imgç›˜</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">dd</span> <span class="keyword">if</span>=/dev/zero of= persistent<span class="class">.img</span>  bs=<span class="number">1</span>g count=<span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>æ ¼å¼åŒ–æˆext4(éœ€è¦e2fsprogså·¥å…·ï¼Œå®‰è£…<code>brew install e2fsprogs</code>)</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/Cellar/</span>e2fsprogs<span class="regexp">/1.42.12/</span>sbin<span class="regexp">/mke2fs  -t ext4 -m0 -F persistent.img</span></span><br></pre></td></tr></table></figure>
<p>è¿è¡Œæ—¶åŠ ä¸Š</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">corectl <span class="command">run</span> <span class="comment">--name core --volume absolute_or_relative_path/to/persistent.img</span></span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨åpersistent.imgè¢«æŒ‚è½½åœ¨/dev/vda</p>
<p>sshè¿›å…¥VMå°†/dev/vda æŒ‚è½½ åœ¨ /dataä¸Š</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">corectl</span> ssh core</span><br><span class="line"><span class="title">mkdir</span> /<span class="typedef"><span class="keyword">data</span></span></span><br><span class="line"><span class="title">sudo</span> mount /dev/vda /<span class="typedef"><span class="keyword">data</span></span></span><br></pre></td></tr></table></figure>
<p>åé¢æ•°æ®å°±å¯ä»¥å†™å…¥/data</p>
<h3 id="å¯åŠ¨é›†ç¾¤">å¯åŠ¨é›†ç¾¤</h3><p>ä»<a href="https://discovery.etcd.io" target="_blank" rel="external">https://discovery.etcd.io</a> è·å–token</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">curl</span> -X GET <span class="string">'https://discovery.etcd.io/new?size=3'</span></span><br></pre></td></tr></table></figure>
<p>å°†tokenå†™å…¥loud-configæ–‡ä»¶</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"></span><br><span class="line">coreos:</span><br><span class="line">  etcd2:</span><br><span class="line"><span class="comment">    # generate a new token for each unique cluster</span></span><br><span class="line"><span class="comment">    # from https://discovery.etcd.io/new?size=n where n = cluster size</span></span><br><span class="line"><span class="comment">    # discovery url to bootstrap the cluster</span></span><br><span class="line">    discovery: hhttps://discovery.etcd.io/&#123;<span class="variable">$TOKEN&#125;</span></span><br><span class="line"><span class="comment">    # multi-region and multi-cloud deployments need to use $public_ipv4</span></span><br><span class="line"><span class="comment">    # list of memberâ€™s client urls to advertise information to the rest of the cluster</span></span><br><span class="line">    advertise-client-urls: <span class="keyword">http</span>://<span class="variable">$public_ipv4</span>:<span class="number">2379</span></span><br><span class="line"><span class="comment">    # this address is used to communicate etcd data around the cluster</span></span><br><span class="line">    initial-advertise-peer-urls: <span class="keyword">http</span>://<span class="variable">$private_ipv4</span>:<span class="number">2380</span></span><br><span class="line"><span class="comment">    # listen on both the official ports and the legacy ports</span></span><br><span class="line"><span class="comment">    # legacy ports can be omitted if your application doesn't depend on them</span></span><br><span class="line"><span class="comment">    # url to listen for client traffic</span></span><br><span class="line">    listen-client-urls: <span class="keyword">http</span>://<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">2379</span>,<span class="keyword">http</span>://<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">4001</span></span><br><span class="line"><span class="comment">    # url to listen for peer traffic</span></span><br><span class="line">    listen-peer-urls: <span class="keyword">http</span>://<span class="variable">$private_ipv4</span>:<span class="number">2380</span>,<span class="keyword">http</span>://<span class="variable">$private_ipv4</span>:<span class="number">7001</span></span><br><span class="line">  fleet:</span><br><span class="line">    public-ip: <span class="variable">$public_ipv4</span></span><br><span class="line">  flannel:</span><br><span class="line">    interface: <span class="variable">$public_ipv4</span></span><br><span class="line">  units:</span><br><span class="line">    - name: etcd2.service</span><br><span class="line">      command: start</span><br><span class="line">    - name: fleet.service</span><br><span class="line">      command: start</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨ä¸‰ä¸ªCoreVM</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo corectl <span class="command">run</span> <span class="comment">--cloud_config ./cloud-config-file --name core-1</span></span><br><span class="line">sudo corectl <span class="command">run</span> <span class="comment">--cloud_config ./cloud-config-file --name core-2</span></span><br><span class="line">sudo corectl <span class="command">run</span> <span class="comment">--cloud_config ./cloud-config-file --name core-3</span></span><br></pre></td></tr></table></figure>
<p>éšä¾¿sshè¿›ä¸€ä¸ªVMä½¿ç”¨<code>etcdctl  member list</code>çœ‹åˆ°é›†ç¾¤å·²ç»å»ºç«‹</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etcdctl  member list</span><br><span class="line">28fede81eb6ee920: name=<span class="number">78c956f8</span>b901497fbd<span class="number">909c0a4</span>fa4a9f7 peerURLs=http://<span class="number">192.168.64.30</span>:2380 clientURLs=http://<span class="number">192.168.64.30</span>:2379 isLeader=false</span><br><span class="line">a4661fcb2e28c76a: name=1a7f48cd<span class="number">84c540528</span>b<span class="number">0a61483f07</span>1307 peerURLs=http://<span class="number">192.168.64.31</span>:2380 clientURLs=http://<span class="number">192.168.64.31</span>:2379 isLeader=false</span><br><span class="line">eebd<span class="number">0c9e16e3</span>e5be: name=fd92329bf3004bf<span class="number">98f3a65536</span>06a00b0 peerURLs=http://<span class="number">192.168.64.32</span>:2380 clientURLs=http://<span class="number">192.168.64.32</span>:2379 isLeader=true</span><br></pre></td></tr></table></figure>
<p>æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒè¿™ä¸ªé¡¹ç›®<a href="https://github.com/TheNewNormal/coreos-osx" target="_blank" rel="external">coreos-osx</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/05/29/coreos-osx-without-vagrant/" data-id="ciygo85p2000b3x13l3cz6y17" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/05/29/coreos-osx-without-vagrant/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-tornado-source-code-3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/25/tornado-source-code-3/" class="article-date">
  <time datetime="2016-01-24T16:19:32.000Z" itemprop="datePublished">2016-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/25/tornado-source-code-3/">tornadoæºç åˆ†æç¬”è®°(3)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä»Šå¤©æˆ‘ä»¬æ¥è®²è®²tornadoçš„<code>Future</code>å’Œcoroutineã€‚</p>
<h2 id="Future">Future</h2><p>é¦–å…ˆä»€ä¹ˆæ˜¯<code>future</code>ï¼ŸæŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œ<code>Future</code>æ˜¯ä¸€ä¸ªç”¨æ¥ä¿å­˜å¼‚æ­¥å¤„ç†çš„ç»“æœå’Œå›è°ƒçš„ä¸€ä¸ªç±»ã€‚tornadoçš„<code>Future</code>å…¶å®æ˜¯å®ç°äº†è·Ÿpython <a href="https://docs.python.org/3/library/concurrent.futures.html" target="_blank" rel="external">concurrent</a>è¿™ä¸ªåŒ…ä¸€æ ·çš„apiã€‚åœ¨<code>concurrent</code>è¿™ä¸ªåŒ…é‡Œé¢æ˜¯è¿™æ ·ç”¨<code>Future</code>çš„</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import concurrent<span class="class">.futures</span></span><br><span class="line"></span><br><span class="line">def <span class="function"><span class="title">done_callback</span><span class="params">(future)</span></span>:</span><br><span class="line">    <span class="function"><span class="title">print</span><span class="params">(<span class="string">"I am done"</span>)</span></span></span><br><span class="line">    <span class="function"><span class="title">print</span><span class="params">(future.result()</span></span>)</span><br><span class="line"></span><br><span class="line">with concurrent<span class="class">.futures</span><span class="class">.ThreadPoolExecutor</span>(max_workers=<span class="number">1</span>) as executor:</span><br><span class="line">    future = executor.<span class="function"><span class="title">submit</span><span class="params">(pow, <span class="number">323</span>, <span class="number">1235</span>)</span></span></span><br><span class="line">    future.<span class="function"><span class="title">add_done_callback</span><span class="params">(done_callback)</span></span></span><br><span class="line">    <span class="function"><span class="title">print</span><span class="params">(future.done()</span></span>)</span><br></pre></td></tr></table></figure>
<p><code>ThreadPoolExecutor</code>åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ<code>pow</code>ï¼Œä¸ç­‰å‡½æ•°æ‰§è¡Œå®Œå°±ç«‹å³è¿”å›ä¸€ä¸ª<code>future</code>ä½œä¸ºä¸€ä¸ªæ¡¥æ¢ï¼Œæ‹¿åˆ°è¿™ä¸ª<code>future</code>åç¨‹åºå°±å¯ä»¥å»åšå…¶ä»–äº‹æƒ…äº†ï¼Œå½“<code>pow</code>æ‰§è¡Œå®Œä¹‹åå›è°ƒç”¨<code>done_callback</code>ã€‚è€Œä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥é€šè¿‡<code>future</code>æ¥è·å–è¿è¡Œæƒ…å†µæˆ–è€…è¿›è¡Œå–æ¶ˆç­‰æ“ä½œã€‚</p>
<p><code>Future</code>çš„æºç åœ¨concurrent.pyé‡Œé¢ï¼Œå¾ˆç®€å•ï¼Œè¿™é‡Œä¹Ÿå°±ä¸è´´å‡ºæ¥äº†ã€‚åœ¨tornadoä¸­ï¼Œ<code>Future</code>çš„ä½¿ç”¨æ˜¯é€šè¿‡<code>IOLoop</code>çš„<code>add_future</code>æ–¹æ³•èµ·ä½œç”¨çš„ã€‚</p>
<p>ioloop.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_future</span><span class="params">(self, future, callback)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> is_future(future)</span><br><span class="line">    callback = stack_context.wrap(callback)</span><br><span class="line">    future.add_done_callback(</span><br><span class="line">        <span class="keyword">lambda</span> future: self.add_callback(callback, future))</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>add_future</code>ä¸º<code>future</code>æ·»åŠ äº†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“<code>future</code>å®Œæˆçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†<code>future.set_result</code>æˆ–<code>future.set_exception</code>åå‘<code>IOLoop</code>æ³¨å†Œäº†<code>callback</code>å‡½æ•°ï¼Œå½“<code>IOLoop</code>ä¸‹ä¸€è½®pollä¹‹å‰å°±ä¼šè°ƒç”¨è¿™ä¸ª<code>callback</code>å‡½æ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼Œè€—æ—¶ä»»åŠ¡ä½¿ç”¨å¦å¤–çš„çº¿ç¨‹å®Œæˆã€‚</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import <span class="tag">time</span></span><br><span class="line">import threading</span><br><span class="line">import tornado<span class="class">.ioloop</span></span><br><span class="line">from tornado<span class="class">.concurrent</span> import Future</span><br><span class="line"></span><br><span class="line">ioloop = tornado<span class="class">.ioloop</span><span class="class">.IOLoop</span><span class="class">.current</span>()</span><br><span class="line"></span><br><span class="line">def <span class="function"><span class="title">long_task</span><span class="params">(future, sec=<span class="number">5</span>)</span></span>:</span><br><span class="line">    <span class="function"><span class="title">print</span><span class="params">(<span class="string">"long task start"</span>)</span></span></span><br><span class="line">    <span class="tag">time</span>.<span class="function"><span class="title">sleep</span><span class="params">(sec)</span></span></span><br><span class="line">    future.<span class="function"><span class="title">set_result</span><span class="params">(<span class="string">"long task done in %s sec"</span> % sec)</span></span></span><br><span class="line"></span><br><span class="line">def <span class="function"><span class="title">after_task_done</span><span class="params">(future)</span></span>:</span><br><span class="line">    <span class="function"><span class="title">print</span><span class="params">(future.result()</span></span>)</span><br><span class="line"></span><br><span class="line">def <span class="function"><span class="title">test_future</span><span class="params">()</span></span>:</span><br><span class="line">    future = <span class="function"><span class="title">Future</span><span class="params">()</span></span></span><br><span class="line">    threading.<span class="function"><span class="title">Thread</span><span class="params">(target=long_task, args=(future,)</span></span>).<span class="function"><span class="title">start</span><span class="params">()</span></span></span><br><span class="line">    ioloop.<span class="function"><span class="title">add_future</span><span class="params">(future, after_task_done)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    ioloop.<span class="function"><span class="title">add_callback</span><span class="params">(test_future)</span></span></span><br><span class="line">    ioloop.<span class="function"><span class="title">start</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<h2 id="coroutine">coroutine</h2><p>å¼‚æ­¥çš„äº‹ä»¶é©±åŠ¨æœ€ä»¤äººè¯Ÿç—…çš„ä¸€ç‚¹å°±æ˜¯ä¸åœçš„å›è°ƒå›è°ƒï¼Œç»™å†™ç¨‹åºçš„æ—¶å€™å¸¦æ¥å¾ˆå¤§çš„å›°éš¾ã€‚é’ˆå¯¹è¿™ä¸ªç—›ç‚¹ï¼Œtornadoåˆ©ç”¨äº†åŸºäºpythonçš„ç”Ÿæˆå™¨çš„åç¨‹æ¥å®ç°ç”¨åŒæ­¥çš„æ–¹å¼å†™å¼‚æ­¥çš„ä»£ç çš„ã€‚å°±è®©æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹å…¶èƒŒåçš„é»‘é­”æ³•å§ã€‚</p>
<p>å…ˆä»demoå¼€å§‹ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class <span class="function"><span class="title">GenAsyncHandler</span><span class="params">(RequestHandler)</span></span>:</span><br><span class="line">    @gen<span class="class">.coroutine</span></span><br><span class="line">    def <span class="function"><span class="title">get</span><span class="params">(self)</span></span>:</span><br><span class="line">        http_client = <span class="function"><span class="title">AsyncHTTPClient</span><span class="params">()</span></span></span><br><span class="line">        response = yield http_client.<span class="function"><span class="title">fetch</span><span class="params">(<span class="string">"http://example.com"</span>)</span></span></span><br><span class="line">        <span class="function"><span class="title">do_something_with_response</span><span class="params">(response)</span></span></span><br><span class="line">        self.<span class="function"><span class="title">render</span><span class="params">(<span class="string">"template.html"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p><code>get</code>æ–¹æ³•åœ¨<code>gen.coroutine</code>è£…é¥°å™¨çš„ä¸‹åœ¨æ‰§è¡Œå¼‚æ­¥æ–¹æ³•æ—¶yieldå°±å¯ä»¥å¯ä»¥å°†æ§åˆ¶æƒè¿˜ç»™IOLoopï¼Œå½“å¼‚æ­¥æ–¹æ³•å›è·å¾—ç»“æœæ—¶è¿”å›<code>get</code>æ–¹æ³•ï¼Œå°†ç»“æœèµ‹å€¼ç»™<code>response</code>åç»§ç»­æ‰§è¡Œã€‚æˆ‘ä»¬çŸ¥é“åœ¨ä¸€ä¸ªå‡½æ•°ä¸­æœ‰yieldçš„è¯è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼å°±å˜æˆäº†ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå½“å¼‚æ­¥å‡½æ•°çš„ç»“æœåˆ°æ¥æ—¶ï¼Œå¿…å®šä¼šè°ƒç”¨ç”Ÿæˆå™¨çš„<code>send</code>æ–¹æ³•å°†ç»“æœä¼ å…¥é‡Œé¢ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹<code>gen.coroutine</code>ã€‚</p>
<p>gen.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coroutine</span><span class="params">(func, replace_callback=True)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> _make_coroutine_wrapper(func, replace_callback=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>å¾ˆç®€å•ï¼Œè¿”å›ä¸€ä¸ª<code>_make_coroutine_wrapper</code>åŒ…è£…çš„å‡½æ•°ã€‚æ¥çœ‹<code>_make_coroutine_wrapper</code>ï¼š</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">def _make_coroutine_wrapper(func, replace_callback):</span><br><span class="line">    @functools.wraps(func)</span><br><span class="line">    def wrapper(*args, **kwargs):</span><br><span class="line">        future = <span class="type">TracebackFuture</span>()</span><br><span class="line"></span><br><span class="line">		<span class="comment"># æœ‰callbackå…³é”®è¯çš„è¯ä¸ºcallbackæ·»åŠ ä¸€ä¸ªfutureï¼Œfutureå®Œæˆæ—¶æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> replace_callback <span class="keyword">and</span> 'callback' <span class="keyword">in</span> kwargs:</span><br><span class="line">            callback = kwargs.pop('callback')</span><br><span class="line">            <span class="type">IOLoop</span>.current().add_future(</span><br><span class="line">                future, lambda future: callback(future.<span class="literal">result</span>()))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è°ƒç”¨funcï¼Œæ ¹æ®ç»“æœçš„ä¸åŒè¿›è¡Œä¸åŒçš„å¤„ç†</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="literal">result</span> = func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">except</span> (<span class="type">Return</span>, <span class="type">StopIteration</span>) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="literal">result</span> = getattr(e, 'value', <span class="type">None</span>)</span><br><span class="line">        <span class="keyword">except</span> <span class="type">Exception</span>:</span><br><span class="line">            future.set_exc_info(sys.exc_info())</span><br><span class="line">            <span class="keyword">return</span> future</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> isinstance(<span class="literal">result</span>, types.<span class="type">GeneratorType</span>):</span><br><span class="line">                <span class="comment"># Inline the first iteration of Runner.run.  This lets us</span></span><br><span class="line">                <span class="comment"># avoid the cost of creating a Runner when the coroutine</span></span><br><span class="line">                <span class="comment"># never actually yields, which in turn allows us to</span></span><br><span class="line">                <span class="comment"># use "optional" coroutines in critical path code without</span></span><br><span class="line">                <span class="comment"># performance penalty for the synchronous case.</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    orig_stack_contexts = stack_context._state.contexts</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># è‹¥resultæ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œåˆ™ä¼šè°ƒç”¨ä¸€æ¬¡nextï¼Œåœ¨æ ¹æ®ç»“æœè¿›è¡Œä¸åŒå¤„ç†</span></span><br><span class="line">                    yielded = next(<span class="literal">result</span>)</span><br><span class="line">                    <span class="keyword">if</span> stack_context._state.contexts <span class="keyword">is</span> <span class="keyword">not</span> orig_stack_contexts:</span><br><span class="line">                        yielded = <span class="type">TracebackFuture</span>()</span><br><span class="line">                        yielded.set_exception(</span><br><span class="line">                            stack_context.<span class="type">StackContextInconsistentError</span>(</span><br><span class="line">                                'stack_context inconsistency (probably caused '</span><br><span class="line">                                'by <span class="keyword">yield</span> within a <span class="string">"with StackContext"</span> <span class="keyword">block</span>)'))</span><br><span class="line">                <span class="keyword">except</span> (<span class="type">StopIteration</span>, <span class="type">Return</span>) <span class="keyword">as</span> e:</span><br><span class="line">                    future.set_result(getattr(e, 'value', <span class="type">None</span>))</span><br><span class="line">                <span class="keyword">except</span> <span class="type">Exception</span>:</span><br><span class="line">                    future.set_exc_info(sys.exc_info())</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="type">Runner</span>(<span class="literal">result</span>, future, yielded)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">return</span> future</span><br><span class="line">                <span class="keyword">finally</span>:</span><br><span class="line">                    <span class="comment"># Subtle memory optimization: if next() raised an exception,</span></span><br><span class="line">                    <span class="comment"># the future's exc_info contains a traceback which</span></span><br><span class="line">                    <span class="comment"># includes this stack frame.  This creates a cycle,</span></span><br><span class="line">                    <span class="comment"># which will be collected at the next full GC but has</span></span><br><span class="line">                    <span class="comment"># been shown to greatly increase memory usage of</span></span><br><span class="line">                    <span class="comment"># benchmarks (relative to the refcount-based scheme</span></span><br><span class="line">                    <span class="comment"># used in the absence of cycles).  We can avoid the</span></span><br><span class="line">                    <span class="comment"># cycle by clearing the local variable after we return it.</span></span><br><span class="line">                    future = <span class="type">None</span></span><br><span class="line">        future.set_result(<span class="literal">result</span>)</span><br><span class="line">        <span class="keyword">return</span> future</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure>
<p>è¢«<code>gen.coroutine</code>è£…é¥°çš„å‡½æ•°è¿”å›ç»“æœéƒ½ä¼šå˜æˆä¸€ä¸ª<code>Future</code>,è‹¥<code>func</code>ä¸æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œåˆ™å°†ç»“æœæˆ–å¼‚å¸¸æ”¾å…¥<code>future</code>ä¸­è¿”å›ã€‚è‹¥<code>func</code>è¿”å›ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œè°ƒç”¨<code>next</code>ä¸€æ¬¡ï¼Œå¦‚æœè¿˜æœ‰åç»­ï¼Œåˆ™äº¤ç»™<code>Runner</code>è¿™ä¸ªç±»æ¥æ‰§è¡Œã€‚ç»“åˆdemoä¸Šçš„æ¥çœ‹ï¼Œæ­¤æ—¶çš„<code>yielded</code>æ˜¯<code>http_client.fetch(&quot;http://example.com&quot;)</code>æ‰§è¡Œéƒ½ç»“æœï¼Œå¿…é¡»æ˜¯ä¸€ä¸ª<code>Future</code>(æˆ–è€…<code>YieldPoint</code>ï¼Œæ—©æœŸç‰ˆæœ¬ä½¿ç”¨çš„ï¼Œåæ¥ç”±<code>Future</code>ä»£æ›¿ï¼Œä¿ç•™åªä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬ï¼Œè¿™é‡Œä¸å†è®¨è®º)ï¼Œåé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ã€‚</p>
<p>æ¥çœ‹<code>Runner</code>ç±»ï¼Œ ä¹Ÿåœ¨gen.pyé‡Œé¢ï¼Œåœ¨<code>Runner</code>é‡Œé¢æœ€å…³é”®çš„æ˜¯<code>run</code>å’Œ<code>handle_yield</code>æ–¹æ³•ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Runner</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, gen, result_future, first_yielded)</span>:</span></span><br><span class="line">        self.gen = gen</span><br><span class="line">        self.result_future = result_future</span><br><span class="line">        self.future = _null_future</span><br><span class="line">        self.yield_point = <span class="keyword">None</span></span><br><span class="line">        self.pending_callbacks = <span class="keyword">None</span></span><br><span class="line">        self.results = <span class="keyword">None</span></span><br><span class="line">        self.running = <span class="keyword">False</span></span><br><span class="line">        self.finished = <span class="keyword">False</span></span><br><span class="line">        self.had_exception = <span class="keyword">False</span></span><br><span class="line">        self.io_loop = IOLoop.current()</span><br><span class="line"></span><br><span class="line">        self.stack_context_deactivate = <span class="keyword">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è‹¥first_yieldedçš„futureä»¥å®Œæˆï¼Œåˆ™æœ€å°‘ä¼šrunä¸€æ¬¡</span></span><br><span class="line">        <span class="keyword">if</span> self.handle_yield(first_yielded):</span><br><span class="line">            self.run()</span><br><span class="line">            </span><br><span class="line">    <span class="comment"># ...çœç•¥...</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_yield</span><span class="params">(self, yielded)</span>:</span></span><br><span class="line">        <span class="comment"># Lists containing YieldPoints require stack contexts;</span></span><br><span class="line">        <span class="comment"># other lists are handled via multi_future in convert_yielded.</span></span><br><span class="line">        <span class="keyword">if</span> (isinstance(yielded, list) <span class="keyword">and</span></span><br><span class="line">                any(isinstance(f, YieldPoint) <span class="keyword">for</span> f <span class="keyword">in</span> yielded)):</span><br><span class="line">            yielded = Multi(yielded)</span><br><span class="line">        <span class="keyword">elif</span> (isinstance(yielded, dict) <span class="keyword">and</span></span><br><span class="line">              any(isinstance(f, YieldPoint) <span class="keyword">for</span> f <span class="keyword">in</span> yielded.values())):</span><br><span class="line">            yielded = Multi(yielded)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¤„ç†æ—§ç‰ˆæœ¬çš„YieldPointsçš„å…¼å®¹ï¼Œå¯ä»¥å¿½ç•¥...</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment"># futureæœªå®Œæˆåˆ™å‘ioloopæ³¨å†Œè¿™ä¸ªfutureï¼Œå½“futureå®Œæˆæ—¶è°ƒç”¨runç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.future.done() <span class="keyword">or</span> self.future <span class="keyword">is</span> moment:</span><br><span class="line">            self.io_loop.add_future(</span><br><span class="line">                self.future, <span class="keyword">lambda</span> f: self.run())</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Starts or resumes the generator, running until it reaches a</span><br><span class="line">        yield point that is not ready.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">if</span> self.running <span class="keyword">or</span> self.finished:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.running = <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">                future = self.future</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> future.done():</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                self.future = <span class="keyword">None</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    orig_stack_contexts = stack_context._state.contexts</span><br><span class="line">                    exc_info = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        value = future.result()</span><br><span class="line">                    <span class="keyword">except</span> Exception:</span><br><span class="line">                        self.had_exception = <span class="keyword">True</span></span><br><span class="line">                        exc_info = sys.exc_info()</span><br><span class="line">					</span><br><span class="line">					<span class="comment"># æœ‰å¼‚å¸¸åˆ™è®¾ç½®å¼‚å¸¸</span></span><br><span class="line">                    <span class="keyword">if</span> exc_info <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                        yielded = self.gen.throw(*exc_info)</span><br><span class="line">                        exc_info = <span class="keyword">None</span></span><br><span class="line">                   	<span class="comment"># å°†ç»“æœsendå›å»ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        yielded = self.gen.send(value)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> stack_context._state.contexts <span class="keyword">is</span> <span class="keyword">not</span> orig_stack_contexts:</span><br><span class="line">                        self.gen.throw(</span><br><span class="line">                            stack_context.StackContextInconsistentError(</span><br><span class="line">                                <span class="string">'stack_context inconsistency (probably caused '</span></span><br><span class="line">                                <span class="string">'by yield within a "with StackContext" block)'</span>))</span><br><span class="line">                <span class="keyword">except</span> (StopIteration, Return) <span class="keyword">as</span> e:</span><br><span class="line">                    self.finished = <span class="keyword">True</span></span><br><span class="line">                    self.future = _null_future</span><br><span class="line">                    <span class="keyword">if</span> self.pending_callbacks <span class="keyword">and</span> <span class="keyword">not</span> self.had_exception:</span><br><span class="line">                        <span class="comment"># If we ran cleanly without waiting on all callbacks</span></span><br><span class="line">                        <span class="comment"># raise an error (really more of a warning).  If we</span></span><br><span class="line">                        <span class="comment"># had an exception then some callbacks may have been</span></span><br><span class="line">                        <span class="comment"># orphaned, so skip the check in that case.</span></span><br><span class="line">                        <span class="keyword">raise</span> LeakedCallbackError(</span><br><span class="line">                            <span class="string">"finished without waiting for callbacks %r"</span> %</span><br><span class="line">                            self.pending_callbacks)</span><br><span class="line">                    self.result_future.set_result(getattr(e, <span class="string">'value'</span>, <span class="keyword">None</span>))</span><br><span class="line">                    self.result_future = <span class="keyword">None</span></span><br><span class="line">                    self._deactivate_stack_context()</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                <span class="keyword">except</span> Exception:</span><br><span class="line">                    self.finished = <span class="keyword">True</span></span><br><span class="line">                    self.future = _null_future</span><br><span class="line">                    self.result_future.set_exc_info(sys.exc_info())</span><br><span class="line">                    self.result_future = <span class="keyword">None</span></span><br><span class="line">                    self._deactivate_stack_context()</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                <span class="comment"># handle_yieldæ£€æŸ¥yieldedï¼Œè‹¥è¿˜æœªå®Œæˆåˆ™ç»§ç»­å‘IOLoopæ³¨å†Œfutureç­‰å¾…å®Œæˆã€‚</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> self.handle_yield(yielded):</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.running = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">		<span class="comment"># .......</span></span><br></pre></td></tr></table></figure>
<p>åœ¨<code>Runner</code>ä¸­<code>handle_yield</code>å¸®æˆ‘ä»¬å‘IOLoopæ³¨å†Œäº†<code>future</code>,å½“<code>future</code>å®Œæˆæ—¶ä¹Ÿå°±æ˜¯<code>http_client.fetch</code>çš„ç»“æœè¿”å›ä¹‹åï¼ŒIOLoopå°±å¥½æ‰§è¡Œ<code>Runner.run()</code>ä½¿æˆ‘ä»¬ä»æ–­ç‚¹ç»§ç»­æ‰§è¡Œã€‚åœ¨<code>Runner.run()</code>é‡Œå°†<code>future</code>çš„ç»“æœå–å‡ºï¼Œå‘é€è¿›ç”Ÿæˆå™¨é‡Œé¢ç»§ç»­æ‰§è¡Œã€‚</p>
<p>å½“æˆ‘ä»¬è¦å®ç°è‡ªå·±çš„å¼‚æ­¥å‡½æ•°æ—¶ï¼Œéœ€è¦å°†è€—æ—¶ä»»åŠ¡çš„æ‰§è¡Œæ”¾åœ¨ä¸»çº¿ç¨‹å¤–çš„å…¶å®ƒåœ°æ–¹ï¼Œè¿”å›ä¸€ä¸ª<code>Future</code>å¯¹è±¡ï¼Œå½“è€—æ—¶ä»»åŠ¡ç»“æŸæ—¶è®¾åœ¨<code>Future</code>çš„ç»“æœå³å¯ã€‚é…åˆ<code>gen.coroutine</code>å³å¯å®ç°åŒæ­¥çš„æ§åˆ¶æµå†™å¼‚æ­¥çš„ä»£ç ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> tornado.httpserver</span><br><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.options</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen</span><br><span class="line"><span class="keyword">from</span> tornado.concurrent <span class="keyword">import</span> Future</span><br><span class="line"><span class="keyword">from</span> tornado.options <span class="keyword">import</span> define, options</span><br><span class="line"></span><br><span class="line">define(<span class="string">"port"</span>, default=<span class="number">8888</span>, help=<span class="string">"run on the given port"</span>, type=int)</span><br><span class="line"></span><br><span class="line"><span class="decorator">@gen.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logic_handler</span><span class="params">(pk)</span>:</span></span><br><span class="line">    data = <span class="keyword">yield</span> get_data(pk)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åœ¨python3é‡Œå¯ä»¥åœ¨ç”Ÿæˆå™¨ç›´æ¥return data</span></span><br><span class="line">    <span class="keyword">raise</span> gen.Return(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(pk)</span>:</span></span><br><span class="line">    future = Future()</span><br><span class="line">    threading.Thread(target=fetch_data_from_db, args=(future, pk)).start()</span><br><span class="line">    <span class="keyword">return</span> future</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch_data_from_db</span><span class="params">(future, pk)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    future.set_result(&#123;<span class="string">"pk"</span>: pk, <span class="string">"data"</span>: <span class="string">"Data from No.%s's"</span> % pk&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line"><span class="decorator">    @gen.coroutine</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, pk)</span>:</span></span><br><span class="line">        print(pk)</span><br><span class="line">        result = <span class="keyword">yield</span> loginc_handler(pk)</span><br><span class="line">        self.write(json.dumps(result))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    tornado.options.parse_command_line()</span><br><span class="line">    application = tornado.web.Application([</span><br><span class="line">        (<span class="string">r"/(\d+)"</span>, MainHandler),</span><br><span class="line">    ])</span><br><span class="line">    http_server = tornado.httpserver.HTTPServer(application)</span><br><span class="line">    http_server.listen(options.port)</span><br><span class="line">    tornado.ioloop.IOLoop.current().start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>ä¸è¿‡åœ¨å®é™…åº”ç”¨ä¸­è¿˜æ˜¯ä¼šæœ‰äº›åœ°æ–¹éœ€è¦æ³¨æ„ã€‚å¦‚å½“ä¸€ä¸ªå‡½æ•°ä½¿ç”¨<code>gen.coroutine</code>è£…é¥°è¿‡åï¼Œå…¶ä¸Šå±‚çš„è°ƒç”¨è€…ä¹Ÿè¦ç›¸åº”æ”¹æˆcouroutineï¼Œå¦‚ä¸Šé¢ä¾‹å­çš„<code>logic_handler</code>å¦‚æœè¿˜æœ‰å¾ˆå¤šå±‚çº§ä¾èµ–äºdbçš„æ•°æ®çš„è¯ï¼Œå®ƒä»¬ä¹Ÿè¦åŠ <code>@gen.coroutine</code>æˆ–è€…è¿”å›<code>Future</code>ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/01/25/tornado-source-code-3/" data-id="ciygo85of00013x13obqfhxc9" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/01/25/tornado-source-code-3/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-tornado-source-code-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/19/tornado-source-code-2/" class="article-date">
  <time datetime="2016-01-19T13:01:28.000Z" itemprop="datePublished">2016-01-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/19/tornado-source-code-2/">tornadoæºç åˆ†æç¬”è®°(2)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>IOLoop</code>å°±æ˜¯ tornado çš„äº‹ä»¶å¾ªç¯ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€çš„å•ä¾‹ï¼Œé€šè¿‡<code>IOLoop.current()</code>æˆ–<code>IOLoop.instance()</code>è®¿é—®ã€‚<code>IOLoop.current()</code>å†…éƒ¨è°ƒç”¨çš„ä¹Ÿæ˜¯<code>instance()</code>æ–¹æ³•ã€‚æ‰€ä»¥æˆ‘ä»¬æ¥çœ‹<code>instance()</code>:</p>
<pre><code><span class="class"><span class="keyword">class</span> <span class="title">IOLoop</span><span class="params">(Configurable)</span>:</span>

    ...

    <span class="comment"># Global lock for creating global IOLoop instance</span>
        _instance_lock = threading.Lock()

        _current = threading.local()

<span class="decorator">        @staticmethod</span>
        <span class="function"><span class="keyword">def</span> <span class="title">instance</span><span class="params">()</span>:</span>
            <span class="keyword">if</span> <span class="keyword">not</span> hasattr(IOLoop, <span class="string">"_instance"</span>):
                <span class="keyword">with</span> IOLoop._instance_lock:
                    <span class="keyword">if</span> <span class="keyword">not</span> hasattr(IOLoop, <span class="string">"_instance"</span>):
                        <span class="comment"># New instance after double check</span>
                        IOLoop._instance = IOLoop()
            <span class="keyword">return</span> IOLoop._instance
</code></pre><p><code>IOLoop</code>æ²¡æœ‰<code>__init__()</code>å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å»çœ‹å®ƒçš„çˆ¶ç±»<code>Configurable</code>:</p>
<pre><code><span class="class"><span class="keyword">class</span> <span class="title">Configurable</span><span class="params">(object)</span>:</span>

    __impl_class = <span class="keyword">None</span>
    __impl_kwargs = <span class="keyword">None</span>

    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span>
        base = cls.configurable_base()
        init_kwargs = {}
        <span class="keyword">if</span> cls <span class="keyword">is</span> base:
            impl = cls.configured_class()
            <span class="keyword">if</span> base.__impl_kwargs:
                init_kwargs.update(base.__impl_kwargs)
        <span class="keyword">else</span>:
            impl = cls
        init_kwargs.update(kwargs)
        instance = super(Configurable, cls).__new__(impl)

        instance.initialize(*args, **init_kwargs)
        <span class="keyword">return</span> instance            
</code></pre><p><code>IOLoop.confirable_base()</code>è¿”å›çš„å°±æ˜¯<code>IOLoop</code>è‡ªèº«ï¼Œæ‰€ä»¥è¿›å…¥<code>configured_class()</code></p>
<pre><code><span class="decorator">@classmethod</span>
<span class="function"><span class="keyword">def</span> <span class="title">configured_class</span><span class="params">(cls)</span>:</span>
    <span class="string">"""Returns the currently configured class."""</span>
    base = cls.configurable_base()
    <span class="keyword">if</span> cls.__impl_class <span class="keyword">is</span> <span class="keyword">None</span>:
        base.__impl_class = cls.configurable_default()
    <span class="keyword">return</span> base.__impl_class
</code></pre><p><code>IOLoop.configured_class()</code>è¿”å›çš„ä¹Ÿæ˜¯<code>IOLoop</code>è¿™ä¸ªç±»ã€‚</p>
<pre><code><span class="decorator">@classmethod</span>
<span class="function"><span class="keyword">def</span> <span class="title">configurable_default</span><span class="params">(cls)</span>:</span>
    <span class="keyword">if</span> hasattr(select, <span class="string">"epoll"</span>):
        <span class="keyword">from</span> tornado.platform.epoll <span class="keyword">import</span> EPollIOLoop
        <span class="keyword">return</span> EPollIOLoop
    <span class="keyword">if</span> hasattr(select, <span class="string">"kqueue"</span>):
        <span class="comment"># Python 2.6+ on BSD or Mac</span>
        <span class="keyword">from</span> tornado.platform.kqueue <span class="keyword">import</span> KQueueIOLoop
        <span class="keyword">return</span> KQueueIOLoop
    <span class="keyword">from</span> tornado.platform.select <span class="keyword">import</span> SelectIOLoop
    <span class="keyword">return</span> SelectIOLoop
</code></pre><p>åœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°é€šè¿‡åˆ¤æ–­<code>select</code>æ¨¡å—æœ‰æ—  â€œepollâ€ï¼Œâ€kqueueâ€ å±æ€§åœ¨ä¸åŒå¹³å°ä¸Šå®ä¾‹åŒ–ä¸åŒçš„<code>IOLoop</code>å®ä¾‹ã€‚<code>EPollIOLoop</code>ã€<code>KQueueIOLoop</code>å’Œ<code>SelectIOLoop</code>éƒ½ç»§æ‰¿äº<code>PollIOLoop</code>å¹¶å°è£…äº†ç»Ÿä¸€çš„æ¥å£ã€‚åœ¨<code>PollIOLoop</code>ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">add_handler</span><span class="params">(self, fd, handler, events)</span>:</span>
    fd, obj = self.split_fd(fd)
    self._handlers[fd] = (obj, stack_context.wrap(handler))
    self._impl.register(fd, events | self.ERROR)

<span class="function"><span class="keyword">def</span> <span class="title">update_handler</span><span class="params">(self, fd, events)</span>:</span>
    fd, obj = self.split_fd(fd)
    self._impl.modify(fd, events | self.ERROR)

<span class="function"><span class="keyword">def</span> <span class="title">remove_handler</span><span class="params">(self, fd)</span>:</span>
    fd, obj = self.split_fd(fd)
    self._handlers.pop(fd, <span class="keyword">None</span>)
    self._events.pop(fd, <span class="keyword">None</span>)
    <span class="keyword">try</span>:
        self._impl.unregister(fd)
    <span class="keyword">except</span> Exception:
        gen_log.debug(<span class="string">"Error deleting fd from IOLoop"</span>, exc_info=<span class="keyword">True</span>)
</code></pre><p>å¦‚æœè¦å®ç°è‡ªå·±çš„ tornado å¼‚æ­¥å‡½æ•°å¯ä»¥è°ƒç”¨ä¸Šé¢ä¸‰ä¸ªæ–¹æ³• åœ¨I<code>OLoop</code>ä¸­æ³¨å†Œ fd å’Œ å›è°ƒå³å¯ã€‚<br>å›åˆ°<code>__new__</code>å‡½æ•°ï¼Œæ¥ä¸‹æ¥å°±æ˜¯åˆ›å»ºå®ä¾‹<code>instance</code>ç„¶ååˆå§‹åŒ–ã€‚<br>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ°äº†é‡å¤´æˆâ€”â€”<code>start()</code></p>
<p><code>start</code>æ–¹æ³•çš„å®ç°åœ¨<code>PollIOLoop</code>ï¼Œæœ‰è¿‘200è¡Œï¼Œä¸è¿‡å¯ä»¥åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(<span class="keyword">self</span>)</span>:</span>
    <span class="comment"># åˆå§‹åŒ–</span>
    <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">_running:</span>
        raise <span class="constant">RuntimeError</span>(<span class="string">"IOLoop is already running"</span>)
    <span class="keyword">self</span>._setup_logging()
    <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">_stopped:</span>
        <span class="keyword">self</span>._stopped = <span class="constant">False</span>
        <span class="keyword">return</span>
    old_current = getattr(<span class="constant">IOLoop</span>._current, <span class="string">"instance"</span>, <span class="constant">None</span>)
    <span class="constant">IOLoop</span>._current.instance = <span class="keyword">self</span>
    <span class="keyword">self</span>._thread_ident = thread.get_ident()
    <span class="keyword">self</span>._running = <span class="constant">True</span>

    ...

    <span class="symbol">try:</span>
        <span class="comment"># ä¸‹é¢å°±æ˜¯äº‹ä»¶å¾ªç¯</span>
        <span class="keyword">while</span> <span class="constant">True</span><span class="symbol">:</span>
            <span class="comment"># Prevent IO event starvation by delaying new callbacks</span>
            <span class="comment"># to the next iteration of the event loop.</span>
            with <span class="keyword">self</span>.<span class="symbol">_callback_lock:</span>
                callbacks = <span class="keyword">self</span>._callbacks
                <span class="keyword">self</span>._callbacks = []

            <span class="comment"># Add any timeouts that have come due to the callback</span>
            due_timeouts = []
            <span class="keyword">if</span> <span class="keyword">self</span>.<span class="symbol">_timeouts:</span>
                now = <span class="keyword">self</span>.time()
                <span class="keyword">while</span> <span class="keyword">self</span>.<span class="symbol">_timeouts:</span>
                    <span class="keyword">if</span> <span class="keyword">self</span>._timeouts[<span class="number">0</span>].callback is <span class="constant">None</span><span class="symbol">:</span>
                        <span class="comment"># The timeout was cancelled.  Note that the</span>
                        <span class="comment"># cancellation check is repeated below for timeouts</span>
                        <span class="comment"># that are cancelled by another timeout or callback.</span>
                        heapq.heappop(<span class="keyword">self</span>._timeouts)
                        <span class="keyword">self</span>._cancellations -= <span class="number">1</span>
                    elif <span class="keyword">self</span>._timeouts[<span class="number">0</span>].deadline &lt;= <span class="symbol">now:</span>
                        due_timeouts.append(heapq.heappop(<span class="keyword">self</span>._timeouts))
                    <span class="symbol">else:</span>
                        <span class="keyword">break</span>
                <span class="keyword">if</span> (<span class="keyword">self</span>._cancellations &gt; <span class="number">512</span>
                        <span class="keyword">and</span> <span class="keyword">self</span>._cancellations &gt; (len(<span class="keyword">self</span>._timeouts) <span class="prompt">&gt;&gt; </span><span class="number">1</span>))<span class="symbol">:</span>
                    <span class="comment"># Clean up the timeout queue when it gets large and it's</span>
                    <span class="comment"># more than half cancellations.</span>
                    <span class="keyword">self</span>._cancellations = <span class="number">0</span>
                    <span class="keyword">self</span>._timeouts = [x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="keyword">self</span>._timeouts
                                      <span class="keyword">if</span> x.callback is <span class="keyword">not</span> <span class="constant">None</span>]
                    heapq.heapify(<span class="keyword">self</span>._timeouts)

            <span class="comment"># ä½¿ç”¨self._run_callbackæ¥æ‰§è¡Œå›è°ƒ</span>
            <span class="keyword">for</span> callback <span class="keyword">in</span> <span class="symbol">callbacks:</span>
                <span class="keyword">self</span>._run_callback(callback)
            <span class="comment"># æ‰§è¡Œæ‰€æœ‰åˆ°æœŸçš„ timeout</span>
            <span class="keyword">for</span> timeout <span class="keyword">in</span> <span class="symbol">due_timeouts:</span>
                <span class="keyword">if</span> timeout.callback is <span class="keyword">not</span> <span class="constant">None</span><span class="symbol">:</span>
                    <span class="keyword">self</span>._run_callback(timeout.callback)
            <span class="comment"># Closures may be holding on to a lot of memory, so allow</span>
            <span class="comment"># them to be freed before we go into our poll wait.</span>
            callbacks = callback = due_timeouts = timeout = <span class="constant">None</span>

        ... 
</code></pre><p>åœ¨å¾ªç¯çš„å¼€å§‹ å…ˆæ‰§è¡Œ<code>self._callbacks</code>åˆ—è¡¨é‡Œé¢çš„å›è°ƒå‡½æ•°è¿˜æœ‰ åˆ°è¾¾<code>deadline</code>çš„<code>timeout</code>ã€‚<code>timeout</code>ç±»ä¿å­˜äº†ä¸€ä¸ª<code>self.deadline</code>å’Œ<code>self.callback</code>å¹¶é‡è½½äº†<code>__lt__</code>å’Œ<code>__le__</code>æ–¹æ³•ï¼Œæ‰€ä»¥<code>IOLoop._timeouts</code>èƒ½ä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—<code>heap</code>æ¥å¯¹å®ƒä»¬æ’åºï¼Œä»è€Œæ‰¾å‡ºåˆ°æœŸçš„<code>timeout</code>å¹¶æ‰§è¡Œå®ƒä»¬çš„å›è°ƒå‡½æ•°ã€‚<br>å›åˆ°äº‹ä»¶å¾ªç¯ï¼Œæ‰§è¡Œå®Œæ‰€æœ‰<code>callbacks</code>å’Œ<code>due_timeouts</code>åï¼Œ<code>poll</code>ç»ˆäºå‡ºåœºäº†ï¼š</p>
<pre><code>...
<span class="comment"># æ¥ä¸Šé¢</span>

        <span class="keyword">if</span> <span class="keyword">self</span>._callbacks:
            <span class="comment"># å¦‚æœåœ¨ä¸Šé¢ self._callbacks å­˜åœ¨æœ‰callbackï¼Œ</span>
            <span class="comment"># poll çš„ç­‰å¾…æ—¶é—´è®¾ä¸º0</span>
            poll_timeout = <span class="number">0.0</span>
            <span class="comment"># å¦‚æœåœ¨ä¸Šé¢ self._timeouts å­˜åœ¨æœ‰timeoutï¼Œ</span>
            <span class="comment"># pollç­‰å¾…åˆ°æœ€è¿‘timeout.deadline </span>
        elif <span class="keyword">self</span>._timeouts:
            poll_timeout = <span class="keyword">self</span>._timeouts[<span class="number">0</span>].deadline - <span class="keyword">self</span>.time()
            poll_timeout = max(<span class="number">0</span>, min(poll_timeout, _POLL_TIMEOUT))
        <span class="keyword">else</span>:
            <span class="comment"># No timeouts and no callbacks, so use the default.</span>
            poll_timeout = _POLL_TIMEOUT

        <span class="keyword">if</span> not <span class="keyword">self</span>._running:
            <span class="keyword">break</span>

        <span class="keyword">if</span> <span class="keyword">self</span>._blocking_signal_threshold is not None:
            <span class="comment"># clear alarm so it doesn't fire while poll is waiting for</span>
            <span class="comment"># events.</span>
            signal.setitimer(signal.ITIMER_REAL, <span class="number">0</span>, <span class="number">0</span>)

        <span class="keyword">try</span>:
            <span class="comment"># ç»ˆäº poll äº†</span>
            event_pairs = <span class="keyword">self</span>._impl.poll(poll_timeout)
        except <span class="keyword">Exception</span> <span class="keyword">as</span> e:
            <span class="keyword">if</span> errno_from_exception(e) == errno.EINTR:
                <span class="keyword">continue</span>
            <span class="keyword">else</span>:
                raise

        <span class="keyword">if</span> <span class="keyword">self</span>._blocking_signal_threshold is not None:
            signal.setitimer(signal.ITIMER_REAL,
                             <span class="keyword">self</span>._blocking_signal_threshold, <span class="number">0</span>)

        <span class="keyword">self</span>._events.update(event_pairs)
        <span class="keyword">while</span> <span class="keyword">self</span>._events:
            fd, events = <span class="keyword">self</span>._events.popitem()
            <span class="keyword">try</span>:
                <span class="comment"># è·å–æ³¨å†Œ fd çš„å›è°ƒå¹¶æ‰§è¡Œ</span>
                fd_obj, handler_func = <span class="keyword">self</span>._handlers[fd]
                handler_func(fd_obj, events)
            except (OSError, IOError) <span class="keyword">as</span> e:
                <span class="keyword">if</span> errno_from_exception(e) == errno.EPIPE:
                    <span class="comment"># Happens when the client closes the connection</span>
                    pass
                <span class="keyword">else</span>:
                    <span class="keyword">self</span>.handle_callback_exception(<span class="keyword">self</span>._handlers.get(fd))
            except <span class="keyword">Exception</span>:
                <span class="keyword">self</span>.handle_callback_exception(<span class="keyword">self</span>._handlers.get(fd))
        fd_obj = handler_func = None

<span class="keyword">finally</span>:
    <span class="comment"># reset the stopped flag so another start/stop pair can be issued</span>
    <span class="keyword">self</span>._stopped = <span class="keyword">False</span>
    <span class="keyword">if</span> <span class="keyword">self</span>._blocking_signal_threshold is not None:
        signal.setitimer(signal.ITIMER_REAL, <span class="number">0</span>, <span class="number">0</span>)
    IOLoop._current.instance = old_current
    <span class="keyword">if</span> old_wakeup_fd is not None:
        signal.set_wakeup_fd(old_wakeup_fd)
</code></pre><p>æ€»ç»“ä¸€ä¸‹ï¼Œtornado çš„<code>IOLoop</code>æ˜¯ åŸºäº<code>poll</code>çš„äº‹ä»¶é©±åŠ¨æ¨¡å‹<code>IOLoop</code>æ˜¯å•çº¿ç¨‹çš„ï¼Œé¿å…äº†å¤šè¿›ç¨‹/å¤šçº¿ç¨‹æ¨¡å‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æŸè€—ï¼Œåœ¨ IO å¯†é›†çš„æƒ…å†µä¸‹æœ‰å¾ˆå¥½çš„æ€§èƒ½ã€‚ä½†å¦‚æœåœ¨<code>IOLoop</code>å¾ªç¯ä¸­ callback çš„æ‰§è¡Œæ—¶é—´å¤ªé•¿ä¼šé˜»å¡æ‰æ•´ä¸ª <code>IOLooop</code>ï¼Œé€ æˆæ€§èƒ½çš„æ€¥å‰§ä¸‹é™ï¼Œæ‰€ä»¥åœ¨å®è·µä¸­è¦ååˆ†çš„æ³¨æ„ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/01/19/tornado-source-code-2/" data-id="ciygo85oh00023x131mneut6b" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/01/19/tornado-source-code-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-tornado-source-code-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/19/tornado-source-code-1/" class="article-date">
  <time datetime="2016-01-19T12:11:34.000Z" itemprop="datePublished">2016-01-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/19/tornado-source-code-1/">tornadoæºç åˆ†æç¬”è®°(1)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Tornado æ˜¯ä¸€ä¸ªç”¨ Python å®ç°çš„ Web æœåŠ¡å™¨æ¡†æ¶ï¼Œå…¶æœ€å¤§çš„ç‰¹ç‚¹æ˜¯ä½¿ç”¨å¼‚æ­¥éé˜»å¡IOçš„å¤„ç†æ–¹å¼æ¥è·å–é«˜è´Ÿè½½å’Œé«˜æ€§èƒ½ã€‚åˆ°åº• Tornado çš„åº•å±‚æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹ã€‚</p>
<p>æ³¨æ˜ä¸€ä¸‹ï¼Œè¿™é‡Œå±•ç¤ºçš„ Tornado ç‰ˆæœ¬ä¸º4.2.1ï¼Œä¸åŒç‰ˆæœ¬å¯èƒ½ä¼šæœ‰ä¸€äº›å‡ºå…¥ã€‚</p>
<p>è®©æˆ‘ä»¬ä»å®˜æ–¹çš„ helloworld å¼€å§‹æˆ‘ä»¬çš„æ—…ç¨‹ï¼š</p>
<p>helloworld.py:</p>
<pre><code>import tornado<span class="class">.httpserver</span>
import tornado<span class="class">.ioloop</span>
import tornado<span class="class">.options</span>
import tornado<span class="class">.web</span>

from tornado<span class="class">.options</span> import define, options

<span class="function"><span class="title">define</span><span class="params">(<span class="string">"port"</span>, default=<span class="number">8888</span>, help=<span class="string">"run on the given port"</span>, type=int)</span></span>


class <span class="function"><span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span></span>:
    def <span class="function"><span class="title">get</span><span class="params">(self)</span></span>:
        self.<span class="function"><span class="title">write</span><span class="params">(<span class="string">"Hello, world"</span>)</span></span>


def <span class="function"><span class="title">main</span><span class="params">()</span></span>:
    tornado<span class="class">.options</span><span class="class">.parse_command_line</span>()
    application = tornado<span class="class">.web</span><span class="class">.Application</span>([
        (r<span class="string">"/"</span>, MainHandler),
    ])
    http_server = tornado<span class="class">.httpserver</span><span class="class">.HTTPServer</span>(application)
    http_server.<span class="function"><span class="title">listen</span><span class="params">(options.port)</span></span>
    tornado<span class="class">.ioloop</span><span class="class">.IOLoop</span><span class="class">.current</span>().<span class="function"><span class="title">start</span><span class="params">()</span></span>


<span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:
    <span class="function"><span class="title">main</span><span class="params">()</span></span>                         
</code></pre><p>Tornado çš„åŸºæœ¬æ¡†æ¶æ˜¯å…ˆå®ç°å¤„ç†å„ç§æ¨¡å¼çš„<code>RequestHandler</code>ç±»ï¼Œç”¨è¿™äº›æ¨¡å¼å’Œå¯¹åº”çš„ Handler åˆå§‹åŒ–ä¸€ä¸ª<code>Application</code>ç±»ï¼Œå†ç”¨è¿™ä¸ª<code>Application</code>ç±»åˆå§‹åŒ–ä¸€ä¸ª<code>HTTPServer</code>ï¼Œè®¾ç½®ç›‘å¬ç«¯å£ï¼Œå†å¯åŠ¨<code>IOLoop</code> ã€‚<br>æˆ‘ä»¬å…ˆæ¥çœ‹<code>Application</code>:</p>
<p>web.py:</p>
<pre><code><span class="class"><span class="keyword">class</span> <span class="title">Application</span><span class="params">(httputil.HTTPServerConnectionDelegate)</span>:</span>

    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, handlers=None, default_host=<span class="string">""</span>, transforms=None,
                 **settings)</span>:</span>

        ...  <span class="comment"># çœç•¥transformå’Œuiæ¨¡å—çš„è®¾ç½®</span>

        self.handlers = []
        self.named_handlers = {}
        self.default_host = default_host
        self.settings = settings
        <span class="keyword">if</span> self.settings.get(<span class="string">"static_path"</span>):
            path = self.settings[<span class="string">"static_path"</span>]
            handlers = list(handlers <span class="keyword">or</span> [])
            static_url_prefix = settings.get(<span class="string">"static_url_prefix"</span>,
                                             <span class="string">"/static/"</span>)
            static_handler_class = settings.get(<span class="string">"static_handler_class"</span>,
                                                StaticFileHandler)
            static_handler_args = settings.get(<span class="string">"static_handler_args"</span>, {})
            static_handler_args[<span class="string">'path'</span>] = path
            <span class="keyword">for</span> pattern <span class="keyword">in</span> [re.escape(static_url_prefix) + <span class="string">r"(.*)"</span>,
                            <span class="string">r"/(favicon\.ico)"</span>, <span class="string">r"/(robots\.txt)"</span>]:
                handlers.insert(<span class="number">0</span>, (pattern, static_handler_class,
                                    static_handler_args))
        <span class="keyword">if</span> handlers:
            self.add_handlers(<span class="string">".*$"</span>, handlers)

        ...
</code></pre><p><code>Application</code>çš„åˆå§‹åŒ–çš„å·¥ä½œä¸»è¦æ˜¯è®¾ç½® transform , åŠ è½½ ui æ¨¡å—ï¼Œä¸ºé™æ€æ–‡ä»¶è®¾ç½®<code>StaticFileHandler</code>ï¼Œåé¢è¿˜æœ‰ä¸º debug æ¨¡å¼è®¾ç½® autoreloadï¼Œæœ€ä¸»è¦çš„è¿˜æ˜¯è°ƒç”¨<code>self.add_handlers(&quot;.*$&quot;, handlers)</code>æ¥æ·»åŠ  handlersï¼Œ</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">add_handlers</span><span class="params">(self, host_pattern, host_handlers)</span>:</span>
    <span class="string">"""Appends the given handlers to our handler list."""</span>
    <span class="keyword">if</span> <span class="keyword">not</span> host_pattern.endswith(<span class="string">"$"</span>):
        host_pattern += <span class="string">"$"</span>
    handlers = []

    <span class="comment"># ç¡®ä¿å…¨éƒ¨åŒ¹é…çš„ handler å¤„äº self.handlers çš„æœ€å </span>
    <span class="keyword">if</span> self.handlers <span class="keyword">and</span> self.handlers[-<span class="number">1</span>][<span class="number">0</span>].pattern == <span class="string">'.*$'</span>:
        self.handlers.insert(-<span class="number">1</span>, (re.compile(host_pattern), handlers))
    <span class="keyword">else</span>:
        self.handlers.append((re.compile(host_pattern), handlers))

    <span class="keyword">for</span> spec <span class="keyword">in</span> host_handlers:
        <span class="keyword">if</span> isinstance(spec, (tuple, list)):
            <span class="keyword">assert</span> len(spec) <span class="keyword">in</span> (<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)
            spec = URLSpec(*spec)
        handlers.append(spec)
        <span class="keyword">if</span> spec.name:
            <span class="keyword">if</span> spec.name <span class="keyword">in</span> self.named_handlers:
                app_log.warning(
                    <span class="string">"Multiple handlers named %s; replacing previous value"</span>,
                    spec.name)
            self.named_handlers[spec.name] = spec
</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹<code>HttpServer</code>ç±»ï¼Œå®ƒçš„åˆå§‹åŒ–æ²¡ä»€ä¹ˆå¥½è®²çš„ï¼Œå€¼å¾—æ³¨æ„åˆ°ä¸€ç‚¹æ˜¯å®ƒä»¥<code>self.request_callback</code>å±æ€§æ¥ä¿å­˜<code>Application</code>ç±»ã€‚ç›´æ¥æ¥çœ‹<code>listen</code>æ–¹æ³•<code>HttpServer</code>çš„ listen æ–¹æ³•ç›´æ¥ç»§æ‰¿è‡ª<code>TCPServer</code>çš„<code>listen</code>æ–¹æ³•ã€‚</p>
<p>tcpserver.py:</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">listen</span><span class="params">(self, port, address=<span class="string">""</span>)</span>:</span>

        sockets = bind_sockets(port, address=address)
        self.add_sockets(sockets)
</code></pre><p>Socket è¿æ¥è¦ç»è¿‡ create -&gt; bind -&gt; listen çš„ä¸‰éƒ¨æ›²ã€‚bind_sockets å‡½æ•°èµ°å®Œäº†å‰é¢ä¸¤æ­¥ï¼šå°±æ˜¯åˆ›å»º socket å¹¶è¿›è¡Œè®¾ç½®ï¼Œç„¶å bindã€‚å› ä¸ºè¾“å…¥çš„ address å¯èƒ½å¯¹åº”å¤šä¸ªIPåœ°å€ï¼Œæ‰€ä»¥<code>bind_sockets</code>è¿”å›å€¼ä¸ºä¸€ä¸ª socket çš„åˆ—è¡¨ã€‚ æˆ‘ä»¬æ¥çœ‹<code>add_sockets</code>ï¼š</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">add_sockets</span><span class="params">(self, sockets)</span>:</span>

        <span class="keyword">if</span> self.io_loop <span class="keyword">is</span> <span class="keyword">None</span>:
            self.io_loop = IOLoop.current()

        <span class="keyword">for</span> sock <span class="keyword">in</span> sockets:
            self._sockets[sock.fileno()] = sock
            add_accept_handler(sock, self._handle_connection,
                               io_loop=self.io_loop)
</code></pre><p>ä¸€å¼€å§‹å…ˆè·å¾—<code>IOLoop</code>å®ä¾‹ï¼Œå¯¹äº<code>IOLoop</code>æ˜¯å…¨å±€çš„å•ä¾‹ï¼Œå…³äº<code>IOLoop</code>çš„å°†åœ¨å…¶ä»–åœ°æ–¹è¯¦è¿°ã€‚ç„¶åè°ƒç”¨<code>add_accept_handler</code>ç”¨äºè®¾ç½® socket æ¥æ”¶åˆ°è¿æ¥æ—¶çš„å›è°ƒå‡½æ•°ä¸º<code>TCPServer._handle_connection</code>ã€‚å…ˆæ¥çœ‹ <code>add_accept_handler</code>ã€‚</p>
<p>netutil.py:</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">add_accept_handler</span><span class="params">(sock, callback, io_loop=None)</span>:</span>

    <span class="keyword">if</span> io_loop <span class="keyword">is</span> <span class="keyword">None</span>:
        io_loop = IOLoop.current()

    <span class="function"><span class="keyword">def</span> <span class="title">accept_handler</span><span class="params">(fd, events)</span>:</span>

        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(_DEFAULT_BACKLOG):
            <span class="keyword">try</span>:
                connection, address = sock.accept()
            <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:
                <span class="comment"># _ERRNO_WOULDBLOCK indicate we have accepted every</span>
                <span class="comment"># connection that is available.</span>
                <span class="keyword">if</span> errno_from_exception(e) <span class="keyword">in</span> _ERRNO_WOULDBLOCK:
                    <span class="keyword">return</span>
                <span class="comment"># ECONNABORTED indicates that there was a connection</span>
                <span class="comment"># but it was closed while still in the accept queue.</span>
                <span class="comment"># (observed on FreeBSD).</span>
                <span class="keyword">if</span> errno_from_exception(e) == errno.ECONNABORTED:
                    <span class="keyword">continue</span>
                <span class="keyword">raise</span>
            callback(connection, address)
    io_loop.add_handler(sock, accept_handler, IOLoop.READ)
</code></pre><p><code>add_accept_handler</code>å‘<code>io_loop</code>æ³¨å†Œäº† socketï¼Œåœ¨<code>IOLoop.READ</code>äº‹ä»¶åˆ°æ¥æ—¶çš„ è°ƒç”¨<code>accept_handler</code>æ¥å¤„ç† socket äº‹ä»¶ã€‚<code>accept_handler</code>å°±å®šä¹‰åœ¨<code>add_accept_handler</code>å†…éƒ¨ï¼Œå¯ä»¥çœ‹åˆ°å…¶å®å°±æ˜¯<code>sock.accept()</code>è·å–è¿æ¥çš„ socket å’Œ addressï¼Œç„¶åå†è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>TCPServer. _handle_connection</code>:</p>
<p>tcpserver.py:</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">_handle_connection</span><span class="params">(self, connection, address)</span>:</span>
        <span class="keyword">if</span> self.ssl_options <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:

            ...  <span class="comment"># å¤„ç†ssl</span>

        <span class="keyword">try</span>:
            <span class="keyword">if</span> self.ssl_options <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:
                stream = SSLIOStream(connection, io_loop=self.io_loop,
                                     max_buffer_size=self.max_buffer_size,
                                     read_chunk_size=self.read_chunk_size)
            <span class="keyword">else</span>:
                stream = IOStream(connection, io_loop=self.io_loop,
                                  max_buffer_size=self.max_buffer_size,
                                  read_chunk_size=self.read_chunk_size)
            future = self.handle_stream(stream, address)
            <span class="keyword">if</span> future <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:
                self.io_loop.add_future(future, <span class="keyword">lambda</span> f: f.result())
        <span class="keyword">except</span> Exception:
            app_log.error(<span class="string">"Error in connection callback"</span>, exc_info=<span class="keyword">True</span>)
</code></pre><p>æˆ‘ä»¬ç•¥å»å¤„ç† ssl çš„éƒ¨åˆ†ï¼Œåœ¨è¿™é‡Œä¸»è¦çš„å†…å®¹å°±æ˜¯å°† socket å°è£…æˆ<code>IOStream</code>ç±»ç»™ä¸Šå±‚å¤„ç†ã€‚<code>handle_stream</code>æ–¹æ³•åœ¨<code>HttpServer</code>ä¸­å®ç°ï¼Œè¿”å›<code>None</code>æˆ–ä¸€ä¸ª<code>future</code>å¯¹è±¡ã€‚å…³äº<code>future</code>å¯¹è±¡åé¢å†ç»†è®²ã€‚</p>
<p>åˆ°æ­¤<code>Application</code>å’Œ<code>httpserver</code>å°±å‡†å¤‡å°±ç»ªï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ tornado çš„æ ¸å¿ƒâ€”â€”<code>IOLoop</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/01/19/tornado-source-code-1/" data-id="ciygo85oj00033x13psydt35p" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/01/19/tornado-source-code-1/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-python-captcha" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/06/python-captcha/" class="article-date">
  <time datetime="2016-01-06T13:18:32.000Z" itemprop="datePublished">2016-01-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/06/python-captcha/">ä½¿ç”¨PythonåšéªŒè¯ç è¯†åˆ«</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>å¹³å¸¸æˆ‘ä»¬ä¸Šç½‘ç»å¸¸é‡åˆ°çš„éªŒè¯ç è‹±æ–‡åä¸ºCAPTCHAï¼Œ è¿™å…¶å®æ˜¯ä¸€ä¸ªéå¸¸ç‚«é…·çš„åå­—çš„ç¼©å†™ï¼Œå…¨ç§°ä¸ºå…¨è‡ªåŠ¨åŒºåˆ†è®¡ç®—æœºå’Œäººç±»çš„å›¾çµæµ‹è¯•ï¼ˆè‹±è¯­ï¼šCompletely Automated Public Turing test to tell Computers and Humans Apart) ã€‚çœ‹èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆé«˜å¤§ä¸Šå•Šï¼Œå›¾çµæµ‹è¯•éƒ½å‡ºæ¥äº†ã€‚ä¸è¿‡ç¡®å®ï¼Œå¯¹äºè¯†åˆ«éªŒè¯ç è¿™ç§å¯¹äººæ¥è¯´å¾ˆå®¹æ˜“çš„ä»»åŠ¡ï¼ˆæ™®é€šéªŒè¯ç ï¼Œé12306çš„ï¼‰å¯¹äºè®¡ç®—æœºæ¥è¯´å¯ä¸ç®€å•ã€‚</p>
<h2 id="å·¥å…·">å·¥å…·</h2><p>æœ‰ç”¨çš„å·¥å…·ï¼š</p>
<ul>
<li><a href="http://www.pythonware.com/products/pil/" target="_blank" rel="external">PIL</a>(Python Image Library)â€”â€”å›¾ç‰‡å¤„ç†åº“</li>
<li><a href="http://www.numpy.org/" target="_blank" rel="external">numpy</a>â€”â€”çŸ©é˜µè¿ç®—</li>
<li><a href="https://github.com/tesseract-ocr/tesseract" target="_blank" rel="external">tesseract</a>â€”â€”å¼€æºçš„ORCåº“</li>
<li><a href="http://scikit-learn.org/stable/index.html" target="_blank" rel="external">scikit-learn</a>â€”â€”æœºå™¨å­¦ä¹ æ–¹é¢çš„é›†æˆåŒ…</li>
</ul>
<h2 id="åˆ†æéªŒè¯ç ">åˆ†æéªŒè¯ç </h2><p>éªŒè¯ç ä¹Ÿæ˜¯æœ‰è®¡ç®—æœºç”Ÿæˆçš„ï¼Œæ‰€ä»¥ä¸åŒçš„éªŒè¯ç æœ‰ä¸åŒçš„å¤„ç†æ–¹æ³•ã€‚æ‰€ä»¥éªŒè¯ç è¯†åˆ«çš„ç¬¬ä¸€æ­¥æ˜¯è§‚å¯Ÿç›®æ ‡éªŒè¯ç çš„è§„å¾‹ã€‚è¿™æ¬¡é¢å¯¹çš„éªŒè¯ç å¼ è¿™æ ·å­</p>
<p><img src="http://7vzu7p.com1.z0.glb.clouddn.com/shot.png" alt=" "></p>
<p>ä¸€èˆ¬æ¥è¯´ç¬¬ä¸€æ­¥é¦–å…ˆæ˜¯è¦å°†éªŒè¯ç å›¾ç‰‡è½¬æ¢ä¸ºäºŒå€¼å›¾å»é™¤å¹²æ‰°ä¿¡æ¯ï¼Œä¾¿äºè¿›ä¸€æ­¥å¤„ç†ã€‚<br>è§‚å¯Ÿåˆ†æéªŒè¯ç çš„å­—ä½“éƒ½æ˜¯åŒæ ·çš„é¢œè‰²ï¼ŒèƒŒæ™¯æœ‰æ¨ªçš„æˆ–æ–œçš„æ¡çº¹ã€‚ç›´æ¥äºŒå€¼åŒ–æ•ˆæœå¹¶ä¸å¥½ã€‚ä½†æ˜¯å­—ç¬¦ä¹‹é—´æ˜¯æ²¡æœ‰ç²˜è¿çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æå–å‡ºå­—ç¬¦ã€‚</p>
<h2 id="é¢„å¤„ç†">é¢„å¤„ç†</h2><h3 id="å¯»æ‰¾å­—ç¬¦åƒç´ ">å¯»æ‰¾å­—ç¬¦åƒç´ </h3><p>é¦–å…ˆç¬¬ä¸€æ­¥æ˜¯æå–å‡ºå­—ç¬¦çš„é¢œè‰²ä¹Ÿå°±æ˜¯RGBå€¼ï¼Œè§‚å¯Ÿåˆ°å­—ç¬¦çš„é¢œè‰²ç›¸åŒï¼Œå æ•´ä¸ªéªŒè¯ç å›¾ç‰‡çš„æ¯”ä¾‹åŸºæœ¬ä¸Šæ˜¯å·®ä¸å¤šçš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†æåƒç´ çš„ç›´æ–¹å›¾æ‰¾å‡ºå­—ç¬¦çš„åƒç´ å€¼å‡ºæ¥ã€‚ä¸è¿‡æˆ‘å·æ‡’æ²¡ç”¨è¿™æ ·çš„æ–¹æ³•ï¼Œå› ä¸ºå›¾ç‰‡å¼€å¤´éƒ½æ˜¯æ¨ªå‘çš„æ¡çº¹ï¼Œæ‰€ä»¥æˆ‘å°±ç›´æ¥ä»å·¦å¾€å³æ‰«æå›¾ç‰‡æ¨ªå‘ä¸­çº¿çš„åƒç´ å€¼ï¼Œæ‰¾å‡ºåƒç´ å€¼çªå˜çš„åœ°æ–¹å°±å¯ä»¥æ‰¾åˆ°å­—ç¬¦çš„åƒç´ å€¼äº†ã€‚</p>
<h3 id="FloodFillç®—æ³•æå–å­—ç¬¦">FloodFillç®—æ³•æå–å­—ç¬¦</h3><p>Flood fillç®—æ³•æ˜¯ä»ä¸€ä¸ªåŒºåŸŸä¸­æå–è‹¥å¹²ä¸ªè¿é€šçš„ç‚¹ä¸å…¶ä»–ç›¸é‚»åŒºåŸŸåŒºåˆ†å¼€ï¼ˆæˆ–åˆ†åˆ«æŸ“æˆä¸åŒé¢œè‰²ï¼‰çš„ç»å…¸ç®—æ³•ã€‚å¤„ç†è¿™ç§æ²¡æœ‰ç²˜è¿å­—ç¬¦æˆ–è€…ç²˜è¿ä½†æ˜¯å­—ç¬¦æ¯ä¸ªé¢œè‰²ä¸ä¸€æ ·çš„éªŒè¯ç æ•ˆæœæ‹”ç¾¤ã€‚å¤šè¯´æ— ç›Šï¼Œçœ‹å›¾å°±æ˜ç™½äº†</p>
<p><img src="http://7vzu7p.com1.z0.glb.clouddn.com/floodfill4.gif" alt=" "><br><img src="http://7vzu7p.com1.z0.glb.clouddn.com/floodfill8.gif" alt=" "></p>
<p>FloodFillæœ€ç®€å•çš„å®ç°æ˜¯ç”¨é€’å½’</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">flood_fill</span><span class="params">(img, x0, y0, blank_color, color_to_fill, cmp_func)</span>:</span> 
    pix = img.load()
    pix[x0, y0] = color_to_fill
    offsets = [(<span class="number">1</span>, <span class="number">0</span>), (<span class="number">0</span>, <span class="number">1</span>), (-<span class="number">1</span>, <span class="number">0</span>), (<span class="number">0</span>, -<span class="number">1</span>)]
    <span class="keyword">for</span> xoffset, yoffset <span class="keyword">in</span> offsets:
        x, y = x0 + xoffset, y0 + yoffset
        <span class="keyword">try</span>:
            <span class="keyword">if</span> cmp_func(pix[x, y], blank_color):
                flood_fill(img, x, y, blank_color)
        <span class="keyword">except</span> IndexError:
            <span class="keyword">pass</span>
</code></pre><p>ä¸è¿‡pythonä¸æ”¯æŒå°¾é€’å½’ä¼˜åŒ–ï¼Œæ‰€ä»¥è¿è¡Œæ—¶å›å‡ºç°å¼‚å¸¸æç¤ºåˆ°è¾¾æœ€å¤§é€’å½’é™åˆ¶ã€‚æ‰€ä»¥æ”¹ç”¨åŸºäºé˜Ÿåˆ—çš„å¹¿åº¦ä¼˜å…ˆæœç´¢<br>å®ç°</p>
<pre><code><span class="function"><span class="keyword">def</span> <span class="title">flood_fill2</span><span class="params">(img, x0, y0, blank_color, color_to_fill, cmp_func)</span>:</span>
    pix = img.load()
    visited = set()
    q = queue.Queue()
    q.put((x0, y0))
    visited.add((x0, y0))
    offsets = [(<span class="number">1</span>, <span class="number">0</span>), (<span class="number">0</span>, <span class="number">1</span>), (-<span class="number">1</span>, <span class="number">0</span>), (<span class="number">0</span>, -<span class="number">1</span>)]
    <span class="keyword">while</span> <span class="keyword">not</span> q.empty():
        x, y = q.get()
        pix[x, y] = color_to_fill
        <span class="keyword">for</span> xoffset, yoffset <span class="keyword">in</span> offsets:
            x1, y1 = x + xoffset, y + yoffset
            <span class="keyword">if</span> (x1, y1) <span class="keyword">in</span> (visited):
                <span class="keyword">continue</span>  <span class="comment"># å·²ç»è®¿é—®è¿‡äº†</span>
            visited.add((x1, y1))
            <span class="keyword">try</span>:
                <span class="keyword">if</span> cmp_func(pix[x1, y1], blank_color):
                       q.put((x1, y1))
            <span class="keyword">except</span> IndexError:
                <span class="keyword">pass</span>
    <span class="keyword">return</span> visited
</code></pre><h3 id="å­—ç¬¦åˆ†å‰²">å­—ç¬¦åˆ†å‰²</h3><p>å­—ç¬¦ä¸²çš„åˆ†å‰²ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ä¸€æ­¥ï¼Œå¯¹äºå¤æ‚çš„éªŒè¯ç ï¼Œç›®å‰è¿˜æ²¡æœ‰éå¸¸æœ‰æ•ˆçš„å­—ç¬¦ä¸²åˆ†å‰²æ–¹æ³•ã€‚ å¯¹äºä¸ç²˜è¿å¹¶ä¸”å­—ç¬¦ä¹‹é—´æ²¡æœ‰é‡å çš„å­—ç¬¦ä¸²ç›´æ¥åœ¨ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘æ‰«ææ•´è¡Œæˆ–æ•´åˆ—æ˜¯å¦ç©ºç™½æ¥åˆ†å‰²å­—ç¬¦</p>
<p><img src="http://7vzu7p.com1.z0.glb.clouddn.com/rrr.png" alt=" "></p>
<p>å¯¹äºå­—ç¬¦é—´æœ‰é‡å çš„ï¼Œå¦‚ä¸‹å›¾çš„2å’ŒFã€‚</p>
<p><img src="http://7vzu7p.com1.z0.glb.clouddn.com/linkchar.png" alt=""></p>
<p>ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨æ–œå‘çš„åˆ‡å‰²æ³•ï¼Œä½†æ›´å¥½çš„æ–¹æ³•è¿˜æ˜¯ç»Ÿè®¡xåæ ‡ä¸Šçš„é»‘ç™½åƒç´ å æ¯”ï¼Œåœ¨å­—ç¬¦åˆ†éš”å¤„ä¼šæœ‰ç™½åƒç´ å æ¯”çš„æ³¢è°·ã€‚æ ¹æ®è¿™ä¸ªæ³¢è°·çš„æ¥åˆ†å‰²å›¾ç‰‡ã€‚</p>
<h3 id="æ ‡å‡†åŒ–(normalize)">æ ‡å‡†åŒ–(normalize)</h3><p>è¿™ä¸€æ­¥å°†åˆ‡å‰²å‡ºæ¥çš„å­—ç¬¦æ‘†æ­£å¹¶ä¸”ç»Ÿä¸€æˆä¸€æ ·çš„å¤§å°</p>
<p>æ‘†æ­£å­—ç¬¦çš„æ–¹æ³•æ˜¯ä½¿ç”¨æ—‹è½¬å¡å£³ç®—æ³•ã€‚å³ä» -30åº¦ ~ 30åº¦æ—‹è½¬å›¾ç‰‡ï¼Œæ£€æµ‹å­—ç¬¦é—´è·ï¼Œå–æœ€å°é—´è·å¯¹åº”çš„è§’åº¦ã€‚</p>
<p><img src="http://7vzu7p.com1.z0.glb.clouddn.com/trible91.png" alt=""></p>
<p>æœ€ååœ¨å››å‘¨å¡«å……åƒç´ ï¼ŒæŠŠæ‰€ä»¥å­—ç¬¦å›¾ç‰‡ç»Ÿä¸€æˆä¸€æ ·çš„å°ºå¯¸ã€‚</p>
<h3 id="è¯†åˆ«">è¯†åˆ«</h3><h4 id="Tesseract">Tesseract</h4><p>è¯†åˆ«æ–¹é¢å¯ä»¥ä½¿ç”¨ORCåº“<a href="https://github.com/tesseract-ocr/tesseract" target="_blank" rel="external">tesseract</a></p>
<p>åœ¨å®‰è£…tesseractå pythonä½¿ç”¨<a href="https://pypi.python.org/pypi/pytesseract/0.1" target="_blank" rel="external">pytessract</a>æ–¹ä¾¿çš„è°ƒç”¨tesseractF</p>
<pre><code><span class="keyword">import</span> pytesseract
<span class="keyword">from</span> <span class="type">PIL</span> <span class="keyword">import</span> <span class="type">Image</span>

img = <span class="type">Image</span>.open(<span class="string">"captcha.png"</span>)

<span class="literal">result</span> = pytesseract.image_to_string(img, config='-psm <span class="number">7</span>')
</code></pre><p>ä¸è¿‡ç»æµ‹è¯•tesseractçš„å¯¹äºæ ‡å‡†çš„å°åˆ·ä½“çš„è‹±æ–‡è¯†åˆ«æ•ˆæœè¿˜æ˜¯å¯ä»¥çš„ï¼Œä½†è‹¥æœ‰æ—‹è½¬æ‰­æ›²ç­‰æ‰°åŠ¨ç­‰è¯è¯†åˆ«ç‡å°±ä¸æ˜¯å¾ˆé«˜äº†ã€‚ä¸è¿‡tesseracté€šè¿‡è®­ç»ƒè‡ªå·±çš„è¯†åˆ«æ¨¡å‹æ¥æé«˜è¯†åˆ«ç‡ã€‚</p>
<h4 id="æœºå™¨å­¦ä¹ ">æœºå™¨å­¦ä¹ </h4><p>å¦å¤–ä¸€ä¸ªçœ‹èµ·æ¥æ›´é«˜å¤§ä¸Šçš„æ–¹æ³•æ˜¯åº”ç”¨æœºå™¨å­¦ä¹ çš„æ–¹æ³•æ¥åšè¯†åˆ«ï¼Œå¸¸ç”¨çš„æœ‰SVMå’Œç¥ç»ç½‘ç»œã€‚</p>
<p>pythonä¸‹æœºå™¨å­¦ä¹ çš„åº“é¦–æ¨<a href="http://scikit-learn.org/stable/index.html" target="_blank" rel="external">scikit-learn</a>ã€‚scikit-learné‡Œé¢é›†æˆäº†å„ç§å¸¸ç”¨çš„è¯†åˆ«æ¨¡å‹ï¼Œé™çº¬ï¼Œèšç±»ç­‰ç®—æ³•ï¼Œè¿˜è¦éå¸¸æ£’çš„æ–‡æ¡£ï¼Œå¯ä»¥è¯´æ˜¯æœºå™¨å­¦ä¹ æ–¹é¢çš„ç™¾å®ç®±ã€‚</p>
<p>ä½¿ç”¨scikit-learnè®­ç»ƒéªŒè¯ç è¯†åˆ«æ¨¡å‹è¿™äº‹ã€‚ã€‚ã€‚è¿˜æ˜¯å…ˆæŒ–ä¸ªå‘ï¼Œä¸‹å›å†å¡«å§</p>
<hr>
<h3 id="Reference">Reference</h3><p><a href="http://drops.wooyun.org/tips/141" target="_blank" rel="external">http://drops.wooyun.org/tips/141</a><br><a href="http://drops.wooyun.org/tips/6313" target="_blank" rel="external">http://drops.wooyun.org/tips/6313</a><br><a href="http://pillow.readthedocs.org/en/3.0.x/reference/Image.html" target="_blank" rel="external">http://pillow.readthedocs.org/en/3.0.x/reference/Image.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/01/06/python-captcha/" data-id="ciygo85om00053x13sg8absg3" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/01/06/python-captcha/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-android-studio-tess-two" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/02/android-studio-tess-two/" class="article-date">
  <time datetime="2016-01-02T09:49:15.000Z" itemprop="datePublished">2016-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/02/android-studio-tess-two/">åœ¨Android Studioä¸­ä½¿ç”¨tess-Two</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Tesseract_&amp;_tess-two">Tesseract &amp; tess-two</h2><p><a href="http://code.google.com/p/tesseract-ocr/" target="_blank" rel="external">Tesseract</a>æ˜¯ä¸€ä¸ªå¼€æºçš„OCR(optical character Recognition)åº“ï¼Œæœ€åˆç”±æƒ æ™®å…¬å¸å¼€å‘ï¼Œç„¶åå¼€æºä¹‹åç”±googleç»´æŠ¤ã€‚ä½¿ç”¨Tesseractå¯ä»¥ä»å›¾ç‰‡ä¸­è¯†åˆ«å‡ºæ–‡å­—ã€‚Tesseractæ”¯æŒå¤šç§æ–‡å­—ï¼Œè¿˜å¯ä»¥é’ˆå¯¹ç›®æ ‡è®­ç»ƒè‡ªå·±çš„è¯†åˆ«æ¨¡å‹ï¼Œå¯ä»¥è¯´å¤§å¤§æ–¹ä¾¿äº†å¼€å‘è€…ã€‚tess-twoæ˜¯Tesseractåœ¨Androidå¹³å°ä¸Šçš„ç§»æ¤ã€‚æ›´å¤šä¿¡æ¯å‚é˜…<a href="https://github.com/rmtheis/tess-two" target="_blank" rel="external">tess-twoä¸»é¡µ</a></p>
<h2 id="tess-twoåœ¨Android_Studioçš„é…ç½®">tess-twoåœ¨Android Studioçš„é…ç½®</h2><h4 id="1-_ä¸‹è½½å®‰è£…Android_NDK">1. ä¸‹è½½å®‰è£…Android NDK</h4><h4 id="2-_ä¸‹è½½è§£å‹tess-twoæˆ–è€…ç›´æ¥git_clone">2. ä¸‹è½½è§£å‹<a href="https://github.com/rmtheis/tess-two" target="_blank" rel="external">tess-two</a>æˆ–è€…ç›´æ¥git clone</h4><h4 id="3-_ä½¿ç”¨NDKç¼–è¯‘è§£å‹å‡ºæ¥çš„_tess-two_ä¸‹çš„_tess-two_æ–‡ä»¶å¤¹">3. ä½¿ç”¨NDKç¼–è¯‘è§£å‹å‡ºæ¥çš„ tess-two ä¸‹çš„ tess-two æ–‡ä»¶å¤¹</h4><pre><code><span class="keyword">cd</span> tess-<span class="keyword">two</span>/tess-<span class="keyword">two</span>
ndk-build
</code></pre><h4 id="4-_é…ç½®Android_Studio">4. é…ç½®Android Studio</h4><p>åœ¨ä½ çš„é¡¹ç›®ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªlibrariesçš„æ–‡ä»¶å¤¹ï¼Œå°†NDKç¼–è¯‘å¥½çš„tess-two/tess-twoç›®å½•å¤åˆ¶åˆ°librariesä¸‹ã€‚<br>åœ¨libraries/tess-twoç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª build.gradle çš„æ–‡ä»¶ã€‚å°†ä¸‹é¢çš„å†…å®¹å¤åˆ¶è¿›å»</p>
<pre><code>apply plugin: <span class="string">'android-library'</span>

<span class="keyword">buildscript</span> {
    <span class="keyword">repositories</span> {
        mavenCentral()
    }
    <span class="keyword">dependencies</span> {
        <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:1.5.0'</span>   <span class="comment">// æ ¹æ®ä½ çš„gradleç‰ˆæœ¬è¿›è¡Œè°ƒæ•´</span>
    }
}

android {
    compileSdkVersion <span class="number">23</span>             <span class="comment">// æ ¹æ®ä½ çš„é¡¹ç›®è¿›è¡Œè°ƒæ•´</span>
    buildToolsVersion <span class="string">"23.0.2"</span>       <span class="comment">// æ ¹æ®ä½ çš„é¡¹ç›®è¿›è¡Œè°ƒæ•´</span>

    defaultConfig {
        minSdkVersion <span class="number">15</span>             <span class="comment">// æ ¹æ®ä½ çš„é¡¹ç›®è¿›è¡Œè°ƒæ•´</span>
        targetSdkVersion <span class="number">23</span>          <span class="comment">// æ ¹æ®ä½ çš„é¡¹ç›®è¿›è¡Œè°ƒæ•´</span>
    }

    <span class="keyword">sourceSets</span>.main {
        manifest.srcFile <span class="string">'AndroidManifest.xml'</span>
        java.srcDirs = [<span class="string">'src'</span>]
        resources.srcDirs = [<span class="string">'src'</span>]
        res.srcDirs = [<span class="string">'res'</span>]
        jniLibs.srcDirs = [<span class="string">'libs'</span>]
    }
}
</code></pre><p>ç„¶ååœ¨é¡¹ç›®ç›®å½•ä¸‹çš„ setting.gradle æ–‡ä»¶ä¸‹åŠ å…¥ä¸€è¡Œ</p>
<pre><code><span class="keyword">include</span> <span class="string">':libraries:tess-two'</span>
</code></pre><p>åœ¨é¡¹ç›®ç›®å½•ä¸‹çš„app/build.gradle æ–‡ä»¶ä¸­çš„ dependencies éƒ¨åˆ†åŠ å…¥ä¸€è¡Œ <code>compile project(&#39;:libraries:tess-two&#39;)</code></p>
<pre><code><span class="keyword">dependencies</span> {
    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])
    testCompile <span class="string">'junit:junit:4.12'</span>
    <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:23.1.0'</span>
    ....

    <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">':libraries:tess-two'</span>)
}
</code></pre><h4 id="ä½¿ç”¨Tess-two">ä½¿ç”¨Tess-two</h4><p>tess-two çš„è¯†åˆ«éœ€è¦æä¾›ä¸€ä¸ªtessdataçš„æ–‡ä»¶å¤¹ï¼Œå¯ä»¥åœ¨<a href="http://code.google.com/p/tesseract-ocr/" target="_blank" rel="external">http://code.google.com/p/tesseract-ocr/</a>ä¸­æ‰¾åˆ°ã€‚  </p>
<p>è¿™é‡Œæä¾›ä¸€ä¸ªç®€å•çš„ demo </p>
<pre><code><span class="keyword">import</span> com.googlecode.tesseract.android.<span class="type">TessBaseAPI</span>;


public <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AppCompatActivity</span> {</span>

    <span class="keyword">private</span> static <span class="keyword">final</span> <span class="type">String</span> <span class="type">SD_PATH</span>= <span class="type">Environment</span>.getExternalStorageDirectory().getPath();

    <span class="keyword">private</span> <span class="type">Button</span> button;
    <span class="keyword">private</span> <span class="type">TextView</span> textView;
    <span class="keyword">private</span> <span class="type">EditText</span> editText;

    <span class="annotation">@Override</span>
    <span class="keyword">protected</span> void onCreate(<span class="type">Bundle</span> savedInstanceState) {
        <span class="keyword">super</span>.onCreate(savedInstanceState);
        setContentView(<span class="type">R</span>.layout.activity_main);

        button = (<span class="type">Button</span>) findViewById(<span class="type">R</span>.id.button);
        textView = (<span class="type">TextView</span>) findViewById(<span class="type">R</span>.id.textView);

        button.setOnClickListener(<span class="keyword">new</span> <span class="type">View</span>.<span class="type">OnClickListener</span>() {
            <span class="annotation">@Override</span>
            public void onClick(<span class="type">View</span> v) {

                <span class="type">TessBaseAPI</span> baseApi = <span class="keyword">new</span> <span class="type">TessBaseAPI</span>();
                <span class="comment">// æŒ‡å®šè¯­è¨€é›†ï¼Œsdå¡æ ¹ç›®å½•ä¸‹æ”¾ç½®Tesseractçš„tessdataæ–‡ä»¶å¤¹   </span>
                baseApi.init(<span class="type">SD_PATH</span>, <span class="string">"eng"</span>);
                <span class="comment">// è®¾ç½®psmæ¨¡å¼</span>
                baseApi.setPageSegMode(<span class="type">TessBaseAPI</span>.<span class="type">PageSegMode</span>.<span class="type">PSM_SINGLE_LINE</span>);

                editText = (<span class="type">EditText</span>) findViewById(<span class="type">R</span>.id.editText);
                <span class="type">String</span> img = editText.getText().toString();
                <span class="comment">// è®¾ç½®å›¾ç‰‡</span>
                baseApi.setImage(<span class="keyword">new</span> <span class="type">File</span>(<span class="type">SD_PATH</span> + img));
                <span class="comment">// è·å–ç»“æœ</span>
                <span class="keyword">final</span> <span class="type">String</span> result = baseApi.getUTF8Text();
                textView.setText(result);
                <span class="comment">// é‡Šæ”¾å†…å­˜</span>
                baseApi.clear();
                baseApi.end();

            }
        });
    }
}
</code></pre><hr>
<p>å‚è€ƒ</p>
<p><a href="https://coderwall.com/p/eurvaq/tesseract-with-andoird-and-gradle" target="_blank" rel="external">https://coderwall.com/p/eurvaq/tesseract-with-andoird-and-gradle</a><br><a href="http://www.kaustubhraghavan.com/ocr.html" target="_blank" rel="external">http://www.kaustubhraghavan.com/ocr.html</a><br><a href="http://hellosure.github.io/ocr/2014/10/11/tesseract-ocr/" target="_blank" rel="external">http://hellosure.github.io/ocr/2014/10/11/tesseract-ocr/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/01/02/android-studio-tess-two/" data-id="ciygo85p4000c3x13ga9v52rs" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/01/02/android-studio-tess-two/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-migrate-to-hexo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/09/22/migrate-to-hexo/" class="article-date">
  <time datetime="2015-09-22T11:57:54.000Z" itemprop="datePublished">2015-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/22/migrate-to-hexo/">åšå®¢è¿ç§»åˆ°Hexo</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>æœ€è¿‘åœ¨å­¦nodejsï¼Œ é¡ºä¾¿ä¹ŸæŠŠåšå®¢ä»pelicanæ¢æˆ<a href="https://hexo.io/zh-cn/" target="_blank" rel="external">Hexo</a>ã€‚Hexoçš„å®‰è£…é…ç½®éƒ½éå¸¸æ–¹ä¾¿ï¼Œæ˜“ç”¨æ€§å¾ˆå¥½ï¼Œéå¸¸æ¨èã€‚åé¢ä¹Ÿä¸æƒ³å†æŠ˜è…¾äº†ï¼Œæ‹¿è¿™ç²¾åŠ›æ—¶é—´å¤šå†™äº›åšå®¢æ‰æ˜¯æ­£é“ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2015/09/22/migrate-to-hexo/" data-id="ciygo85oq00073x13fya2ipzo" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2015/09/22/migrate-to-hexo/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <a href="/" class="logo">STep by STep</a>
      &copy; 2017 Sine Yuan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    
<script>
  var disqus_shortname = 'sineyuansblog';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/jquery.scrollLoading.js" type="text/javascript"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>