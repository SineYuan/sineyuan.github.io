<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>STep by STep</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="STep by STep">
<meta property="og:url" content="http://sineyuan.github.io/index.html">
<meta property="og:site_name" content="STep by STep">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="STep by STep">
<meta name="twitter:description">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
  <!-- <link href="//fonts.useso.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css"> -->
  <!-- <link href='//fonts.useso.com/css?family=Open+Sans:300,600' rel='stylesheet' type='text/css'> -->
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <a href="/" class="logo">STep by STep</a>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about/index.html">About</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://sineyuan.github.io"></form>
        </div>
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
        
        
          <a id="nav-github-link" class="nav-icon" href="https://github.com/SineYuan" title="Fork me on GitHub"></a>
        
      </nav>
    </div>
  </div>
</header>
      <nav id="mobile-nav" class="off">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about/index.html" class="mobile-nav-link">About</a>
  
  <div id="search-form-wrap-mobile">
    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://sineyuan.github.io"></form>
  </div>
</nav>
      <div class="outer">
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/12/09/clickhouse-source-guide/">Clickhouse源码导读</a>
          </li>
        
          <li>
            <a href="/2018/01/14/clickhouse-kafka/">从kafka导入数据到Clickhouse</a>
          </li>
        
          <li>
            <a href="/2017/12/29/clickhouse-docker-quick-start/">用Docker快速上手Clickhouse</a>
          </li>
        
          <li>
            <a href="/2017/03/16/mxnet-begin/">MXNet上手</a>
          </li>
        
          <li>
            <a href="/2017/03/02/tensorflow-mnist-pratice/">Tensorflow Mnist手写数字识别Go实战</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://hexo.io">Hexo</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
        <section id="main">
  
    <article id="post-clickhouse-source-guide" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/09/clickhouse-source-guide/" class="article-date">
  <time datetime="2018-12-08T16:00:00.000Z" itemprop="datePublished">2018-12-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/09/clickhouse-source-guide/">Clickhouse源码导读</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Clickhouse源码导读">Clickhouse源码导读</h1><p>ClickHouse 是一个由俄罗斯搜索巨头Yandex开源的分布式列存储OLAP数据库。最突出的特点有特点就是一个快字。为了搞懂Clickhouse为什么快，我粗略的看了看Clickhouse的源码，总结一份导读指南，方便他人探索。</p>
<h2 id="基本流程">基本流程</h2><p>先从<a href="https://github.com/yandex/ClickHouse" target="_blank" rel="external">github</a>下载源码看看，本文内容基于 <code>v18.14.17-stable</code> 版本。Clickhouse整个项目的结构还是很清晰的，入口的 main函数在 <code>dbms/programs/main.cpp</code>。主程序会根据指令分发到 <code>dbms/programs</code> 目录下的程序中处理。我们主要关注 <code>clickhouse server</code>，所以直接来到 <code>dbms/programs/server/Server.cpp</code>，一路走下来解析参数配置，初始化server，再启动服务监听端口。</p>
<p>clickhouse 使用的是 <a href="https://pocoproject.org/" target="_blank" rel="external"><code>poco</code></a> 这个网络库来处理网络请求，每个client连接的处理逻辑在 <code>dbms/programs/server/TCPHandler.cpp</code>的<code>TCPHandler::runImpl()</code>方法里面。除去握手，初始化上下文，异常处理和数据统计的代码，主要的业务可以抽象成:</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// dbms/programs/server/TCPHandler.cpp</span><br><span class="line"></span><br><span class="line">TCPHandler.runImpl()</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    while(<span class="number">1</span>) &#123;</span><br><span class="line">        receivePacket()</span><br><span class="line"></span><br><span class="line">        /// Processing Query</span><br><span class="line">        <span class="keyword">state</span>.io = executeQuery(<span class="keyword">state</span>.query, query_context, false, <span class="keyword">state</span>.stage);</span><br><span class="line"></span><br><span class="line">        if (<span class="keyword">state</span>.io.<span class="keyword">out</span>)</span><br><span class="line">            <span class="keyword">state</span>.need_receive_data_for_insert = true;</span><br><span class="line"></span><br><span class="line">        if (<span class="keyword">state</span>.need_receive_data_for_insert)</span><br><span class="line">            processInsertQuery(global_settings);</span><br><span class="line">        else</span><br><span class="line">            processOrdinaryQuery();</span><br><span class="line"></span><br><span class="line">    ...     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client发送的sql在 <code>executeQuery</code> 函数处理，<code>processInsertQuery</code> 和 <code>processOrdinaryQuery</code> 负责将结果返回给client。</p>
<p><code>executeQuery</code> 函数的实现在<code>dbms/src/Interpreters/executeQuery.cpp</code>, 主要逻辑简化如下：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dbms/src/Interpreters/executeQuery<span class="built_in">.</span>cpp </span><br><span class="line"></span><br><span class="line">executeQueryImpl(<span class="attribute">...</span>)</span><br><span class="line">&#123;	</span><br><span class="line">	<span class="attribute">...</span></span><br><span class="line">	ast = parseQuery(parser, begin, end, <span class="string">""</span>, max_query_size);</span><br><span class="line">	<span class="attribute">...</span></span><br><span class="line"></span><br><span class="line">	auto interpreter = InterpreterFactory<span class="tag">::get</span>(ast, context, stage);</span><br><span class="line">    res = interpreter<span class="subst">-&gt;</span>execute();</span><br><span class="line"></span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类比 mysql 的处理流程，先解析sql语句生成抽象语法树(AST)，<code>InterpreterFactory</code>工厂类根据AST生成 执行器<code>Interpreter</code>类实例来执行。</p>
<p><code>interpreter-&gt;execute()</code> 返回到结果 <code>res</code> 是一个 <code>BlockIO</code>, <code>BlockIO</code> 其实就是一个 <code>BlockInputStream</code>和<code>BlockOutputStream</code>的一个封装。这里就引出了 Clickhouse 里面的一些重要概念。 </p>
<h2 id="Block和Block_Stream">Block和Block Stream</h2><p>Clickhouse是面向OLAP的列存储数据库系统，数据的存储和读写都是批量处理的。根据<a href="https://clickhouse.yandex/docs/zh/development/architecture/#block" target="_blank" rel="external">文档</a>, 一个<code>Block</code>代表着一批的数据，内部是用列来划分的，也就是一个<code>(IColumn, IDataType, column name)</code>三元组的集合。Clickhouse 的数据处理都是以Block为单位的，而Clickhouse的高性能也得益于能够使用向量化技术一次批量的处理一个Block里同类型的数据。 </p>
<p>而 <code>Block Stream</code>就是一个个 <code>Block</code> 组成的数据流。<code>Block Stream</code>分为两种，负责数据写入的实现 <code>IBlockOutputStream</code>接口，通过<code>write</code>方法写入一个<code>Block</code>。负责数据读取的实现 <code>IBlockInputStream</code>接口，通过<code>read</code>方法读取一个<code>Block</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dbms/src/DataStreams/IBlockOutputStream.h</span></span><br><span class="line"><span class="keyword">class</span> IBlockOutputStream : <span class="keyword">private</span> boost::noncopyable</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Write block.</span><br><span class="line">      */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">const</span> Block &amp; block)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dbms/src/DataStreams/IBlockInputStream.h</span></span><br><span class="line"><span class="keyword">class</span> IBlockInputStream : <span class="keyword">private</span> boost::noncopyable</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    IBlockInputStream() &#123;&#125;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Read next block.</span><br><span class="line">      * If there are no more blocks, return an empty block (for which operator `bool` returns false).</span><br><span class="line">      * <span class="doctag">NOTE:</span> Only one thread can read from one instance of IBlockInputStream simultaneously.</span><br><span class="line">      * This also applies for readPrefix, readSuffix.</span><br><span class="line">      */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Block <span class="title">read</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不同的Stream可以组合起来完成数据的转化。比如最初的 <code>IBlockInputStream</code>外层套一个 <code>FilterBlockInputStream</code>过滤掉不符合条件的数据，再接一个<code>AggregatingBlockInputStream</code>将原始数据聚合给下一个 <code>IBlockInputStream</code>。其实<code>Block Stream</code>类似<code>TiDB</code>里面的算子, 或者类比<code>Python</code>的迭代器，最外层不断调用 <code>read</code>/<code>write</code>方法驱动整个计算的进行。</p>
<p>下面我们追踪最简单的数据写入Insert过程和查询Select过程讲讲相关的代码。</p>
<h2 id="写入">写入</h2><p>让我们回到<code>InterpreterFactory</code>, Insert语句对应<code>InterpreterInsertQuery</code>这个执行器。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dbms/src/Interpreters/InterpreterFactory.cpp</span></span><br><span class="line"></span><br><span class="line">InterpreterFactory::get() </span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (typeid_cast&lt;ASTSelectQuery *&gt;(query.get()))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/// This is internal part of ASTSelectWithUnionQuery.</span></span><br><span class="line">        <span class="comment">/// Even if there is SELECT without union, it is represented by ASTSelectWithUnionQuery with single ASTSelectQuery as a child.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">std</span>::make_unique&lt;InterpreterSelectQuery&gt;(query, context, Names&#123;&#125;, stage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (typeid_cast&lt;ASTSelectWithUnionQuery *&gt;(query.get()))</span><br><span class="line">    &#123;</span><br><span class="line">        ProfileEvents::increment(ProfileEvents::SelectQuery);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">std</span>::make_unique&lt;InterpreterSelectWithUnionQuery&gt;(query, context, Names&#123;&#125;, stage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (typeid_cast&lt;ASTInsertQuery *&gt;(query.get()))</span><br><span class="line">    &#123;</span><br><span class="line">        ProfileEvents::increment(ProfileEvents::InsertQuery);</span><br><span class="line">        <span class="comment">/// readonly is checked inside InterpreterInsertQuery</span></span><br><span class="line">        <span class="keyword">bool</span> allow_materialized = <span class="keyword">static_cast</span>&lt;<span class="keyword">bool</span>&gt;(context.getSettingsRef().insert_allow_materialized_columns);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">std</span>::make_unique&lt;InterpreterInsertQuery&gt;(query, context, allow_materialized);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ....... <span class="comment">// 分发</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dbms/src/Interpreters/InterpreterInsertQuery.cpp</span></span><br><span class="line"></span><br><span class="line">StoragePtr InterpreterInsertQuery::getTable(<span class="keyword">const</span> ASTInsertQuery &amp; <span class="keyword">query</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">query</span>.table_function)</span><br><span class="line">    &#123;</span><br><span class="line">        auto table_function = typeid_cast&lt;<span class="keyword">const</span> ASTFunction *&gt;(<span class="keyword">query</span>.table_function.<span class="literal">get</span>());</span><br><span class="line">        <span class="keyword">const</span> auto &amp; factory = TableFunctionFactory::instance();</span><br><span class="line">        <span class="keyword">return</span> factory.<span class="literal">get</span>(table_function-&gt;name, context)-&gt;execute(<span class="keyword">query</span>.table_function, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Into what table to write.</span></span><br><span class="line">    <span class="keyword">return</span> context.getTable(<span class="keyword">query</span>.database, <span class="keyword">query</span>.<span class="keyword">table</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BlockIO InterpreterInsertQuery::execute()</span><br><span class="line">&#123;</span><br><span class="line">	... </span><br><span class="line">	StoragePtr <span class="keyword">table</span> = getTable(<span class="keyword">query</span>);</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">out</span> = std::make_shared&lt;PushingToViewsBlockOutputStream&gt;(<span class="keyword">query</span>.database, <span class="keyword">query</span>.<span class="keyword">table</span>, <span class="keyword">table</span>, context, query_ptr, <span class="keyword">query</span>.no_destination);</span><br><span class="line">	...	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PushingToViewsBlockOutputStream</code>的会先写入更低层的<code>BlockOutputStream</code>, 然后查看一下写入的数据源是否有 <code>MaterialView</code>,若有，调用<code>process</code>方法用<code>MaterializingBlockInputStream</code>往相关的<code>MaterialView</code>写入数据。而<code>PushingToViewsBlockOutputStream</code>更低层的<code>BlockOutputStream</code>是 <code>getTable</code> 方法获取的<code>IStorage</code>对象提供的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dbms/src/Storages/IStorage.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> IStorage : <span class="keyword">public</span> <span class="built_in">std</span>::enable_shared_from_this&lt;IStorage&gt;, <span class="keyword">private</span> boost::noncopyable, <span class="keyword">public</span> ITableDeclaration</span><br><span class="line">&#123;</span><br><span class="line">	....</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> BlockOutputStreamPtr <span class="title">write</span><span class="params">(</span><br><span class="line">        <span class="keyword">const</span> ASTPtr &amp; <span class="comment">/*query*/</span>,</span><br><span class="line">        <span class="keyword">const</span> Settings &amp; <span class="comment">/*settings*/</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> Exception(<span class="string">"Method write is not supported by storage "</span> + getName(), ErrorCodes::NOT_IMPLEMENTED);</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> BlockInputStreams <span class="title">read</span><span class="params">(</span><br><span class="line">        <span class="keyword">const</span> Names &amp; <span class="comment">/*column_names*/</span>,</span><br><span class="line">        <span class="keyword">const</span> SelectQueryInfo &amp; <span class="comment">/*query_info*/</span>,</span><br><span class="line">        <span class="keyword">const</span> Context &amp; <span class="comment">/*context*/</span>,</span><br><span class="line">        QueryProcessingStage::Enum <span class="comment">/*processed_stage*/</span>,</span><br><span class="line">        size_t <span class="comment">/*max_block_size*/</span>,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="comment">/*num_streams*/</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> Exception(<span class="string">"Method read is not supported by storage "</span> + getName(), ErrorCodes::NOT_IMPLEMENTED);</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>IStorage</code> 是Clickhouse存储引擎的接口，我们直接看最关键的 <code>MergeTree</code>引擎的实现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dbms/src/Storages/StorageMergeTree.cpp</span></span><br><span class="line"></span><br><span class="line">BlockOutputStreamPtr StorageMergeTree::write(<span class="keyword">const</span> ASTPtr &amp; <span class="comment">/*query*/</span>, <span class="keyword">const</span> Settings &amp; <span class="comment">/*settings*/</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::make_shared&lt;MergeTreeBlockOutputStream&gt;(*<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">dbms</span>/src/Storages/MergeTree/MergeTreeBlockOutputStream.cpp</span><br><span class="line"></span><br><span class="line"><span class="label">void</span> MergeTreeBlockOutputStream::write(const <span class="keyword">Block </span>&amp; <span class="keyword">block)</span><br><span class="line"></span>&#123;</span><br><span class="line">    storage<span class="preprocessor">.data</span>.delayInsertOrThrowIfNeeded()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    auto part_blocks = storage.writer.splitBlockIntoParts(<span class="keyword">block);</span><br><span class="line"></span>    for (auto &amp; current_block : part_blocks)</span><br><span class="line">    &#123;</span><br><span class="line">        Stopwatch watch<span class="comment">;</span></span><br><span class="line"><span class="label"></span><br><span class="line">        MergeTreeData:</span>:MutableDataPartPtr part = storage.writer.writeTempPart(current_block)<span class="comment">;</span></span><br><span class="line">        storage<span class="preprocessor">.data</span>.renameTempPartAndAdd(part, &amp;storage.increment)<span class="comment">;</span></span><br><span class="line"><span class="label"></span><br><span class="line">        PartLog:</span>:<span class="keyword">addNewPart(storage.context, </span>part, watch.elapsed())<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        /// Initiate async merge - <span class="keyword">it </span>will <span class="keyword">be </span>done <span class="preprocessor">if</span> <span class="keyword">it's </span>good time for merge <span class="keyword">and </span><span class="preprocessor">if</span> there are <span class="preprocessor">space</span> in <span class="string">'background_pool'</span>.</span><br><span class="line">        storage.<span class="keyword">background_task_handle-&gt;wake();</span><br><span class="line"></span>    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>追踪到最底层的 <code>MergeTreeBlockOutputStream</code> 我们会发现最终数据由<code>MergeTreeDataWriter</code>(<code>dbms/src/Storages/MergeTree/MergeTreeDataWriter.h</code>)写入，而<code>MergeTreeDataWriter</code>是<code>MergeTreeData</code>(<code>dbms/src/Storages/MergeTree/MergeTreeData.h</code>)的封装，<code>MergeTree</code>的数据都由<code>MergeTreeData</code>对象管理。存储的格式可以看看<a href="http://jackpgao.github.io/2017/12/06/ClickHouse-Primary-key/" target="_blank" rel="external">这篇文章</a>，后面可能会另写文再说说。</p>
<p><code>MergeTreeBlockOutputStream</code>一次写入一个<code>Block</code>,然后会唤醒后台任务将一个个小的<code>Block</code>合并。这应该就是<code>MergeTree</code>命名的由来了。由此我们可知，Clickhouse应尽可能的批量写入数据而不是一条一条的写。</p>
<p>最后再回来往上走，看看是在哪里调用最外层的 <code>write</code>方法写入的。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">void TCPHandler::processInsertQuery(const Settings &amp; global_settings)</span><br><span class="line">&#123;</span><br><span class="line">    /** Made above the rest of the lines, so that <span class="keyword">in</span> case of `writePrefix` function throws an exception,</span><br><span class="line">      *  client receive exception before sending data.</span><br><span class="line">      */</span><br><span class="line">    <span class="keyword">state</span>.io.out-&gt;writePrefix();</span><br><span class="line"></span><br><span class="line">    /// Send <span class="built_in">block</span> <span class="keyword">to</span> the client - <span class="built_in">table</span> structure.</span><br><span class="line">    Block <span class="built_in">block</span> = <span class="keyword">state</span>.io.out-&gt;getHeader();</span><br><span class="line">    sendData(<span class="built_in">block</span>);</span><br><span class="line"></span><br><span class="line">    readData(global_settings);    <span class="variable">&lt;--- here</span><br><span class="line">    state.io.out-&gt;</span>writeSuffix();</span><br><span class="line">    <span class="keyword">state</span>.io.<span class="keyword">on</span>Finish();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void TCPHandler::readData(const Settings &amp; global_settings)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	receiveData()</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool TCPHandler::receiveData()</span><br><span class="line">&#123;</span><br><span class="line">   	... </span><br><span class="line">    /// Read one <span class="built_in">block</span> <span class="keyword">from</span> the network and write it down</span><br><span class="line">    Block <span class="built_in">block</span> = <span class="keyword">state</span>.block_in-&gt;read();</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">        if (<span class="built_in">block</span>)</span><br><span class="line">            <span class="keyword">state</span>.io.out-&gt;write(<span class="built_in">block</span>);</span><br><span class="line">        return true;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="读取">读取</h2><p>读取最外层<code>BlockStream</code>的地方就在<code>processOrdinaryQuery</code>。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// dbms/programs/server/TCPHandler.cpp</span><br><span class="line"></span><br><span class="line">void TCPHandler::processOrdinaryQuery()</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	....</span><br><span class="line">	AsynchronousBlockInputStream async_in(<span class="keyword">state</span>.io.<span class="keyword">in</span>);</span><br><span class="line">	...</span><br><span class="line">	<span class="built_in">block</span> = async_in.read();</span><br><span class="line">	...</span><br><span class="line">	sendData(<span class="built_in">block</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在前面的<code>InterpreterFactory::get</code>方法可以看到Select语句会在初始化<code>InterpreterSelectQuery</code>, 于是我们来到<code>InterpreterSelectQuery.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">dbms/src/Interpreters/InterpreterSelectQuery.cpp</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InterpreterSelectQuery::executeImpl(....)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">auto</span> optimize_prewhere = [&amp;](<span class="keyword">auto</span> &amp; merge_tree)</span><br><span class="line">        &#123;</span><br><span class="line">            SelectQueryInfo query_info;</span><br><span class="line">            query_info.query = query_ptr;</span><br><span class="line">            query_info.sets = query_analyzer-&gt;getPreparedSets();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/// Try transferring some condition from WHERE to PREWHERE if enabled and viable</span></span><br><span class="line">            <span class="keyword">if</span> (settings.optimize_move_to_prewhere &amp;&amp; query.where_expression &amp;&amp; !query.prewhere_expression &amp;&amp; !query.final())</span><br><span class="line">                MergeTreeWhereOptimizer&#123;query_info, context, merge_tree.getData(), query_analyzer-&gt;getRequiredSourceColumns(), <span class="built_in">log</span>&#125;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">	AnalysisResult expressions;	</span><br><span class="line"></span><br><span class="line">	expressions = analyzeExpressions(from_stage, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Read the data from Storage. from_stage - to what stage the request was completed in Storage. */</span></span><br><span class="line">    executeFetchColumns(from_stage, pipeline, expressions.prewhere_info, expressions.columns_to_remove_after_prewhere);</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">if</span> (expressions.has_where)</span><br><span class="line">        executeWhere(pipeline, expressions.before_where, expressions.remove_where_filter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (expressions.need_aggregate)</span><br><span class="line">        executeAggregation(pipeline, expressions.before_aggregation, aggregate_overflow_row, aggregate_final);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        executeExpression(pipeline, expressions.before_order_and_select);</span><br><span class="line">        executeDistinct(pipeline, <span class="literal">true</span>, expressions.selected_columns);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!expressions.second_stage &amp;&amp; !expressions.need_aggregate &amp;&amp; !expressions.has_having)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (expressions.has_order_by)</span><br><span class="line">            executeOrder(pipeline);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (expressions.has_order_by &amp;&amp; query.limit_length)</span><br><span class="line">            executeDistinct(pipeline, <span class="literal">false</span>, expressions.selected_columns);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (query.limit_length)</span><br><span class="line">            executePreLimit(pipeline);</span><br><span class="line">     .....       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，最底层的<code>IBlockInputStream</code>通过<code>executeFetchColumns</code>方法从<code>storage</code>里面读取出来。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void <span class="constant">InterpreterSelectQuery:</span><span class="symbol">:executeFetchColumns</span>(...)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	pipeline.streams = storage-&gt;read(required_columns, query_info, context, processing_stage, max_block_size, max_streams);</span><br><span class="line"></span><br><span class="line">	if (pipeline.streams.empty())</span><br><span class="line">        &#123;</span><br><span class="line">            pipeline.streams.emplace_back(<span class="symbol">std:</span><span class="symbol">:make_shared&lt;NullBlockInputStream&gt;</span>(storage-&gt;getSampleBlockForColumns(required_columns)));</span><br><span class="line"></span><br><span class="line">            if (query_info.prewhere_info)</span><br><span class="line">                pipeline.streams.back() = <span class="symbol">std:</span><span class="symbol">:make_shared&lt;FilterBlockInputStream&gt;</span>(</span><br><span class="line">                        pipeline.streams.back(), prewhere_info-&gt;prewhere_actions,</span><br><span class="line">                        prewhere_info-&gt;prewhere_column_name, prewhere_info-&gt;remove_prewhere_column</span><br><span class="line">                );</span><br><span class="line">        &#125;</span><br><span class="line">        ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟写入过程类似, StorageMergeTree调用封装了<code>MergeTreeData</code>的<code>MergeTreeDataSelectExecutor</code>的<code>read</code>方法从存储里面获取数据。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dbms/programs/src/Storages/StorageMergeTree.cpp</span></span><br><span class="line"></span><br><span class="line">BlockInputStreams StorageMergeTree::read(...)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> reader.<span class="title">read</span><span class="params">(column_names, query_info, context, max_block_size, num_streams, <span class="number">0</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到<code>InterpreterSelectQuery</code>, <code>executeFetchColumns</code>方法取出数据后会调用各种<code>executeXXX</code>方法再给套上各种数据处理的<code>BlockStream</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">void</span> InterpreterSelectQuery::executeWhere(Pipeline &amp; pipeline, <span class="keyword">const</span> ExpressionActionsPtr &amp; expression, <span class="keyword">bool</span> remove_fiter)</span><br><span class="line">&#123;</span><br><span class="line">    pipeline.transform([&amp;](<span class="keyword">auto</span> &amp; stream)</span><br><span class="line">    &#123;</span><br><span class="line">        stream = <span class="built_in">std</span>::make_shared&lt;FilterBlockInputStream&gt;(stream, expression, query.where_expression-&gt;getColumnName(), remove_fiter);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InterpreterSelectQuery::executeAggregation(Pipeline &amp; pipeline, <span class="keyword">const</span> ExpressionActionsPtr &amp; expression, <span class="keyword">bool</span> overflow_row, <span class="keyword">bool</span> final)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="高性能">高性能</h2><p>Clickhouse<a href="https://clickhouse.yandex/docs/zh/development/architecture" target="_blank" rel="external">文档</a>里面提到了Clickhouse高性能的秘密是vectorized query execution 和 runtime code generation，即向量化SIMD的运用和JIT。这两点是怎么体现的呢？</p>
<h3 id="JIT">JIT</h3><p>其实我们只要在代码里面搜<code>USE_EMBEDDED_COMPILER</code>这个编译宏就可以找出所有JIT相关的代码。最主要的地方在<code>dbms/src/Interpreters/ExpressionJIT.cpp</code>里面。</p>
<p>若是开启了<code>USE_EMBEDDED_COMPILER</code>， <code>compileFunctions</code>函数会将复杂的表达式即时编译成机器码执行, Clickhouse会缓存编译结果，由此提高性能。</p>
<h3 id="SIMD">SIMD</h3><p>SIMD (Single Instruction Multiple Data) 是一种采用一个控制器来控制多个处理器，同时对一组数据（又称“数据向量”）中的每一个分别执行相同的操作从而实现空间上的并行性的技术。简单来说就是一条指令处理多个数据，由此来提升性能。</p>
<p>SIMD技术需要CPU支持SIMD的指令集，如<a href="https://zh.wikipedia.org/wiki/MMX" target="_blank" rel="external">MMX</a>、<a href="https://zh.wikipedia.org/wiki/MMX" target="_blank" rel="external">SSE</a>、<a href="https://zh.wikipedia.org/wiki/AVX%E6%8C%87%E4%BB%A4%E9%9B%86" target="_blank" rel="external">AVX</a>。</p>
<p>Clickhouse使用的是SSE2，我们可以在代码里面搜<code>__SSE2__</code>这个编译宏找出所有SIMD相关的代码。Clickhouse在许多地方比如过滤，压缩，字符串处理函数等都有用到<code>__SSE2__</code>。比较多的地方还是在过滤，毕竟是最常用的场景。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2018/12/09/clickhouse-source-guide/" data-id="cjpny5rto000gjm13aghqfzhh" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2018/12/09/clickhouse-source-guide/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-clickhouse-kafka" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/14/clickhouse-kafka/" class="article-date">
  <time datetime="2018-01-13T16:00:00.000Z" itemprop="datePublished">2018-01-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/14/clickhouse-kafka/">从kafka导入数据到Clickhouse</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="从kafka导入数据到Clickhouse">从kafka导入数据到Clickhouse</h1><p>Kafka 是目前应用非常广泛的开源消息中间件，一个常用的的场景就是做数据总线收集各个服务的消息日志，下游各种数据服务订阅消费数据，生成各种报表或数据应用等。Clickhouse 的自带了 Kafka Engine，使得 Clickhouse 和 Kafka 的集成变得非常容易。</p>
<h2 id="创建_Kafka_表">创建 Kafka 表</h2><p>Clickhouse 的 Kafka Engine 可以将 Kafka 中的流映射成一个表，方便我们的后续处理。只要建表的时候制定</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">Kafka</span><span class="params">(broker_list, topic_list, group_name, format[, schema])</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>broker_list</code>: 逗号分隔的 Kafka broker 列表</li>
<li><code>topic_list</code>: 消费的topic</li>
<li><code>group_name</code>: consumer group 的id， 同一个 group_name 的 clickhouse 会在同一个 consumer group 消费数据</li>
<li><code>format</code>: kafka 消息的格式</li>
</ul>
<p>在前文的所述的3节点 clickhouse 集群上，在每一个节点都建一个 Kafka Engine 的表从 kafka 的events topic读数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> event_stream (ts UInt64, tag <span class="keyword">String</span>, cnt Int64, val <span class="keyword">Double</span>) </span><br><span class="line"><span class="keyword">ENGINE</span> = Kafka(<span class="string">'127.0.0.1:9092'</span>, <span class="string">'events'</span>, <span class="string">'group1'</span>, <span class="string">'JSONEachRow'</span>);</span></span><br></pre></td></tr></table></figure>
<h2 id="写入数据">写入数据</h2><p>现在我们试着往 kafka 写一点数据</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-<span class="built_in">list</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9092</span> --topic events</span><br><span class="line"></span><br><span class="line">&gt;&#123;<span class="string">"ts"</span>:<span class="number">1515897449</span>,<span class="string">"tag"</span>:<span class="string">"aa"</span>,<span class="string">"cnt"</span>:<span class="number">3</span>,<span class="string">"val"</span>:<span class="number">0.7</span>&#125;</span><br><span class="line">&gt;&#123;<span class="string">"ts"</span>:<span class="number">1515897450</span>,<span class="string">"tag"</span>:<span class="string">"bb"</span>,<span class="string">"cnt"</span>:<span class="number">9</span>,<span class="string">"val"</span>:<span class="number">0.28</span>&#125;</span><br><span class="line">&gt;&#123;<span class="string">"ts"</span>:<span class="number">1515897451</span>,<span class="string">"tag"</span>:<span class="string">"cc"</span>,<span class="string">"cnt"</span>:<span class="number">7</span>,<span class="string">"val"</span>:<span class="number">0.93</span>&#125;</span><br><span class="line">&gt;&#123;<span class="string">"ts"</span>:<span class="number">1515897452</span>,<span class="string">"tag"</span>:<span class="string">"dd"</span>,<span class="string">"cnt"</span>:<span class="number">1</span>,<span class="string">"val"</span>:<span class="number">0.78</span>&#125;</span><br></pre></td></tr></table></figure>
<p>然后在每个 clickhose 节点中查看数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> event_stream;</span></span><br></pre></td></tr></table></figure>
<p><code>clickhouse-server-01</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌─────────ts─┬─tag─┬─cnt─┬────────────────val─┐</span><br><span class="line">│ <span class="number">1515897449</span> │ aa  │   <span class="number">3</span> │ <span class="number">0.7000000000000001</span> │</span><br><span class="line">└────────────┴─────┴─────┴────────────────────┘</span><br><span class="line">┌─────────ts─┬─tag─┬─cnt─┬──val─┐</span><br><span class="line">│ <span class="number">1515897452</span> │ dd  │   <span class="number">1</span> │ <span class="number">0.78</span> │</span><br><span class="line">└────────────┴─────┴─────┴──────┘</span><br></pre></td></tr></table></figure>
<p><code>clickhouse-server-02</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌─────────ts─┬─tag─┬─cnt─┬──val─┐</span><br><span class="line">│ <span class="number">1515897450</span> │ bb  │   <span class="number">9</span> │ <span class="number">0.28</span> │</span><br><span class="line">└────────────┴─────┴─────┴──────┘</span><br></pre></td></tr></table></figure>
<p><code>clickhouse-server-03</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌─────────ts─┬─tag─┬─cnt─┬──val─┐</span><br><span class="line">│ <span class="number">1515897451</span> │ cc  │   <span class="number">7</span> │ <span class="number">0.93</span> │</span><br><span class="line">└────────────┴─────┴─────┴──────┘</span><br></pre></td></tr></table></figure>
<p>注意的是由于一个kafka的partition 只能由一个 group consumer 消费，所以clickhouse 节点数需要大于 topic 的 partition 数。</p>
<p>由于 Kafka 表只是 kafka 流的一个视图而已，当数据被 select 了一次之后，这个数据就会被认为已经消费了，下次 select 就不会再出现。所以Kafka表单独使用是没什么用的，一般是用来和 MaterialView 配合，将Kafka表里面的数据自动导入到 MaterialView 里面。</p>
<h2 id="与_MaterialView_集成">与 MaterialView 集成</h2><p>我们现在每一节点建一个 MaterialView 保存 Kafka 里面的数据, 再顺手建一个全局的Distributed表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">MATERIALIZED</span> <span class="keyword">VIEW</span> <span class="keyword">events</span> <span class="keyword">ENGINE</span> = MergeTree(<span class="keyword">day</span>, (<span class="keyword">day</span>,ts, tag, cnt, val), <span class="number">8192</span>) <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> toDate(toDateTime(ts)) <span class="keyword">AS</span> <span class="keyword">day</span>, ts, tag, cnt, val <span class="keyword">FROM</span> event_stream;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> events_all <span class="keyword">AS</span> <span class="keyword">events</span></span><br><span class="line"><span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(perftest_3shards_1replicas, <span class="keyword">default</span>, <span class="keyword">events</span>, <span class="keyword">rand</span>());</span></span><br></pre></td></tr></table></figure>
<p>再往Kafka里面写些数据，就能在各个节点的 events 或 events_all 里面查出来了。</p>
<h2 id="总结">总结</h2><p>clichouse 和 Kafka的配合可以说是十分的便利，只有配置好，clickhouse 从 kafka 读数据和写入都是如此的方便。不过还是有相当的局限性，因为目前对 kafka 数据格式的支持还是<a href="https://clickhouse.yandex/docs/en/formats/index.html" target="_blank" rel="external">有限</a>。如果能通过插件之类的扩展方式自定义format就好了。另外，clickhouse 是否保证数据的一致性，不重复不丢？详细的情况还需要进一步探究。</p>
<hr>
<p>参考资料</p>
<p><a href="https://clickhouse.yandex/tutorial.html" target="_blank" rel="external">https://clickhouse.yandex/tutorial.html</a><br><a href="https://clickhouse.yandex/docs/en/table_engines/kafka.html" target="_blank" rel="external">https://clickhouse.yandex/docs/en/table_engines/kafka.html</a>  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2018/01/14/clickhouse-kafka/" data-id="cjpny5rtp000hjm13jhfb1v54" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2018/01/14/clickhouse-kafka/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-clickhouse-docker-quick-start" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/29/clickhouse-docker-quick-start/" class="article-date">
  <time datetime="2017-12-28T16:00:00.000Z" itemprop="datePublished">2017-12-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/29/clickhouse-docker-quick-start/">用Docker快速上手Clickhouse</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="用Docker快速上手Clickhouse">用Docker快速上手Clickhouse</h1><p><a href="https://clickhouse.yandex/" target="_blank" rel="external">ClickHouse</a> 是一个由俄罗斯搜索巨头Yandex开源的分布式列存储OLAP数据库。主要的特点有</p>
<ul>
<li>非常快</li>
<li>分布式，高可用，线性拓展</li>
<li>功能强大</li>
</ul>
<p>看起来非常厉害的样子，但 Clickhouse 最吸引人的一点应该就是一个“快”字吧。但是骡子是马拉出来溜溜，让我们开始吧。</p>
<h2 id="单机">单机</h2><p>Clickhouse官方有提供 clickhouse 的<a href="https://hub.docker.com/r/yandex/clickhouse-server/" target="_blank" rel="external">docker镜像</a>, 只要简单运行</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name clickhouse-server --ulimit nofile=<span class="number">262144</span>:<span class="number">262144</span> -p <span class="number">9000</span>:<span class="number">9000</span> yandex/clickhouse-server:<span class="number">1.1</span></span><br></pre></td></tr></table></figure>
<p><code>clickhouse-server</code> 就可以跑起来了。但我们想有更多的控制项。</p>
<p>先将默认的配置拷贝出来</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir etc</span><br><span class="line">mkdir data</span><br><span class="line"></span><br><span class="line">docker run -it --rm --entrypoint=/bin/bash -v <span class="variable">$PWD</span>:/work --privileged=<span class="literal">true</span> --user=root yandex/clickhouse-server:<span class="number">1.1</span></span><br><span class="line">cp -r /etc/clickhouse-server/* /work/etc/</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p>再运行</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name clickhouse-server \</span><br><span class="line">	-<span class="ruby">-ulimit nofile=<span class="number">262144</span><span class="symbol">:</span><span class="number">262144</span> \</span><br><span class="line"></span>	-<span class="ruby">p <span class="number">9000</span><span class="symbol">:</span><span class="number">9000</span> \</span><br><span class="line"></span>	-<span class="ruby">v <span class="variable">$PWD</span><span class="symbol">:/etc/clickhouse-server</span> \</span><br><span class="line"></span>	-<span class="ruby">v <span class="variable">$PWD</span>/<span class="symbol">data:</span>/var/lib/clickhosue \</span><br><span class="line"></span>	-<span class="ruby">-privileged=<span class="keyword">true</span> --user=root \</span><br><span class="line"></span>	yandex/clickhouse-server:1.1</span><br></pre></td></tr></table></figure>
<p>clickhouse 跑起来之后，就可以去 <a href="https://clickhouse.yandex/tutorial.html" target="_blank" rel="external">官方教程</a> 那里玩一玩啦。</p>
<h2 id="集群部署">集群部署</h2><p>clickhouse性能再好，单机总是有上限的。但 clickhouse 可以通过集群分片来应对数据的增长。</p>
<p>用 docker-compose 我们可以很轻松的跑一个 clickhouse 集群。<br>下面我们来跑一个3节点分片的 clickhouse 集群</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir -<span class="tag">p</span> clickhouse-<span class="number">3s</span>hards/ch01</span><br><span class="line">mkdir -<span class="tag">p</span> clickhouse-<span class="number">3s</span>hards/ch02</span><br><span class="line">mkdir -<span class="tag">p</span> clickhouse-<span class="number">3s</span>hards/ch03</span><br><span class="line"></span><br><span class="line">mkdir -<span class="tag">p</span> clickhouse-<span class="number">3s</span>hards/ch01/data</span><br><span class="line">mkdir -<span class="tag">p</span> clickhouse-<span class="number">3s</span>hards/ch02/data</span><br><span class="line">mkdir -<span class="tag">p</span> clickhouse-<span class="number">3s</span>hards/ch03/data</span><br><span class="line"></span><br><span class="line">cp -r etc clickhouse-<span class="number">3s</span>hards/ch01/etc</span><br><span class="line">cp -r etc clickhouse-<span class="number">3s</span>hards/ch02/etc</span><br><span class="line">cp -r etc clickhouse-<span class="number">3s</span>hards/ch03/etc</span><br><span class="line"></span><br><span class="line">vim docker-compose.yaml</span><br></pre></td></tr></table></figure>
<p>配置 clickhouse 集群</p>
<p>为方便管理，我们将集群相关的配置拿出来，放在<code>metrika.xml</code>。在每个<code>config.xml</code>文件里面加入下面一行引入<code>metrika.xml</code>。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">include_from</span>&gt;</span>/etc/clickhouse-server/metrika.xml<span class="tag">&lt;/<span class="title">include_from</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>metrika.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">yandex</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">clickhouse_remote_servers</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 集群名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">perftest_3shards_1replicas</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 分片地址 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">shard</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="title">internal_replication</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">host</span>&gt;</span>clickhouse01<span class="tag">&lt;/<span class="title">host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="title">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">shard</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">shard</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="title">internal_replication</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">replica</span>&gt;</span> </span><br><span class="line">                <span class="tag">&lt;<span class="title">host</span>&gt;</span>clickhouse02<span class="tag">&lt;/<span class="title">host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="title">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">shard</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">shard</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="title">internal_replication</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">host</span>&gt;</span>clickhouse03<span class="tag">&lt;/<span class="title">host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="title">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">perftest_3shards_1replicas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">clickhouse_remote_servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 宏配置，用于分布式建表时做替换，每个节点配置不能相同 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">macros</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">shard</span>&gt;</span>01<span class="tag">&lt;/<span class="title">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">replica</span>&gt;</span>01<span class="tag">&lt;/<span class="title">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">macros</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">networks</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">ip</span>&gt;</span>::/0<span class="tag">&lt;/<span class="title">ip</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">networks</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">yandex</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>docker-compose.yaml</code></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">version</span>: <span class="string">'2'</span></span><br><span class="line"></span><br><span class="line"><span class="less"><span class="attribute">services</span>:</span><br><span class="line">  <span class="attribute">clickhouse01</span>:</span><br><span class="line">    <span class="attribute">image</span>: yandex/<span class="attribute">clickhouse-server</span>:<span class="number">1.1</span></span><br><span class="line">    <span class="attribute">expose</span>:</span><br><span class="line">      - <span class="string">"9000"</span></span><br><span class="line">    <span class="attribute">user</span>: root</span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="string">"9001:9000"</span></span><br><span class="line">    <span class="attribute">volumes</span>:</span><br><span class="line">      - ./ch01/<span class="attribute">etc</span>:/etc/clickhouse-server </span><br><span class="line">      - ./ch01/<span class="attribute">data</span>:/var/lib/clickhouse</span><br><span class="line">    <span class="attribute">ulimits</span>:</span><br><span class="line">      <span class="attribute">nofile</span>:</span><br><span class="line">        <span class="attribute">soft</span>: <span class="number">262144</span>  </span><br><span class="line">        <span class="attribute">hard</span>: <span class="number">262144</span>  </span><br><span class="line">    <span class="attribute">privileged</span>: true</span><br><span class="line"></span><br><span class="line">  <span class="attribute">clickhouse02</span>:</span><br><span class="line">    <span class="attribute">image</span>: yandex/<span class="attribute">clickhouse-server</span>:<span class="number">1.1</span></span><br><span class="line">    <span class="attribute">expose</span>:</span><br><span class="line">      - <span class="string">"9000"</span></span><br><span class="line">    <span class="attribute">user</span>: root</span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="string">"9002:9000"</span>  </span><br><span class="line">    <span class="attribute">volumes</span>:</span><br><span class="line">      - ./ch02/<span class="attribute">etc</span>:/etc/clickhouse-server </span><br><span class="line">      - ./ch02/<span class="attribute">data</span>:/var/lib/clickhouse</span><br><span class="line">    <span class="attribute">ulimits</span>:</span><br><span class="line">      <span class="attribute">nofile</span>:</span><br><span class="line">        <span class="attribute">soft</span>: <span class="number">262144</span>  </span><br><span class="line">        <span class="attribute">hard</span>: <span class="number">262144</span>  </span><br><span class="line">    <span class="attribute">privileged</span>: true</span><br><span class="line"></span><br><span class="line">  <span class="attribute">clickhouse03</span>:</span><br><span class="line">    <span class="attribute">image</span>: yandex/<span class="attribute">clickhouse-server</span>:<span class="number">1.1</span></span><br><span class="line">    <span class="attribute">expose</span>:</span><br><span class="line">      - <span class="string">"9000"</span></span><br><span class="line">    <span class="attribute">user</span>: root</span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="string">"9003:9000"</span>  </span><br><span class="line">    <span class="attribute">volumes</span>:</span><br><span class="line">      - ./ch03/<span class="attribute">etc</span>:/etc/clickhouse-server </span><br><span class="line">      - ./ch03/<span class="attribute">data</span>:/var/lib/clickhouse</span><br><span class="line">    <span class="attribute">ulimits</span>:</span><br><span class="line">      <span class="attribute">nofile</span>:</span><br><span class="line">        <span class="attribute">soft</span>: <span class="number">262144</span>  </span><br><span class="line">        <span class="attribute">hard</span>: <span class="number">262144</span>  </span><br><span class="line">    <span class="attribute">privileged</span>: true</span></span><br></pre></td></tr></table></figure>
<p>配置之后启动集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="operator">-d</span> up</span><br></pre></td></tr></table></figure>
<p>事不宜迟，我们来先在每个 clickhouse-server 上都建一个本地表和 Distributed 表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client <span class="comment">--port=9001</span></span><br><span class="line"># 其他clickhouse-server 同样处理</span><br><span class="line"># clickhouse-client <span class="comment">--port=9002</span></span><br><span class="line"># clickhouse-client <span class="comment">--port=9003</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> chtest_local (TDate <span class="built_in">Date</span>,<span class="keyword">Value</span> UInt16) <span class="keyword">ENGINE</span> = MergeTree(TDate, (<span class="keyword">Value</span>, TDate), <span class="number">8192</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> chtest_all <span class="keyword">AS</span> chtest_local <span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(perftest_3shards_1replicas, <span class="keyword">default</span>, chtest_local, <span class="keyword">rand</span>());</span></span><br></pre></td></tr></table></figure>
<p>在任意一台插入一些数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client <span class="comment">--port=9001</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> chtest_all (TDate,<span class="keyword">Value</span>) <span class="keyword">values</span> (<span class="string">'2017-12-25'</span>, <span class="number">111</span>);</span></span><br><span class="line"><span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> chtest_all (TDate,<span class="keyword">Value</span>) <span class="keyword">values</span> (<span class="string">'2017-12-25'</span>, <span class="number">222</span>);</span></span><br><span class="line"><span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> chtest_all (TDate,<span class="keyword">Value</span>) <span class="keyword">values</span> (<span class="string">'2017-12-26'</span>, <span class="number">333</span>);</span></span><br><span class="line"><span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> chtest_local (TDate,<span class="keyword">Value</span>) <span class="keyword">values</span> (<span class="string">'2017-12-26'</span>, <span class="number">444</span>);</span></span><br></pre></td></tr></table></figure>
<p>之后就可以查 chtest_all 获取全部都数据。注意的是写入 chtest_local 的数据也是可以在 chtest_all 查出来的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">:) select * from chtest_all;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM chtest_all </span><br><span class="line"></span><br><span class="line">┌──────TDate─┬─Value─┐</span><br><span class="line">│ <span class="number">2017</span>-<span class="number">12</span>-<span class="number">26</span> │   <span class="number">444</span> │</span><br><span class="line">└────────────┴───────┘</span><br><span class="line">┌──────TDate─┬─Value─┐</span><br><span class="line">│ <span class="number">2017</span>-<span class="number">12</span>-<span class="number">25</span> │   <span class="number">111</span> │</span><br><span class="line">└────────────┴───────┘</span><br><span class="line">┌──────TDate─┬─Value─┐</span><br><span class="line">│ <span class="number">2017</span>-<span class="number">12</span>-<span class="number">25</span> │   <span class="number">222</span> │</span><br><span class="line">└────────────┴───────┘</span><br><span class="line">┌──────TDate─┬─Value─┐</span><br><span class="line">│ <span class="number">2017</span>-<span class="number">12</span>-<span class="number">26</span> │   <span class="number">333</span> │</span><br><span class="line">└────────────┴───────┘</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> rows in <span class="built_in">set</span>. Elapsed: <span class="number">0.008</span> sec. </span><br><span class="line"></span><br><span class="line">:) select * from chtest_local;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM chtest_local </span><br><span class="line"></span><br><span class="line">┌──────TDate─┬─Value─┐</span><br><span class="line">│ <span class="number">2017</span>-<span class="number">12</span>-<span class="number">26</span> │   <span class="number">444</span> │</span><br><span class="line">└────────────┴───────┘</span><br><span class="line">┌──────TDate─┬─Value─┐</span><br><span class="line">│ <span class="number">2017</span>-<span class="number">12</span>-<span class="number">25</span> │   <span class="number">111</span> │</span><br><span class="line">└────────────┴───────┘</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> rows in <span class="built_in">set</span>. Elapsed: <span class="number">0.006</span> sec. </span><br><span class="line"></span><br><span class="line">:) select * from chtest_local;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM chtest_local </span><br><span class="line"></span><br><span class="line">┌──────TDate─┬─Value─┐</span><br><span class="line">│ <span class="number">2017</span>-<span class="number">12</span>-<span class="number">25</span> │   <span class="number">222</span> │</span><br><span class="line">└────────────┴───────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> rows in <span class="built_in">set</span>. Elapsed: <span class="number">0.005</span> sec. </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">:) select * from chtest_local;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM chtest_local </span><br><span class="line"></span><br><span class="line">┌──────TDate─┬─Value─┐</span><br><span class="line">│ <span class="number">2017</span>-<span class="number">12</span>-<span class="number">25</span> │   <span class="number">222</span> │</span><br><span class="line">└────────────┴───────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> rows in <span class="built_in">set</span>. Elapsed: <span class="number">0.005</span> sec.</span><br></pre></td></tr></table></figure>
<p>当我们任意分片挂掉的时候，是无法读的 Distributed 表的，当写入 Distributed 表是数据分片到挂了的服务时是会报错的。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="operator"><span class="keyword">stop</span> cluster3shards_clickhouse03_1</span><br><span class="line"></span><br><span class="line">clickhouse-<span class="keyword">client</span> <span class="comment">--port=9001</span></span></span><br></pre></td></tr></table></figure>
<h2 id="高可用集群">高可用集群</h2><p>在分布式系统里面，为保证服务的可用性，我们需要数据多副本存储。</p>
<p>clickhouse 的 数据副本同步需要用到 zookeeper，所以我们修改<code>docker-compose.yaml</code>，加多一个节点，配置成2个分片，2个副本的高可用集群。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">version</span>: <span class="string">'2'</span></span><br><span class="line"></span><br><span class="line"><span class="less"><span class="attribute">services</span>:</span><br><span class="line">  <span class="attribute">zookeeper</span>:</span><br><span class="line">    <span class="attribute">image</span>: <span class="attribute">zookeeper</span>:<span class="number">3.5</span></span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="string">"2181:2181"</span></span><br><span class="line">      - <span class="string">"2182:2182"</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">clickhouse01</span>:</span><br><span class="line">    <span class="attribute">image</span>: yandex/<span class="attribute">clickhouse-server</span>:<span class="number">1.1</span></span><br><span class="line">    <span class="attribute">expose</span>:</span><br><span class="line">      - <span class="string">"9000"</span></span><br><span class="line">    <span class="attribute">user</span>: root</span><br><span class="line">    <span class="attribute">privileged</span>: true</span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="string">"9001:9000"</span></span><br><span class="line">    <span class="attribute">volumes</span>:</span><br><span class="line">      - ./ch01/<span class="attribute">etc</span>:/etc/clickhouse-server </span><br><span class="line">      - ./ch01/<span class="attribute">data</span>:/var/lib/clickhouse</span><br><span class="line">    <span class="attribute">ulimits</span>:</span><br><span class="line">      <span class="attribute">nofile</span>:</span><br><span class="line">        <span class="attribute">soft</span>: <span class="number">262144</span>  </span><br><span class="line">        <span class="attribute">hard</span>: <span class="number">262144</span>  </span><br><span class="line">    <span class="attribute">depends_on</span>:</span><br><span class="line">      - <span class="string">"zookeeper"</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">clickhouse02</span>:</span><br><span class="line">    <span class="attribute">image</span>: yandex/<span class="attribute">clickhouse-server</span>:<span class="number">1.1</span></span><br><span class="line">    <span class="attribute">expose</span>:</span><br><span class="line">      - <span class="string">"9000"</span></span><br><span class="line">    <span class="attribute">user</span>: root</span><br><span class="line">    <span class="attribute">privileged</span>: true</span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="string">"9002:9000"</span>  </span><br><span class="line">    <span class="attribute">volumes</span>:</span><br><span class="line">      - ./ch02/<span class="attribute">etc</span>:/etc/clickhouse-server </span><br><span class="line">      - ./ch02/<span class="attribute">data</span>:/var/lib/clickhouse</span><br><span class="line">    <span class="attribute">ulimits</span>:</span><br><span class="line">      <span class="attribute">nofile</span>:</span><br><span class="line">        <span class="attribute">soft</span>: <span class="number">262144</span>  </span><br><span class="line">        <span class="attribute">hard</span>: <span class="number">262144</span>  </span><br><span class="line">    <span class="attribute">depends_on</span>:</span><br><span class="line">      - <span class="string">"zookeeper"</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">clickhouse03</span>:</span><br><span class="line">    <span class="attribute">image</span>: yandex/<span class="attribute">clickhouse-server</span>:<span class="number">1.1</span></span><br><span class="line">    <span class="attribute">expose</span>:</span><br><span class="line">      - <span class="string">"9000"</span></span><br><span class="line">    <span class="attribute">user</span>: root</span><br><span class="line">    <span class="attribute">privileged</span>: true  </span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="string">"9003:9000"</span>  </span><br><span class="line">    <span class="attribute">volumes</span>:</span><br><span class="line">      - ./ch03/<span class="attribute">etc</span>:/etc/clickhouse-server </span><br><span class="line">      - ./ch03/<span class="attribute">data</span>:/var/lib/clickhouse</span><br><span class="line">    <span class="attribute">ulimits</span>:</span><br><span class="line">      <span class="attribute">nofile</span>:</span><br><span class="line">        <span class="attribute">soft</span>: <span class="number">262144</span>  </span><br><span class="line">        <span class="attribute">hard</span>: <span class="number">262144</span>  </span><br><span class="line">    <span class="attribute">depends_on</span>:</span><br><span class="line">      - <span class="string">"zookeeper"</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">clickhouse04</span>:</span><br><span class="line">    <span class="attribute">image</span>: yandex/<span class="attribute">clickhouse-server</span>:<span class="number">1.1</span></span><br><span class="line">    <span class="attribute">expose</span>:</span><br><span class="line">      - <span class="string">"9000"</span></span><br><span class="line">    <span class="attribute">user</span>: root</span><br><span class="line">    <span class="attribute">privileged</span>: true    </span><br><span class="line">    <span class="attribute">ports</span>:</span><br><span class="line">      - <span class="string">"9004:9000"</span>  </span><br><span class="line">    <span class="attribute">volumes</span>:</span><br><span class="line">      - ./ch04/<span class="attribute">etc</span>:/etc/clickhouse-server </span><br><span class="line">      - ./ch04/<span class="attribute">data</span>:/var/lib/clickhouse</span><br><span class="line">    <span class="attribute">ulimits</span>:</span><br><span class="line">      <span class="attribute">nofile</span>:</span><br><span class="line">        <span class="attribute">soft</span>: <span class="number">262144</span>  </span><br><span class="line">        <span class="attribute">hard</span>: <span class="number">262144</span>  </span><br><span class="line">    <span class="attribute">depends_on</span>:</span><br><span class="line">      - <span class="string">"zookeeper"</span></span></span><br></pre></td></tr></table></figure>
<p>集群配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">yandex</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">clickhouse_remote_servers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">perftest_2shards_2replicas</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">shard</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="title">internal_replication</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">host</span>&gt;</span>clickhouse01<span class="tag">&lt;/<span class="title">host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="title">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">replica</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">host</span>&gt;</span>clickhouse03<span class="tag">&lt;/<span class="title">host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="title">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">shard</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">shard</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="title">internal_replication</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">host</span>&gt;</span>clickhouse02<span class="tag">&lt;/<span class="title">host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="title">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">replica</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">host</span>&gt;</span>clickhouse04<span class="tag">&lt;/<span class="title">host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="title">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">perftest_2shards_2replicas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">clickhouse_remote_servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">macros</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">shard</span>&gt;</span>01<span class="tag">&lt;/<span class="title">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">replica</span>&gt;</span>02<span class="tag">&lt;/<span class="title">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">macros</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">zookeeper-servers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">node</span> <span class="attribute">index</span>=<span class="value">"1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">host</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="title">host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="title">port</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">zookeeper-servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">networks</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">ip</span>&gt;</span>::/0<span class="tag">&lt;/<span class="title">ip</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">networks</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">yandex</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>集群起来之后，在每一个节点创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> chtest_local (TDate <span class="built_in">Date</span>,<span class="keyword">Value</span> UInt16) <span class="keyword">ENGINE</span> = MergeTree(TDate, (<span class="keyword">Value</span>, TDate), <span class="number">8192</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> chtest_replica (TDate <span class="built_in">Date</span>,<span class="keyword">Value</span> UInt16)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedMergeTree(</span><br><span class="line">    <span class="string">'/clickhouse_perftest/tables/&#123;shard&#125;/ontime'</span>,</span><br><span class="line">    <span class="string">'&#123;replica&#125;'</span>,</span><br><span class="line">    TDate,</span><br><span class="line">    (<span class="keyword">Value</span>, TDate),</span><br><span class="line">    <span class="number">8192</span>);</span></span><br><span class="line">    </span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> chtest_all <span class="keyword">AS</span> chtest_replica <span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(perftest_2shards_2replicas, <span class="keyword">default</span>, chtest_replica, <span class="keyword">rand</span>());</span></span><br></pre></td></tr></table></figure>
<p>后面再任意一台机器往 chtest_all 插入数据，可以看到ch01 与 ch03, ch02 与 ch04 都存有相同的数据。</p>
<h2 id="总结">总结</h2><p>总的来说 clickhouse 的体验还是很不错的。性能不错，分布式比较方便，开箱即用。不过 clickhouse 的集群管理方面还是很弱，没有一个中央的控制节点。例如增减节点需要更新所有节点的配置，需要自己弄一套管理的工具。</p>
<hr>
<p>参考资料</p>
<p><a href="https://clickhouse.yandex/tutorial.html" target="_blank" rel="external">https://clickhouse.yandex/tutorial.html</a><br><a href="http://www.cnblogs.com/gomysql/p/6708650.html" target="_blank" rel="external">http://www.cnblogs.com/gomysql/p/6708650.html</a><br><a href="http://jackpgao.github.io/2017/12/13/ClickHouse-Cluster-Beginning-to-End/" target="_blank" rel="external">http://jackpgao.github.io/2017/12/13/ClickHouse-Cluster-Beginning-to-End/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2017/12/29/clickhouse-docker-quick-start/" data-id="cjpny5rtq000ijm133l9op3ot" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2017/12/29/clickhouse-docker-quick-start/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-mxnet-begin" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/16/mxnet-begin/" class="article-date">
  <time datetime="2017-03-15T16:00:00.000Z" itemprop="datePublished">2017-03-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/16/mxnet-begin/">MXNet上手</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>折腾了一段时间Tensorflw后，感觉Tensorflow各方面都非常不错，无论是Tensorflow Serving还是TensorBoard，不得不说Google的大腿就是粗啊。不过Tensorflow在性能上的并不怎么好，训练的时间和内存占用都很高。不过Tensorflow 1.0后也加入了新的实验特性来提高性能，相信Tensorflow以后性能不会再是大的问题。穷人家的孩子还得节俭持家， 所以我把目光投向了MXNet。</p>
<p>MXNet是一个兼具性灵活和效率的深度学习框架。灵活指的是MXNet兼容声明式和指令式两种编程方式，可以很灵活的定义自己需要的东西。而效率则指MXNet在底层做了很多的优化(具体可以看<a href="https://github.com/dmlc/mxnet/blob/master/docs/zh/note_memory.md" target="_blank" rel="external">这篇文章</a>)，速度与内存消耗方面都做的很好。</p>
<p>不过相比Tensorflow，MXNet的上手难度要高，文档方面对新手还是不太友好。入门教程可以很快的跑一个MNIST识别的demo，但用高级的<code>module</code>封装了很多细节，当新手要自定义loss函数时往往不知所措。其实我觉得学习MXNet基本概念最开始要看的是<a href="http://mxnet.io/api/python/symbol_in_pictures.html" target="_blank" rel="external">Symbolic Configuration and Execution in Pictures</a>这篇文章。以这篇文章的例子来说<br><img src="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/symbol/executor_forward.png" alt="build process"></p>
<p>我们定义Symbol<code>A</code>,<code>B</code>,<code>C</code>,<code>D</code>,<code>E</code>，其中<code>A</code>, <code>B</code>, <code>D</code>为输入节点，<code>E</code>为输出节点，然后绑定输入数据<code>a</code>,<code>b</code>,<code>d</code>到<code>E</code>生成Executor， 最后Executor调用<code>forward</code>计算网络输出。</p>
<p>除了多一步绑定数据生成Executor，其他跟Tensorflow还是很像的，可以类比Tensorflow的</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">sess</span><span class="class">.run</span>(E, feed_dict=&#123;<span class="attribute">A</span>: a, <span class="attribute">B</span>: b, <span class="attribute">D</span>: d&#125;)</span><br></pre></td></tr></table></figure>
<p>当我们需要训练模型的时候，我们就需要计算模型中参数的梯度，计算梯度需要调用Executor的<code>backward</code>方法。<br><img src="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/symbol/executor_backward.png" alt="build process"></p>
<p>如上，绑定的时候通过<code>args_grad</code>对待求解参数输入一个空的<code>NDArray</code>用于存放梯度计算结果，新版MXNet的API和上图有些不同，如果需要计算梯度，调用<code>forward</code>时需要带上<code>is_train</code>参数</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">executor.<span class="function"><span class="title">forward</span><span class="params">(is_train=True)</span></span></span><br></pre></td></tr></table></figure>
<p>执行<code>forward</code>后再执行<code>backward</code>方法求解梯度，之后就能得到节点<code>A</code>的梯度<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">4</span>]: exec<span class="class">.grad_dict</span>[<span class="string">'A'</span>].<span class="function"><span class="title">asnumpy</span><span class="params">()</span></span></span><br><span class="line">Out[<span class="number">4</span>]: <span class="function"><span class="title">array</span><span class="params">([ <span class="number">4</span>.], dtype=float32)</span></span></span><br></pre></td></tr></table></figure></p>
<p>计算出梯度后我们就可以根据梯度更新模型参数，一遍一遍的迭代直到训练结束。</p>
<p>从上面的过程可以看出，<code>bind</code>这套api还是很低层的，很多东西都要我们手工完成，所以MXNet在这基础上提供了更高层的api方便开发。我们可以在MXNet项目代码的<code>example/module</code>中的demo里面学习基础用法，这里就直接copy过来</p>
<p>中等层次的api<br><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">##</span></span><br><span class="line"><span class="comment"># Intermediate-level API</span></span><br><span class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">##</span></span><br><span class="line">mod = mx.mod.Module(softmax)</span><br><span class="line">mod.bind(data_shapes=train_dataiter.provide_data, label_shapes=train_dataiter.provide_label)</span><br><span class="line">mod.init_params()</span><br><span class="line"></span><br><span class="line">mod.init_optimizer(optimizer_params=&#123;<span class="string">'learning_rate'</span>:<span class="number">0.01</span>, <span class="string">'momentum'</span>: <span class="number">0.9</span>&#125;)</span><br><span class="line">metric = mx.metric.create(<span class="string">'acc'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i_epoch <span class="keyword">in</span> range(n_epoch):</span><br><span class="line">    <span class="keyword">for</span> i_iter, batch <span class="keyword">in</span> enumerate(train_dataiter):</span><br><span class="line">        mod.forward(batch)</span><br><span class="line">        mod.update_metric(metric, batch.label)</span><br><span class="line"></span><br><span class="line">        mod.backward()</span><br><span class="line">        mod.update()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name, val <span class="keyword">in</span> metric.get_name_value():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'epoch %03d: %s=%f'</span> % (i_epoch, name, val))</span><br><span class="line">    metric.reset()</span><br><span class="line">    train_dataiter.reset()</span><br></pre></td></tr></table></figure></p>
<p>高级api，这个就很简单了</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">##</span></span><br><span class="line"><span class="comment"># High-level API</span></span><br><span class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">##</span></span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line">train_dataiter.reset()</span><br><span class="line">mod = mx.mod.Module(softmax)</span><br><span class="line">mod.fit(train_dataiter, eval_data=val_dataiter,</span><br><span class="line">        optimizer_params=&#123;<span class="string">'learning_rate'</span>:<span class="number">0.01</span>, <span class="string">'momentum'</span>: <span class="number">0.9</span>&#125;, num_epoch=n_epoch)</span><br></pre></td></tr></table></figure>
<p>总的来说个人感觉MXNet还是一个非常不错的框架, 开发社区也很活跃，目前有了AWS官方的支持，希望后面越来越好。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2017/03/16/mxnet-begin/" data-id="cjpny5rtf0009jm13cdtp76di" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2017/03/16/mxnet-begin/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-tensorflow-mnist-pratice" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/02/tensorflow-mnist-pratice/" class="article-date">
  <time datetime="2017-03-01T16:00:00.000Z" itemprop="datePublished">2017-03-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/02/tensorflow-mnist-pratice/">Tensorflow Mnist手写数字识别Go实战</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Tensflow安装好以后，当然要上手折腾一下啦。其实Tensorflow的入门教程很多地方都有，官方的Tutorials也写的很好。所以在这里记录一下本人折腾的过程，做一些补充。</p>
<h2 id="基础知识">基础知识</h2><p>首先学习Tensorflow的基本使用和关于神经网络的知识，这里推荐的教程有：</p>
<ul>
<li><a href="https://www.tensorflow.org/get_started/mnist/beginners" target="_blank" rel="external">Tensorflow官方教程</a></li>
<li><a href="http://mp.weixin.qq.com/s/E6SsvWofiN94JtZWf1f-Ug" target="_blank" rel="external">没有博士学位，照样玩转TensorFlow深度学习</a></li>
</ul>
<p>本文所用代码放在了<a href="https://github.com/SineYuan/tensorflow-demo" target="_blank" rel="external">github</a>上，如果想编译运行请将项目clone到<code>$GOPATH/src</code>下</p>
<h2 id="训练模型">训练模型</h2><p>我们先训练一个最简单的识别模型，代码码改自<a href="https://github.com/martin-gorner/tensorflow-mnist-tutorial" target="_blank" rel="external">https://github.com/martin-gorner/tensorflow-mnist-tutorial</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mnist_softmax.py</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</span><br><span class="line"><span class="keyword">from</span> tensorflow.contrib.session_bundle <span class="keyword">import</span> exporter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(flags)</span>:</span></span><br><span class="line">    mnist = input_data.read_data_sets(flags.mnist_data_dir, reshape=<span class="keyword">False</span>, one_hot=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># neural network with 1 layer of 10 softmax neurons</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># · · · · · · · · · ·       (input data, flattened pixels)       X [batch, 784]        # 784 = 28 * 28</span></span><br><span class="line">    <span class="comment"># \x/x\x/x\x/x\x/x\x/    -- fully connected layer (softmax)      W [784, 10]     b[10]</span></span><br><span class="line">    <span class="comment">#   · · · · · · · ·                                              Y [batch, 10]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># The model is:</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Y = softmax( X * W + b)</span></span><br><span class="line">    <span class="comment">#              X: matrix for 100 grayscale images of 28x28 pixels, flattened (there are 100 images in a mini-batch)</span></span><br><span class="line">    <span class="comment">#              W: weight matrix with 784 lines and 10 columns</span></span><br><span class="line">    <span class="comment">#              b: bias vector with 10 dimensions</span></span><br><span class="line">    <span class="comment">#              +: add with broadcasting: adds the vector to each line of the matrix (numpy)</span></span><br><span class="line">    <span class="comment">#              softmax(matrix) applies softmax on each line</span></span><br><span class="line">    <span class="comment">#              softmax(line) applies an exp to each value then divides by the norm of the resulting line</span></span><br><span class="line">    <span class="comment">#              Y: output matrix with 100 lines and 10 columns</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># input X: 28x28 grayscale images, the first dimension (None) will index the images in the mini-batch</span></span><br><span class="line">    X = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>])</span><br><span class="line">    <span class="comment"># correct answers will go here</span></span><br><span class="line">    Y_ = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">10</span>])</span><br><span class="line">    <span class="comment"># weights W[784, 10]   784=28*28</span></span><br><span class="line">    W = tf.Variable(tf.zeros([<span class="number">784</span>, <span class="number">10</span>]))</span><br><span class="line">    <span class="comment"># biases b[10]</span></span><br><span class="line">    b = tf.Variable(tf.zeros([<span class="number">10</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># flatten the images into a single line of pixels</span></span><br><span class="line">    <span class="comment"># -1 in the shape definition means "the only possible dimension that will preserve the number of elements"</span></span><br><span class="line">    XX = tf.reshape(X, [-<span class="number">1</span>, <span class="number">784</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The model</span></span><br><span class="line">    Y = tf.nn.softmax(tf.matmul(XX, W) + b)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># loss function: cross-entropy = - sum( Y_i * log(Yi) )</span></span><br><span class="line">    <span class="comment">#                           Y: the computed output vector</span></span><br><span class="line">    <span class="comment">#                           Y_: the desired output vector</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># cross-entropy</span></span><br><span class="line">    <span class="comment"># log takes the log of each element, * multiplies the tensors element by element</span></span><br><span class="line">    <span class="comment"># reduce_mean will add all the components in the tensor</span></span><br><span class="line">    <span class="comment"># so here we end up with the total cross-entropy for all images in the batch</span></span><br><span class="line">    cross_entropy = -tf.reduce_mean(Y_ * tf.log(Y)) * <span class="number">1000.0</span>  <span class="comment"># normalized for batches of 100 images,</span></span><br><span class="line">    <span class="comment"># *10 because  "mean" included an unwanted division by 10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># accuracy of the trained model, between 0 (worst) and 1 (best)</span></span><br><span class="line">    correct_prediction = tf.equal(tf.argmax(Y, <span class="number">1</span>), tf.argmax(Y_, <span class="number">1</span>))</span><br><span class="line">    accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># training, learning rate = 0.005</span></span><br><span class="line">    train_step = tf.train.GradientDescentOptimizer(<span class="number">0.005</span>).minimize(cross_entropy)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># init</span></span><br><span class="line">    init = tf.global_variables_initializer()</span><br><span class="line">    sess = tf.Session()</span><br><span class="line">    sess.run(init)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(flags.iterations):</span><br><span class="line">        batch_X, batch_Y = mnist.train.next_batch(flags.batch_size)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># the backpropagation training step</span></span><br><span class="line">        sess.run(train_step, feed_dict=&#123;X: batch_X, Y_: batch_Y&#125;)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"Iteration:"</span> + str(i) + <span class="string">"/"</span> + str(flags.iterations))</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"******* Training is Done! *******"</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Accuracy:"</span>, sess.run(accuracy, feed_dict=&#123;X: mnist.test.images, Y_: mnist.test.labels&#125;))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Export model to Tensorflow Serving</span></span><br><span class="line">    saver = tf.train.Saver()</span><br><span class="line"></span><br><span class="line">    model_exporter = exporter.Exporter(saver)</span><br><span class="line">    model_exporter.init(</span><br><span class="line">        sess.graph.as_graph_def(),</span><br><span class="line">        named_graph_signatures=&#123;</span><br><span class="line">            <span class="string">'inputs'</span>: exporter.generic_signature(&#123;<span class="string">'x'</span>: X&#125;),</span><br><span class="line">            <span class="string">'outputs'</span>: exporter.generic_signature(&#123;<span class="string">'y'</span>: Y&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    model_exporter.export(flags.model_dir, tf.constant(flags.model_version), sess)</span><br><span class="line">    print(<span class="string">"Model Saved at"</span>, str(flags.model_dir), <span class="string">"version:"</span>, flags.model_version)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--learning_rate'</span>,</span><br><span class="line">        type=float,</span><br><span class="line">        default=<span class="number">0.05</span>,</span><br><span class="line">        help=<span class="string">'Initial learning rate.'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--iterations'</span>,</span><br><span class="line">        type=int,</span><br><span class="line">        default=<span class="number">2000</span>,</span><br><span class="line">        help=<span class="string">'Number of iterations to run trainer.'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--batch_size'</span>,</span><br><span class="line">        type=int,</span><br><span class="line">        default=<span class="number">100</span>,</span><br><span class="line">        help=<span class="string">'Batch size.  Must divide evenly into the dataset sizes.'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--mnist_data_dir'</span>,</span><br><span class="line">        type=str,</span><br><span class="line">        default=<span class="string">'./MNIST_data'</span>,</span><br><span class="line">        help=<span class="string">'Directory to put the mnist data.'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--model_dir'</span>,</span><br><span class="line">        type=str,</span><br><span class="line">        default=<span class="string">'./model'</span>,</span><br><span class="line">        help=<span class="string">'Directory to export model.'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--model_version'</span>,</span><br><span class="line">        type=int,</span><br><span class="line">        default=<span class="number">1</span>,</span><br><span class="line">        help=<span class="string">'Model version'</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    FLAGS, unparsed = parser.parse_known_args()</span><br><span class="line"></span><br><span class="line">    main(FLAGS)</span><br></pre></td></tr></table></figure>
<p>运行<code>mnist_softmax.py</code>, 第一次运行会在默认路径下载mnist数据。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">python</span> mnist_softmax.<span class="keyword">py</span></span><br></pre></td></tr></table></figure></p>
<p>softmax模型正确率在92%的左右。训练的模型默认保存在<code>./model</code>目录下。 可以在<code>./model/</code>下看的多了个<code>00000001</code>的文件夹，里面存放的是版本号为1的模型数据。</p>
<h2 id="Tensorflow_Serving">Tensorflow Serving</h2><p>有了模型之后我们还要将其做成产品，Tensorflow提供了Tensorflow Serving，可以将训练的模型直接做成一个rpc服务，外部可以通过调用rpc来获取模型输出的结果。<br>下面我们做一个MNIST手写数字识别的web应用来实践一下。</p>
<p>项目代码在放在<a href="">github</a>上，前端用jquery + <a href="http://leimi.github.io/drawingboard.js/" target="_blank" rel="external">drawingboard.js</a>, 后端用Go做API Server, 通过grpc调用Tensorflow Sering获取识别结果。</p>
<h3 id="编译Tensorflow_Model_Server">编译Tensorflow Model Server</h3><p>具体参照<a href="https://tensorflow.github.io/serving/setup" target="_blank" rel="external">Tensorflow Serving官方文档</a>, 目前版本的Tensorflow Serving在OSX上编译有问题，不过还好官方提供了编译环境的Dockerfile， 跟着走一遍<a href="https://tensorflow.github.io/serving/docker" target="_blank" rel="external">教程</a>就好。</p>
<p>配置好环境以后我们编译tensorflow_model_server。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">cd</span> serving</span><br><span class="line"><span class="keyword">bazel </span><span class="keyword">build </span>//tensorflow_serving/model_servers:tensorflow_model_server</span><br></pre></td></tr></table></figure>
<p>如果不想编译那么麻烦的话，可以用我做的tensorflow_model_server的docker镜像, 当前对应的tensorflow serving的版本是v0.5.1</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull sineyuan/tensorflow_model_server</span><br><span class="line">cd tensorflow-demo</span><br><span class="line">docker run  -v <span class="variable">$PWD</span>:/work -p <span class="number">8500</span>:<span class="number">8500</span>  sineyuan/tensorflow_model_server --model_base_path=/work/mnist/model</span><br></pre></td></tr></table></figure>
<h3 id="运行Tensorflow_Model_Server">运行Tensorflow Model Server</h3><p>运行<code>tensorflow_model_server</code>, 指定训练模型的路径：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bazel-bin<span class="regexp">/tensorflow_serving/m</span>odel_servers<span class="regexp">/tensorflow_model_server --model_base_path=$&#123;path_to_tensorflow_demo_root&#125;/m</span>odel</span><br></pre></td></tr></table></figure>
<p><code>tensorflow_model_server</code>默认监听8500端口。</p>
<h3 id="生成Tensorflow_Serving的Go客户端包">生成Tensorflow Serving的Go客户端包</h3><p>tensorflow_model_server使用的是google自家的grpc框架, 官方例子的客户端是基于python的，没有提供Go客户端包。不过grpc是跨语言的，我们需要通过tensorflow serving提供的protobuf文件自己编译。</p>
<p>先安装grpc, 看官方的安装文档<a href="http://www.grpc.io/docs/quickstart/go.html" target="_blank" rel="external">http://www.grpc.io/docs/quickstart/go.html</a>。</p>
<p>下载Tensorflow Serving源码。</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">--recurse-submodules</span> https://github.com/tensorflow/serving</span><br><span class="line">cd serving</span><br></pre></td></tr></table></figure>
<p>准备编译脚本<code>gen_proto.sh</code>：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">output=$&#123;<span class="number">1</span>:-vendor&#125;</span><br><span class="line"></span><br><span class="line">echo <span class="variable">$output</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$output</span></span><br><span class="line"></span><br><span class="line">mkdir -p protobuf/src/google/protobuf</span><br><span class="line">cp <span class="variable">$GOPATH</span>/src/github.com/golang/protobuf/ptypes/<span class="literal">any</span>/<span class="literal">any</span>.<span class="keyword">proto</span> protobuf/src/google/protobuf/<span class="literal">any</span>.<span class="keyword">proto</span></span><br><span class="line">cp <span class="variable">$GOPATH</span>/src/github.com/golang/protobuf/ptypes/wrappers/wrappers.<span class="keyword">proto</span> protobuf/src/google/protobuf/wrappers.<span class="keyword">proto</span></span><br><span class="line"></span><br><span class="line">protoc -I=. -I=./tensorflow -I=./protobuf/src --go_out=plugins=grpc:<span class="variable">$output</span> ./tensorflow_serving/apis/*.<span class="keyword">proto</span></span><br><span class="line"></span><br><span class="line">protoc -I=./tensorflow --go_out=plugins=grpc:<span class="variable">$output</span> tensorflow/tensorflow/core/example/*.<span class="keyword">proto</span></span><br><span class="line">protoc -I=./tensorflow --go_out=plugins=grpc:<span class="variable">$output</span> tensorflow/tensorflow/core/framework/*.<span class="keyword">proto</span></span><br><span class="line"></span><br><span class="line">protoc -I=./tensorflow -I=./protobuf/src --go_out=plugins=grpc:<span class="variable">$output</span> \</span><br><span class="line">	tensorflow/tensorflow/core/protobuf/saver.<span class="keyword">proto</span>  \</span><br><span class="line">	tensorflow/tensorflow/core/protobuf/meta_graph.<span class="keyword">proto</span></span><br><span class="line"></span><br><span class="line">rm -r protobuf</span><br></pre></td></tr></table></figure>
<p>将<code>gen_proto.sh</code>放在下载的Tensorflow Serving源码目录下， 在源码目录下执行：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sh</span> gen_proto.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<p>在源码目录下即可生成<code>vendor</code>文件夹，将<code>vendor</code>文件夹放到我们的Demo项目目录下即可。</p>
<h3 id="Go_API_Server">Go API Server</h3><p>用Go写一个简单的API Server展示Tensorflow Serving的调用方法, 为了省事，直接用了<a href="https://github.com/labstack/echo" target="_blank" rel="external">echo</a>这个web框架。</p>
<p>gprc调用Tensorflow Serving的具体方法参见下面代码</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"flag"</span></span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/labstack/echo"</span></span><br><span class="line">	<span class="string">"google.golang.org/grpc"</span></span><br><span class="line"></span><br><span class="line">	tf_framework <span class="string">"tensorflow/core/framework"</span></span><br><span class="line">	pb <span class="string">"tensorflow_serving/apis"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	port         <span class="type">int</span></span><br><span class="line">	model_server <span class="type">string</span></span><br><span class="line">	model_name   <span class="type">string</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func init() &#123;</span><br><span class="line">	flag.<span class="type">IntVar</span>(&amp;port, <span class="string">"port"</span>, <span class="number">1323</span>, <span class="string">"concurrent processing ,default 1 ."</span>)</span><br><span class="line">	flag.<span class="type">StringVar</span>(&amp;model_server, <span class="string">"model_server"</span>, <span class="string">"localhost:8500"</span>, <span class="string">"concurrent processing ,default 1 ."</span>)</span><br><span class="line">	flag.<span class="type">StringVar</span>(&amp;model_name, <span class="string">"model_name"</span>, <span class="string">"default"</span>, <span class="string">"concurrent processing ,default 1 ."</span>)</span><br><span class="line"></span><br><span class="line">	flag.<span class="type">Parse</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="type">Resp</span> struct &#123;</span><br><span class="line">	<span class="type">Success</span> <span class="type">bool</span></span><br><span class="line">	<span class="type">Msg</span>     <span class="type">string</span></span><br><span class="line">	<span class="type">Result</span>  [<span class="number">10</span>]<span class="type">float32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	e := echo.<span class="type">New</span>()</span><br><span class="line">	// <span class="type">Set</span> up a connection to the model server.</span><br><span class="line">	conn, err := grpc.<span class="type">Dial</span>(model_server, grpc.<span class="type">WithInsecure</span>())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="keyword">nil</span> &#123;</span><br><span class="line">		e.<span class="type">Logger</span>.<span class="type">Fatalf</span>(<span class="string">"can not connect model_server: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	defer conn.<span class="type">Close</span>()</span><br><span class="line"></span><br><span class="line">	client := pb.<span class="type">NewPredictionServiceClient</span>(conn)</span><br><span class="line"></span><br><span class="line">	e.<span class="type">Static</span>(<span class="string">"/"</span>, <span class="string">"templates"</span>)</span><br><span class="line">	e.<span class="type">Static</span>(<span class="string">"/static"</span>, <span class="string">"static"</span>)</span><br><span class="line"></span><br><span class="line">	e.<span class="type">POST</span>(<span class="string">"/api/mnist"</span>, func(c echo.<span class="type">Context</span>) error &#123;</span><br><span class="line">		req := c.<span class="type">Request</span>()</span><br><span class="line">		body, err := ioutil.<span class="type">ReadAll</span>(req.<span class="type">Body</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="keyword">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="literal">result</span>, err := <span class="type">Predict</span>(client, body)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="keyword">nil</span> &#123;</span><br><span class="line">			e.<span class="type">Logger</span>.<span class="type">Error</span>(err.<span class="type">Error</span>())</span><br><span class="line">			<span class="keyword">return</span> c.<span class="type">JSON</span>(http.<span class="type">StatusOK</span>, &amp;<span class="type">Resp</span>&#123;</span><br><span class="line">				<span class="type">Msg</span>: err.<span class="type">Error</span>(),</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> c.<span class="type">JSON</span>(http.<span class="type">StatusOK</span>, &amp;<span class="type">Resp</span>&#123;</span><br><span class="line">			<span class="type">Success</span>: <span class="literal">true</span>,</span><br><span class="line">			<span class="type">Result</span>:  <span class="literal">result</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	e.<span class="type">Logger</span>.<span class="type">Fatal</span>(e.<span class="type">Start</span>(<span class="string">":"</span> + strconv.<span class="type">Itoa</span>(port)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func <span class="type">Predict</span>(c pb.<span class="type">PredictionServiceClient</span>, imgBytes []byte) (<span class="literal">result</span> [<span class="number">10</span>]<span class="type">float32</span>, err error) &#123;</span><br><span class="line">	// 构造请求</span><br><span class="line">	req := &amp;pb.<span class="type">PredictRequest</span>&#123;</span><br><span class="line">		// model名由tensorflow_model_server的启动参数 --model_name 指定, 默认是default</span><br><span class="line">		<span class="type">ModelSpec</span>: &amp;pb.<span class="type">ModelSpec</span>&#123;<span class="type">Name</span>: model_name&#125;,</span><br><span class="line">		<span class="type">Inputs</span>:    make(map[<span class="type">string</span>]*tf_framework.<span class="type">TensorProto</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">in</span> := normalize(imgBytes)</span><br><span class="line"></span><br><span class="line">	// 输入数据</span><br><span class="line">	tp := &amp;tf_framework.<span class="type">TensorProto</span>&#123;</span><br><span class="line">		<span class="type">Dtype</span>:    tf_framework.<span class="type">DataType_DT_FLOAT</span>,</span><br><span class="line">		<span class="type">FloatVal</span>: <span class="keyword">in</span>,</span><br><span class="line">		// 由于输入只能是一个slice，所以要在这里声明输入数据的shape</span><br><span class="line">		// <span class="type">Tensorflow</span> <span class="type">Model</span> <span class="type">Server</span>将数据resize成输入<span class="type">Tensor</span>需要的shape</span><br><span class="line">		<span class="type">TensorShape</span>: &amp;tf_framework.<span class="type">TensorShapeProto</span>&#123;</span><br><span class="line">			<span class="type">Dim</span>: []*tf_framework.<span class="type">TensorShapeProto_Dim</span>&#123;</span><br><span class="line">				&amp;tf_framework.<span class="type">TensorShapeProto_Dim</span>&#123;</span><br><span class="line">					<span class="type">Size</span>: <span class="type">int64</span>(<span class="number">1</span>),</span><br><span class="line">					<span class="type">Name</span>: <span class="string">"batch"</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&amp;tf_framework.<span class="type">TensorShapeProto_Dim</span>&#123;</span><br><span class="line">					<span class="type">Size</span>: <span class="type">int64</span>(<span class="number">784</span>),</span><br><span class="line">					<span class="type">Name</span>: <span class="string">"data"</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	// 输入参数名要与模型导出时指定的一致</span><br><span class="line">	req.<span class="type">Inputs</span>[<span class="string">"x"</span>] = tp</span><br><span class="line"></span><br><span class="line">	// 请求<span class="type">Model</span> <span class="type">Server</span></span><br><span class="line">	resp, err := c.<span class="type">Predict</span>(context.<span class="type">Background</span>(), req)</span><br><span class="line"></span><br><span class="line">	// 输出参数名要与模型导出时指定的一致</span><br><span class="line">	output, ok := resp.<span class="type">Outputs</span>[<span class="string">"y"</span>]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		err = fmt.<span class="type">Errorf</span>(<span class="string">"can not find output data with label y"</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> len(output.<span class="type">FloatVal</span>) != <span class="number">10</span> &#123;</span><br><span class="line">		err = fmt.<span class="type">Errorf</span>(<span class="string">"wrong output dimension, it should be 10, now got %d"</span>, len(output.<span class="type">FloatVal</span>))</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	copy(<span class="literal">result</span>[:], output.<span class="type">FloatVal</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func normalize(bytes []byte) (r []<span class="type">float32</span>) &#123;</span><br><span class="line">	r = make([]<span class="type">float32</span>, <span class="number">0</span>, len(bytes))</span><br><span class="line">	<span class="keyword">for</span> _, b := <span class="type">range</span> bytes &#123;</span><br><span class="line">		r = append(r, <span class="type">float32</span>(<span class="number">255</span>-b)/<span class="number">255</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意输入输出的签名是在模型导出的时候指定的</p>
<figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># mnist_softmax.py</span><br><span class="line">   .....</span><br><span class="line">    model_exporter.init(</span><br><span class="line">        sess.graph.as_graph_def(),</span><br><span class="line">        named_graph_signatures=&#123;</span><br><span class="line">            <span class="string">'inputs'</span>: exporter.generic_signature(&#123;<span class="string">'x'</span>: <span class="keyword">X</span>&#125;),  # 指明输入的参数名为x，类型维度和Tensor <span class="keyword">X</span> 一样</span><br><span class="line">            <span class="string">'outputs'</span>: exporter.generic_signature(&#123;<span class="string">'y'</span>: <span class="keyword">Y</span>&#125;)  # 指明输出的参数名为x，类型维度和Tensor <span class="keyword">Y</span> 一样</span><br><span class="line">        &#125;</span><br><span class="line">   )</span><br><span class="line">   ....</span><br></pre></td></tr></table></figure>
<p>运行main.go后可以在<a href="http://localhost:1323" target="_blank" rel="external">http://localhost:1323</a>访问web页面。</p>
<p>效果图:</p>
<p><img src="https://github.com/SineYuan/tensorflow-demo/blob/master/doc/images/mnist_web.png?raw=true" alt=""></p>
<h3 id="模型更新">模型更新</h3><p>有了前面的工作后，下面的就轻松了。现在我们来升级模型，直接上卷积神经网络。代码在<a href="https://github.com/SineYuan/tensorflow-demo/blob/master/mnist/mnist_cnn.py" target="_blank" rel="external">https://github.com/SineYuan/tensorflow-demo/blob/master/mnist/mnist_cnn.py</a></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> mnist</span><br><span class="line"><span class="keyword">python</span> mnist_cnn.<span class="keyword">py</span> --model_version=<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>卷积神经网络正确率在98%的左右。我们可以看到<code>model</code>目录下多了个<code>00000002</code>的文件夹，此时如何<code>tensorflow_model_server</code>还在运行的话会自动加载新的版本为2的模型，就是那么简单。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2017/03/02/tensorflow-mnist-pratice/" data-id="cjpny5rta0005jm13z0742tu6" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2017/03/02/tensorflow-mnist-pratice/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-tensorflow-windows-installation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/19/tensorflow-windows-installation/" class="article-date">
  <time datetime="2017-02-18T16:00:00.000Z" itemprop="datePublished">2017-02-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/19/tensorflow-windows-installation/">在Windows上安装Tensorflow</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Tensorflow可以说是目前最火的机器学习框架。由于某些原因，我只能在Windows上使用GPU版本的Tensorflow。好在 Tensorflow1.0在最近也发布了，对于windows平台的支持也不错，这里将安装过程记录一下。</p>
<h2 id="安装Python/Anaconda">安装Python/Anaconda</h2><p>首先第一步当然是安装python，直接去<a href="https://www.python.org/downloads/release/python-352/" target="_blank" rel="external">python官网</a>下载安装就好了，不过tensorflow在windows平台上只支持python3.5x以上的版本，下载时需要注意。</p>
<p>通常开发的时候还需要numpy, scipy等数据挖掘，科学计算方面常用的包。python官方是没有的，用到时又需要去下载。为了免去这个麻烦，我们还可以直接安装python的发行版Anaconda，这个发行版包含了大部分常用的包，开箱即用。Anaconda下载地址<a href="https://www.continuum.io/downloads#windows" target="_blank" rel="external">https://www.continuum.io/downloads#windows</a>， 也是注意要选python3.5以上的版本。</p>
<h2 id="安装Tensorflow">安装Tensorflow</h2><p>在命令行直接使用pip安装Tensorflow</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; pip3 install <span class="comment">--upgrade tensorflow</span></span><br></pre></td></tr></table></figure>
<p>GPU版本用</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; pip3 install <span class="comment">--upgrade tensorflow-gpu</span></span><br></pre></td></tr></table></figure>
<h2 id="安装CUDA和cuDNN(GPU版本)">安装CUDA和cuDNN(GPU版本)</h2><p>若是用gpu版本的Tensorflow还需要安装CUDA和cuDNN才能够跑gpu任务。不过在此之前需要确认你的NVIDIA支持CUDA Compute Capability 3.0 以上版本，具体型号可以在<a href="https://developer.nvidia.com/cuda-gpus" target="_blank" rel="external">这里</a>查看。</p>
<h3 id="安装CUDA">安装CUDA</h3><p>CUDA（Compute Unified Device Architecture）是由NVIDIA所推出的一种集成技术通过CUDA我们可以调用GPU来运行密集的计算。</p>
<p>在NVIDIA官网这里下载并安装CUDA驱动(版本 &gt;= 7.0)即可。我这里安装的是CUDA 8.0</p>
<h3 id="安装cuDNN">安装cuDNN</h3><p>cuDNN是NVIDIA推出的深度学习GPU加速库，提供向前向后传播，卷积, pooling, normalization等深度学习常用函数的GPU加速功能。</p>
<p> <a href="https://developer.nvidia.com/rdp/cudnn-download" target="_blank" rel="external">官网下载cuDNN</a>。选择CUDA8.0对应的cuDNN v5.1 Library for Windows 10。</p>
<p> 解压下载下来的<code>cudnn-8.0-windows10-x64-v5.1.zip</code>文件，将里面的<code>bin</code>，<code>include</code>，<code>lib</code>文件夹覆盖到<code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0</code>目录下。</p>
<p> 当CUDA和cuDNN安装好之后，在python里import tensorflow的时候应该会显示成功加载一系列的库。</p>
 <figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> In <span class="special">[</span>1<span class="special">]</span>: import tensorflow as tf</span><br><span class="line">I c:<span class="command">\tf</span>_jenkins<span class="command">\home</span><span class="command">\workspace</span><span class="command">\release</span>-win<span class="command">\device</span><span class="command">\gpu</span><span class="command">\os</span><span class="command">\windows</span><span class="command">\tensorflow</span><span class="command">\stream</span>_executor<span class="command">\dso</span>_loader.cc:135<span class="special">]</span> successfully opened CUDA library cublas64_80.dll locally</span><br><span class="line">I c:<span class="command">\tf</span>_jenkins<span class="command">\home</span><span class="command">\workspace</span><span class="command">\release</span>-win<span class="command">\device</span><span class="command">\gpu</span><span class="command">\os</span><span class="command">\windows</span><span class="command">\tensorflow</span><span class="command">\stream</span>_executor<span class="command">\dso</span>_loader.cc:135<span class="special">]</span> successfully opened CUDA library cudnn64_5.dll locally</span><br><span class="line">I c:<span class="command">\tf</span>_jenkins<span class="command">\home</span><span class="command">\workspace</span><span class="command">\release</span>-win<span class="command">\device</span><span class="command">\gpu</span><span class="command">\os</span><span class="command">\windows</span><span class="command">\tensorflow</span><span class="command">\stream</span>_executor<span class="command">\dso</span>_loader.cc:135<span class="special">]</span> successfully opened CUDA library cufft64_80.dll locally</span><br><span class="line">I c:<span class="command">\tf</span>_jenkins<span class="command">\home</span><span class="command">\workspace</span><span class="command">\release</span>-win<span class="command">\device</span><span class="command">\gpu</span><span class="command">\os</span><span class="command">\windows</span><span class="command">\tensorflow</span><span class="command">\stream</span>_executor<span class="command">\dso</span>_loader.cc:135<span class="special">]</span> successfully opened CUDA library nvcuda.dll locally</span><br><span class="line">I c:<span class="command">\tf</span>_jenkins<span class="command">\home</span><span class="command">\workspace</span><span class="command">\release</span>-win<span class="command">\device</span><span class="command">\gpu</span><span class="command">\os</span><span class="command">\windows</span><span class="command">\tensorflow</span><span class="command">\stream</span>_executor<span class="command">\dso</span>_loader.cc:135<span class="special">]</span> successfully opened CUDA library curand64_80.dll locally</span><br></pre></td></tr></table></figure>
<p> 若加载失败，大部分情况可能是环境变量的设置问题，请检查<code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v8.0</code>有没有在环境变量<code>PATH</code>里面。</p>
<h2 id="检验">检验</h2><p> 进入python的shell</p>
 <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> &gt;&gt;&gt; import tensorflow as tf</span><br><span class="line"></span><br><span class="line">hello = tf.<span class="function"><span class="title">constant</span><span class="params">(<span class="string">'Hello, TensorFlow!'</span>)</span></span></span><br><span class="line">sess = tf.<span class="function"><span class="title">Session</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(sess.run(hello)</span></span>)</span><br></pre></td></tr></table></figure>
<p> 当出现 Hello, TensorFlow!即表示安装成功。</p>
 <figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">Hello</span>, <span class="variable">TensorFlow</span><span class="exclamation_mark">!</span></span><br></pre></td></tr></table></figure>
<p>更多细节参考官方文档<a href="https://www.tensorflow.org/install/" target="_blank" rel="external">https://www.tensorflow.org/install/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2017/02/19/tensorflow-windows-installation/" data-id="cjpny5rt90004jm13z28m4g7s" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2017/02/19/tensorflow-windows-installation/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-go-naming" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/27/go-naming/" class="article-date">
  <time datetime="2017-01-26T16:00:00.000Z" itemprop="datePublished">2017-01-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/27/go-naming/">(译)Go naming conventions</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文的内容是Andrew Gerrand在Meetup Golang Paris上一次演讲slide的翻译(<a href="https://www.youtube.com/watch?v=sFUSP8Au_PE" target="_blank" rel="external">youtube</a>，<a href="https://talks.golang.org/2014/names.slide#1" target="_blank" rel="external">slide</a>)，内容是Go里面的一些命名的规范与建议。内容不错，在这里记录分享。</p>
<h2 id="Names_matter">Names matter</h2><p>可读性定义代码的质量。</p>
<p>好的命名对可读性非常重要。</p>
<p>好的命名是: </p>
<ul>
<li>连续(容易理解)</li>
<li>简短(便于输入)</li>
<li>准确(易于理解)</li>
</ul>
<h2 id="A_rule_of_thumb">A rule of thumb</h2><p>一个常用的经验法则是：一个命名声明与使用的地方的距离越大，那么这个名字应该越长。</p>
<h2 id="Use_MixedCase">Use MixedCase</h2><p>在Go应使用驼峰命名法(不要使用下划线命名)。</p>
<p>首字母应该大写，像<code>ServeHTTP</code> 和 <code>IDProcessor</code></p>
<h2 id="Local_variables">Local variables</h2><p>本地变量应保持简短，长短命名将有碍阅读。</p>
<p>例如一些常用的约定：<br>使用 <code>i</code> 表示索引。<br>使用 <code>r</code> 表示reader。</p>
<p>长命名可能对于很长的函数或有很对本地变量的函数很有用，但那通常表示你的代码需要重构了。</p>
<h3 id="坏🌰">坏🌰</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func RuneCount(buffer []<span class="keyword">byte</span>) <span class="keyword">int</span> &#123;</span><br><span class="line">    <span class="keyword">index</span>, <span class="keyword">count</span> := <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">index</span> &lt; len(buffer) &#123;</span><br><span class="line">        <span class="keyword">if</span> buffer[<span class="keyword">index</span>] &lt; RuneSelf &#123;</span><br><span class="line">            <span class="keyword">index</span>++</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _, size := DecodeRune(buffer[<span class="keyword">index</span>:])</span><br><span class="line">            <span class="keyword">index</span> += size</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">count</span>++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">count</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="好🌰">好🌰</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func RuneCount(b []<span class="typename">byte</span>) <span class="typename">int</span> &#123;</span><br><span class="line">    i, <span class="string">n :</span>= <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i &lt; len(b) &#123;</span><br><span class="line">        <span class="keyword">if</span> b[i] &lt; RuneSelf &#123;</span><br><span class="line">            i++</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _, <span class="string">size :</span>= DecodeRune(b[<span class="string">i:</span>])</span><br><span class="line">            i += size</span><br><span class="line">        &#125;</span><br><span class="line">        n++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参数">参数</h2><p>函数的参数作用像本地变量，但它们还具有文档的功能。</p>
<p>当参数类型具有描述性时，使用短命名。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">AfterFunc</span><span class="params">(d Duration, f <span class="keyword">func</span><span class="params">()</span></span></span>) *<span class="type">Timer</span></span><br><span class="line"></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">Escape</span><span class="params">(w io.Writer, s []byte)</span></span></span><br></pre></td></tr></table></figure>
<p>当参数类型很模糊时(例如原生类型，相同的类型的参数时)，那么参数名字需要像文档一样说明。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">Unix</span><span class="params">(sec, nsec int64)</span></span> <span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">HasPrefix</span><span class="params">(s, <span class="keyword">prefix</span> []byte)</span></span> bool</span><br></pre></td></tr></table></figure></p>
<h2 id="返回值">返回值</h2><p>对于一个对外发布的函数，返回值应命名应像文档一样说明返回值的作用。</p>
<p>好的例子：<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Copy</span><span class="params">(dst Writer, src Reader)</span> <span class="params">(written int64, err error)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ScanBytes</span><span class="params">(data []byte, atEOF bool)</span> <span class="params">(advance int, token []byte, err error)</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="Receivers">Receivers</h2><p>Receivers是一种特殊类型的参数</p>
<p>通常情况，使用一到两个其类型简写的字符表示，因为在方法里面他们会经常出现</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Read</span><span class="params">(p []byte)</span> <span class="params">(n int, err error)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sh serverHandler)</span> <span class="title">ServeHTTP</span><span class="params">(rw ResponseWriter, req *Request)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Rectangle)</span> <span class="title">Size</span><span class="params">()</span> <span class="title">Point</span></span></span><br></pre></td></tr></table></figure>
<p>一个类型的方法Receiver命名应保持一致(不要在一个方法里面用<code>r</code>而在另一个方法里用<code>rdr</code>)</p>
<h2 id="Exported_package-level_names">Exported package-level names</h2><p>一个包的导出的名字被其包命修饰，时时铭记这一点。<br>所以在标准库里面有<code>bytes.Buffer</code>和<code>strings.Reader</code>，而不是<code>bytes.ByteBuffer</code>,<code>strings.StringReader</code></p>
<h2 id="接口类型">接口类型</h2><p>如果一个接口里面只有一个方法，那通常给方法名后面加一个’er’就好了。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader interface &#123;</span><br><span class="line">    <span class="keyword">Read</span>(p []byte) (<span class="keyword">n</span> int, <span class="keyword">err</span> <span class="keyword">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然有时英语语法上是不对的，但我们还是这么做(but we do it anyway)<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="typedef"><span class="keyword">type</span> <span class="type">Execer</span> interface <span class="container">&#123;</span><br><span class="line">    <span class="type">Exec</span>(query string, args []<span class="type">Value</span>) (<span class="type">Result</span>, error)</span><br><span class="line">&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>有时要做一些转换看起来更好<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="typedef"><span class="keyword">type</span> <span class="type">ByteReader</span> interface <span class="container">&#123;</span><br><span class="line">    <span class="type">ReadByte</span>() (c byte, err error)</span><br><span class="line">&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<p>但一个接口包含多个方法是，选择名字需要准确的描述这个借口的作用(例如: <code>net.Conn</code>, <code>http.ResponseWriter</code>, <code>io.ReadWriter</code>)</p>
<h2 id="Error">Error</h2><p>错误类型命名类似<code>FooError</code>:</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="constant">ExitError</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>错误值命名类似<code>ErrFoo</code>:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">var</span> ErrFormat = errors.<span class="function"><span class="title">New</span><span class="params">(<span class="string">"image: unknown format"</span>)</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="包命名">包命名</h2><p>对外发布的包名应该说明包的作用</p>
<p>避免使用util，common，等等</p>
<h2 id="Import_paths">Import paths</h2><p>包的最后一个部分的路径应和包名相同。<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"compress/gzip"</span> <span class="comment">// package gzip</span></span><br></pre></td></tr></table></figure></p>
<p>避免在包路径上结巴(233)。</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"code.google.com/p/goauth2/oauth2"</span> <span class="comment">// bad; my fault</span></span><br></pre></td></tr></table></figure>
<p>对于库来说，通常将代码放在根目录下。<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"github.com/golang/oauth2"</span> <span class="comment">// package oauth2</span></span><br></pre></td></tr></table></figure></p>
<p>避免大写字母(不是所有的文件系统都是大小写敏感的)。</p>
<h2 id="标准库">标准库</h2><p>文中许多例子都是来自标准库。</p>
<p>标准库是个寻找优秀Go代码的地方，常看常新。</p>
<p><em>但请记住</em>:</p>
<blockquote>
<p>When the standard library was written, we were still learning.<br>Most of it we got right, but we made some mistakes.</p>
</blockquote>
<h2 id="Conclusion">Conclusion</h2><p>Use short names.<br>使用短的名字</p>
<p>Think about context.<br>多思考上下文</p>
<p>Use your judgment.<br>要有自己的判断</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2017/01/27/go-naming/" data-id="cjpny5rtj000cjm13abnigobv" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2017/01/27/go-naming/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-go-error-handle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/28/go-error-handle/" class="article-date">
  <time datetime="2016-08-27T17:25:03.000Z" itemprop="datePublished">2016-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/28/go-error-handle/">Golang错误处理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文是GopherCon 2016的演讲<a href="https://www.youtube.com/watch?v=lsBF58Q-DnY" target="_blank" rel="external">Dont Just Check Errors Handle Them Gracefully</a>的笔记，详情可点击链接观看(请带梯子上油管)</p>
<h2 id="常见错误处理策略">常见错误处理策略</h2><h3 id="Sentiel_errors">Sentiel errors</h3><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err == ErrSomething &#123; <span class="attribute">...</span> &#125;</span><br></pre></td></tr></table></figure>
<p>这是最常见的处理方法，通过判断错误类型来做相应的处理。常见的有</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">io<span class="class">.EOF</span></span><br><span class="line">syscall<span class="class">.ENOENT</span></span><br><span class="line">go/build<span class="class">.NoGoError</span></span><br><span class="line">path/filepath.SkipDir</span><br></pre></td></tr></table></figure>
<p>但这种处理方法是最不灵活的一种方法，因为我们必须知道确定的错误类型。如果我们需要使用自定义的一些错误类型，当我们的代码作为一个package导出时，错误变成了api的一部分，这样就有了强耦合，以后要是修改错误会很麻烦。</p>
<p>另外，当我们使用<code>fmt.Errorf</code>的时候，我们需要通过判断错误string的内容来区分错误，如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">func</span> <span class="tag">readfile</span>(<span class="tag">path</span> <span class="tag">string</span>) <span class="tag">error</span> <span class="rules">&#123;</span><br><span class="line">		<span class="rule"><span class="attribute">err </span>:<span class="value">= <span class="function">openfile</span>(path)</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">				return fmt.<span class="function">Errorf</span>(<span class="string">"cannot open file: %v"</span>, err)</span><br><span class="line">		</span></span></span>&#125;</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">func</span> <span class="tag">main</span>() <span class="rules">&#123;</span><br><span class="line">		<span class="rule"><span class="attribute">err </span>:<span class="value">= <span class="function">readfile</span>(<span class="string">".bash"</span>)</span><br><span class="line">		if strings.<span class="function">Contains</span>(err.<span class="function">Error</span>(), <span class="string">"not found"</span>) &#123;</span><br><span class="line">				// handle error</span><br><span class="line">		</span></span></span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是种非常糟糕的做法，当错误信息改变时，对应的错误处理也要相应改变， 另外还要性能的问题。</p>
<p>除非是标准库里面的函数，否则避免使用Sentiel errors</p>
<h3 id="Error_Types">Error Types</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">err</span>, ok := <span class="keyword">err</span>.(SomeType); ok &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>配合Type assertion使用</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">err :</span>= somethint()</span><br><span class="line"><span class="keyword">switch</span> <span class="string">err :</span>= err.(type) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">nil:</span></span><br><span class="line">		<span class="comment">// call succeed</span></span><br><span class="line"><span class="keyword">case</span> *os.<span class="string">PathError:</span></span><br><span class="line">		<span class="comment">// handle PathError</span></span><br><span class="line"><span class="string">default:</span></span><br><span class="line">		<span class="comment">// handle Unknow error			</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个其实没什么好讲的，同样的，Error Types也会造成包之间的强耦合，除非是在包内部使用，否则不推荐使用</p>
<h3 id="Opaque_errors">Opaque errors</h3><p>Opaque是不透明的意思，这个是讲者自己的叫法，具体的思想就是:</p>
<blockquote>
<p>Assert errors for behaviour, not type<br>通过行为来判断错误而不是类型</p>
</blockquote>
<p>说起行为，很自然的就联想到了interface，对的，不使用type，使用interface来处理。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> temporary interface &#123;</span><br><span class="line">		Tepporary() bool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func IsTemporary(<span class="keyword">err</span> <span class="keyword">error</span>) bool &#123;</span><br><span class="line">		<span class="keyword">te</span>, ok := <span class="keyword">err</span>.(temporary)</span><br><span class="line">		<span class="keyword">return</span> ok &amp;&amp; <span class="keyword">te</span>.Temporary()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种方法的耦合度更低一些，不过无法完全避免依赖度，毕竟interface也是api的一部分。</p>
<h2 id="Don’t_just_check_errors,_handle_then_greacefully">Don’t just check errors, handle then greacefully</h2><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这应该最常见的错误处理，不过想想当一个错误经过层层的return，当到达最外面的log记录了下来。但当你debug查找日志时只看到一句</p>
<blockquote>
<p>No such file or directory</p>
</blockquote>
<p>心里会不会万匹草泥马奔腾(╯‵□′)╯︵┴─┴  </p>
<p>是的，这种方法坏处就是破坏了错误发生的上线文环境，debug起来就很困难。</p>
<p>当然我们使用<code>fmt.Errorf</code>为错误加上一些信息</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">AuthenticatRequest</span><span class="params">(r *Request)</span></span> error &#123;</span><br><span class="line">		err := authenticate(r.<span class="type">User</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.<span class="type">Errorf</span>(<span class="string">"authenticat failed: %v"</span>, err)</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了更优雅一点，讲者提供了一个包<code>github.com/pkg/errors</code>做这个事情。</p>
<p>这个包的api也很简单</p>
<h4 id="errors-New">errors.New</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">err := errors.<span class="function"><span class="title">New</span><span class="params">(<span class="string">"kerboom"</span>)</span></span></span><br><span class="line">fmt.<span class="function"><span class="title">Printf</span><span class="params">(<span class="string">"%v\n"</span>, err)</span></span></span><br></pre></td></tr></table></figure>
<p>使用<code>errors.New</code>新建的err打印时会展示出调用堆栈</p>
<h4 id="errors-Wrap">errors.Wrap</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">err := errors.Warp(</span><br><span class="line">			syscall<span class="class">.EBADF</span>, <span class="string">"couldn't write to stream"</span>)</span><br><span class="line">fmt.<span class="function"><span class="title">Printf</span><span class="params">(<span class="string">"%v\n"</span>, err)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出			</span></span><br><span class="line">／／ couldn<span class="string">'t write to stream: bad file descriptor</span></span><br></pre></td></tr></table></figure>
<h4 id="errors-Cause">errors.Cause</h4><p>有Wrap方法那也会有UnWrap的方法，这就是<code>errors.Cause</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errors.<span class="function"><span class="title">Cause</span><span class="params">(err)</span></span>  <span class="comment">// 返回Wrap之前的error</span></span><br></pre></td></tr></table></figure>
<p>前面的例子需要改成这样</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> temporary interface &#123;</span><br><span class="line">		Tepporary() bool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func IsTemporary(<span class="keyword">err</span> <span class="keyword">error</span>) bool &#123;</span><br><span class="line">		<span class="keyword">te</span>, ok := <span class="keyword">err</span>.Cause(<span class="keyword">err</span>).(temporary)</span><br><span class="line">		<span class="keyword">return</span> ok &amp;&amp; <span class="keyword">te</span>.Temporary()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>github.com/pkg/errors</code>代码也就几百行，还是很不错的，值得推荐。</p>
<p>以上</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/08/28/go-error-handle/" data-id="cjpny5rtk000djm130z2c8t2w" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/08/28/go-error-handle/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-deploy-k8s-on-coreos" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/29/deploy-k8s-on-coreos/" class="article-date">
  <time datetime="2016-05-29T14:07:38.000Z" itemprop="datePublished">2016-05-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/29/deploy-k8s-on-coreos/">CoreOS部署kubernetes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="准备工作">准备工作</h2><h3 id="下载Kubernetes">下载Kubernetes</h3><p>在<a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="external">github</a>下载最新的kuberbetes二进制包，这里我下载的是v1.2.4的版本。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf kubernetes<span class="class">.tar</span><span class="class">.gz</span></span><br><span class="line">cd kubernetes</span><br><span class="line"><span class="comment">// 解压amd64的版本</span></span><br><span class="line">tar zxvf kubernetes/server/kubernetes-server-linux-amd64<span class="class">.tar</span><span class="class">.gz</span></span><br><span class="line">cd kubernetes/server/kubernetes/server/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将下列文件复制到各个节点上</span></span><br><span class="line">cp kube-apiserver kube-proxy kubelet kube-scheduler kube-controller-manager /opt/bin</span><br></pre></td></tr></table></figure>
<p>将kube-apiserver kube-proxy kubelet kube-scheduler kube-controller-manager复制到各个节点上，我这里放到各个节点到<code>/opt/bin</code>文件夹里</p>
<h3 id="启动etcd">启动etcd</h3><p>可以参考<a href="http://sineyuan.github.io/2016/05/29/coreos-osx-without-vagrant/">前文</a>。确保etcdctl命令可用。在这里我用etcd2代替etcd</p>
<h2 id="配置网络">配置网络</h2><p>由于每个节点docker容器的ip可能是相同的，为了使不同节点上的docker容器能够互相连接，所以需要有一种方法来统一分配每个节点的docker容器ip，防止冲突，并提供不同节点容器的连接能力，也就是SDN(software defined network) kubernetes没有提供这个功能，不过有许多的kubernetes社区有许多解决方案。如<code>flannel</code>,<code>calico</code>, <code>OVS</code> 等</p>
<p>这里我选用CoreOS的flannel</p>
<p>flannel使用etcd来保存子网ip等分配，新加入节点的flanned通过访问etcd来获取一个可用的子网网段，并负责容器间的代理转发。</p>
<p>在CoreOS中自带flannel.service，但实际上CoreOS为了节省空间，这个service实际上是运行了一个flannel的docker容器，第一次启动时需要从网络下载flannel的镜像。由于众所周知的原因，我们还是下载编译好的二进制包吧。</p>
<p>在<a href="https://github.com/coreos/flannel" target="_blank" rel="external">https://github.com/coreos/flannel</a>下载最新的release，解压出flanneld，同样放入<code>/opt/bin</code>里</p>
<p>在所有节点<code>/etc/systemd/system/*.service</code>里添加<code>flannel.service</code>文件</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Flannel network fabric for CoreOS</span></span></span><br><span class="line"><span class="setting">Requires=<span class="value">etcd2.service</span></span></span><br><span class="line"><span class="setting">After=<span class="value">etcd2.service</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Service]</span></span><br><span class="line"><span class="setting">EnvironmentFile=<span class="value">/etc/environment</span></span></span><br><span class="line"><span class="setting">ExecStartPre=<span class="value">-/bin/bash -c <span class="string">"until /usr/bin/etcdctl set /coreos.com/network/config '&#123;\"Network\": \"10.100.0.0/16\"&#125;'; do echo \"waiting for etcd to become available...\"; sleep 5; done"</span></span></span></span><br><span class="line"><span class="setting">ExecStart=<span class="value">/opt/bin/flanneld -iface=<span class="variable">$private_ipv4</span></span></span></span><br><span class="line"><span class="setting">ExecStartPost=<span class="value">-/bin/bash -c <span class="string">"until [ -e /run/flannel/subnet.env ]; do echo \"waiting for write.\"; sleep 3; done"</span></span></span></span><br><span class="line"><span class="setting">Restart=<span class="value"><span class="keyword">on</span>-failure</span></span></span><br><span class="line"><span class="setting">RestartSec=<span class="value"><span class="number">5</span></span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Install]</span></span><br><span class="line"><span class="setting">WantedBy=<span class="value">multi-user.target</span></span></span><br></pre></td></tr></table></figure>
<p>flanneld成功获取到子网网段后会以环境变量的形式保存在<code>/run/flannel/subnet.env</code>文件里。我们再修改<code>docker.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Docker Application Container Engine</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">http://docs.docker.com</span></span></span><br><span class="line"><span class="setting">After=<span class="value">docker.socket early-docker.target network.target flannel.service</span></span></span><br><span class="line"><span class="setting">Requires=<span class="value">docker.socket early-docker.target flannel.service</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Service]</span></span><br><span class="line"><span class="setting">Environment=<span class="value"><span class="string">"DOCKER_CGROUPS=--exec-opt native.cgroupdriver=systemd"</span></span></span></span><br><span class="line"><span class="setting">EnvironmentFile=<span class="value">/run/flannel/subnet.env</span></span></span><br><span class="line"><span class="setting">MountFlags=<span class="value">slave</span></span></span><br><span class="line"><span class="setting">LimitNOFILE=<span class="value"><span class="number">1048576</span></span></span></span><br><span class="line"><span class="setting">LimitNPROC=<span class="value"><span class="number">1048576</span></span></span></span><br><span class="line"><span class="setting">ExecStartPre=<span class="value">-/usr/bin/ip link set dev docker0 down</span></span></span><br><span class="line"><span class="setting">ExecStartPre=<span class="value">-/usr/sbin/brctl delbr docker0</span></span></span><br><span class="line"><span class="setting">ExecStart=<span class="value">/usr/lib/coreos/dockerd daemon --host=fd:// <span class="variable">$DOCKER_OPTS</span> <span class="variable">$DOCKER_CGROU</span> --bip=<span class="variable">$&#123;FLANNEL_SUBNET&#125;</span> --mtu=<span class="variable">$&#123;FLANNEL_MTU&#125;</span> <span class="variable">$DOCKER_OPTS</span></span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Install]</span></span><br><span class="line"><span class="setting">WantedBy=<span class="value">multi-user.target</span></span></span><br></pre></td></tr></table></figure>
<p>使用subnet.env中的参数启动docker service, 保证不同节点的docker容器网段不同。</p>
<h3 id="配置kubernetes组件">配置kubernetes组件</h3><p>etcd和网络配置好了以后后面的就没什么的了。<br>在<code>/etc/systemd/system/*.service</code>下创建systemd服务文件方便我们管理这些服务</p>
<p>在master节点创建</p>
<p><code>kube-apiserver.service</code></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">Requires=etcd2.service</span><br><span class="line">After=etcd2.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/opt/bin/kube-apiserver \</span><br><span class="line">        -<span class="ruby">-allow-privileged=<span class="keyword">true</span> \</span><br><span class="line"></span>        -<span class="ruby">-etcd-servers=<span class="symbol">http:</span>/<span class="regexp">/$private_ipv4:2379 \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-insecure-bind-address=0.0.0.0 \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-advertise-address=$private_ipv4 \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-service-cluster-ip-range=10.100.0.0/</span><span class="number">16</span> \</span><br><span class="line"></span>        -<span class="ruby">-runtime-config=extensions/v1beta1/daemonsets=<span class="keyword">true</span>,extensions/v1beta1/deployments=<span class="keyword">true</span>,extensions/v1beta1/ingress=<span class="keyword">true</span> \</span><br><span class="line"></span>        -<span class="ruby">-logtostderr=<span class="keyword">true</span></span><br><span class="line"></span>Restart=always</span><br><span class="line">RestartSec=10</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>kube-controller-manager.service</code></p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line"><span class="constant">Description</span>=Kubernetes Controller Manager</span><br><span class="line"><span class="constant">Documentation</span>=https:<span class="comment">//github.com/GoogleCloudPlatform/kubernetes</span></span><br><span class="line"><span class="constant">Requires</span>=kube-apiserver.service</span><br><span class="line"><span class="constant">After</span>=kube-apiserver.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="constant">ExecStart</span>=/opt/bin/kube-controller-manager \</span><br><span class="line">        --master=$private_ipv4:<span class="number">8080</span> \</span><br><span class="line">        --logtostderr=<span class="literal">true</span></span><br><span class="line"><span class="constant">Restart</span>=always</span><br><span class="line"><span class="constant">RestartSec</span>=<span class="number">10</span></span><br><span class="line">[Install]</span><br><span class="line"><span class="constant">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>kube-scheduler.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[Unit]</span></span><br><span class="line"><span class="setting">Description=<span class="value">Kubernetes Scheduler</span></span></span><br><span class="line"><span class="setting">Documentation=<span class="value">https://github.com/GoogleCloudPlatform/kubernetes</span></span></span><br><span class="line"><span class="setting">Requires=<span class="value">kube-apiserver.service</span></span></span><br><span class="line"><span class="setting">After=<span class="value">kube-apiserver.service</span></span></span><br><span class="line"><span class="title"></span><br><span class="line">[Service]</span></span><br><span class="line"><span class="setting">ExecStart=<span class="value">/opt/bin/kube-scheduler --master=<span class="variable">$private_ipv4</span>:<span class="number">8080</span> --logtostderr=<span class="keyword">true</span></span></span></span><br><span class="line"><span class="setting">Restart=<span class="value">always</span></span></span><br><span class="line"><span class="setting">RestartSec=<span class="value"><span class="number">10</span></span></span></span><br><span class="line"><span class="title">[Install]</span></span><br><span class="line"><span class="setting">WantedBy=<span class="value">multi-user.target</span></span></span><br></pre></td></tr></table></figure>
<p>在node节点创建</p>
<p><code>kubelet.service</code></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line"> Description=Kubernetes Kubelet</span><br><span class="line"> Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"> After=docker.service</span><br><span class="line"> Requires=docker.service</span><br><span class="line"></span><br><span class="line"> [Service]</span><br><span class="line"> ExecStartPre=/usr/bin/mkdir -p /etc/kubernetes/manifests</span><br><span class="line"> ExecStart=/opt/bin/kubelet \</span><br><span class="line">        -<span class="ruby">-address=<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> \</span><br><span class="line"></span>        -<span class="ruby">-allow-privileged=<span class="keyword">true</span> \</span><br><span class="line"></span>        -<span class="ruby">-cluster-dns=<span class="number">10.100</span>.<span class="number">0</span>.<span class="number">10</span> \</span><br><span class="line"></span>        -<span class="ruby">-cluster-domain=cluster.local \</span><br><span class="line"></span>        -<span class="ruby">-config=<span class="regexp">/etc/kubernetes</span><span class="regexp">/manifests \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-hostname-override=$private_ipv4 \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-api-servers=http:/</span><span class="regexp">/&lt;API_SERVER_IP&gt;:8080 \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="regexp">-pod-infra-container-image="kubernetes/pause</span><span class="string">" \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="string">-network-plugin-dir=/etc/cni/net.d \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="string">-network-plugin=cni \</span><br><span class="line"></span></span>        -<span class="ruby"><span class="string">-logtostderr=true</span><br><span class="line"></span></span> Restart=always</span><br><span class="line"> RestartSec=10</span><br><span class="line"></span><br><span class="line"> [Install]</span><br><span class="line"> WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>kube-proxy.service</code></p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">Unit]</span><br><span class="line">Description</span>=Kubernetes Proxy</span><br><span class="line"><span class="constant">Documentation</span>=https:<span class="comment">//github.com/GoogleCloudPlatform/kubernetes</span></span><br><span class="line"><span class="constant">Requires</span>=kubelet.service</span><br><span class="line"><span class="constant">After</span>=kubelet.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="constant">ExecStart</span>=/opt/bin/kube-proxy \</span><br><span class="line">        --master=http:<span class="comment">//&lt;API_SERVER_IP&gt;:8080 \</span></span><br><span class="line">        --proxy-mode=iptables \</span><br><span class="line">        --logtostderr=<span class="literal">true</span></span><br><span class="line"><span class="constant">Restart</span>=always</span><br><span class="line"><span class="constant">RestartSec</span>=<span class="number">10</span></span><br><span class="line">[Install]</span><br><span class="line"><span class="constant">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p><api_server_ip>部分替换成master的ip</api_server_ip></p>
<h3 id="小试牛刀">小试牛刀</h3><p>启动上面的所以service kubernetes集群应该就搭建起来了。我们来测试一下</p>
<p>新建一个<code>nginx.yaml</code></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: extensions/v1beta1</span><br><span class="line"><span class="attribute">kind</span>: Deployment</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: my-nginx</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">replicas</span>: <span class="number">2</span></span><br><span class="line">  <span class="attribute">template</span>:</span><br><span class="line">    <span class="attribute">metadata</span>:</span><br><span class="line">      <span class="attribute">labels</span>:</span><br><span class="line">        <span class="attribute">run</span>: my-nginx</span><br><span class="line">    <span class="attribute">spec</span>:</span><br><span class="line">      <span class="attribute">containers</span>:</span><br><span class="line">      - <span class="attribute">name</span>: my-nginx</span><br><span class="line">        <span class="attribute">image</span>: <span class="attribute">nginx</span>:alpine</span><br><span class="line">        <span class="attribute">ports</span>:</span><br><span class="line">        - <span class="attribute">containerPort</span>: <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; create -f ./nginx.yaml</span><br><span class="line"><span class="comment">// 查看pod运行状况</span></span><br><span class="line">&gt; kubectl get pods -l run=my-nginx -o wide</span><br><span class="line">NAME                        READY     STATUS    RESTARTS   AGE       NODE</span><br><span class="line">my-nginx-<span class="number">2643493705</span>-<span class="number">274</span>ab   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">1</span>m        <span class="number">192.168</span><span class="number">.64</span><span class="number">.9</span></span><br><span class="line">my-nginx-<span class="number">2643493705</span>-<span class="number">8</span>wr06   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">1</span>m        <span class="number">192.168</span><span class="number">.64</span><span class="number">.109</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到启动了两个nginx的pod</p>
<p>查看每个pod的ip</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; kubectl get pods -l run=my-nginx -o yaml | grep podIP</span><br><span class="line">    podIP: <span class="number">10.100</span><span class="number">.73</span><span class="number">.2</span></span><br><span class="line">    podIP: <span class="number">10.100</span><span class="number">.63</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>
<p>我们在内任一台机上执行</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl <span class="string">http:</span><span class="comment">//10.100.73.2</span></span><br></pre></td></tr></table></figure>
<p>应该会看到nginx的欢迎页面打印出来。</p>
<hr>
<p>参考资料</p>
<p>[1]<a href="http://qiankunli.github.io/2015/01/29/Kubernetes_installation.html" target="_blank" rel="external">http://qiankunli.github.io/2015/01/29/Kubernetes_installation.html</a></p>
<p>[2]<a href="https://github.com/shenshouer/calico-kubernetes" target="_blank" rel="external">https://github.com/shenshouer/calico-kubernetes</a> </p>
<p>[3]<a href="http://qinghua.github.io/kubernetes-in-mesos-8/" target="_blank" rel="external">http://qinghua.github.io/kubernetes-in-mesos-8/</a> </p>
<p>[4]<a href="http://kubernetes.io/docs/user-guide/connecting-applications/" target="_blank" rel="external">http://kubernetes.io/docs/user-guide/connecting-applications/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/05/29/deploy-k8s-on-coreos/" data-id="cjpny5rtl000ejm13gvtxy0po" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/05/29/deploy-k8s-on-coreos/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-coreos-osx-without-vagrant" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/29/coreos-osx-without-vagrant/" class="article-date">
  <time datetime="2016-05-29T03:35:27.000Z" itemprop="datePublished">2016-05-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/29/coreos-osx-without-vagrant/">OSX上摆脱vagrant搭建CoreOS集群</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一般我们在OSX下使用vagrant＋virtualbox部署虚拟机集群做开发测试。现在我们还可以有更轻量的选择——<a href="https://github.com/xhyve-xyz/xhyve" target="_blank" rel="external">xhyve</a>。xhyve是FreeBSD 下的虚拟技术 <a href="http://bhyve.org/" target="_blank" rel="external">bhyve</a> (The BSD Hypervisor) 的OSX移植，在OS X 10.10.3 Yosemite 之后的版本中可以使用。由于xhyve是基于FreeBSD原生的虚拟方案，所以它性能好并且非常的轻量，只有 230 KB，不依赖其他软件或库。当xhyve发布时CoreOS快速的跟进，推出了基于xhyve的<a href="https://github.com/coreos/coreos-xhyve" target="_blank" rel="external">coreos-xhyve</a>。这里我们使用<a href="https://github.com/TheNewNormal/corectl" target="_blank" rel="external">corectl</a>——一个coreos-xhyve的命令行工具来搭建CoreOS集群。</p>
<h2 id="安装corectl">安装corectl</h2><p>最快的方法使用brew</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">brew </span>install corectl</span><br></pre></td></tr></table></figure>
<p>从源码编译</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github<span class="class">.com</span>:TheNewNormal/corectl<span class="class">.git</span></span><br><span class="line">cd corectl</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>安装好后运行<code>corectl -h</code>可以看到所支持的命令</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">corectl -h</span><br><span class="line">CoreOS over OSX made simple.</span><br><span class="line">❯❯❯ <span class="keyword">http</span>://github.com/TheNewNormal/corectl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  corectl [flags]</span><br><span class="line">  corectl [<span class="command"><span class="keyword">command</span>]</span></span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  rm          Removes <span class="constant">one</span> <span class="operator">or</span> more CoreOS images <span class="built_in">from</span> <span class="built_in">local</span> fs</span><br><span class="line">  <span class="built_in">kill</span>        Halts <span class="constant">one</span> <span class="operator">or</span> more running CoreOS instances</span><br><span class="line">  ls          Lists locally available CoreOS images</span><br><span class="line">  <span class="built_in">load</span>        Loads CoreOS instances defined <span class="operator">in</span> <span class="operator">an</span> instrumentation <span class="built_in">file</span>.</span><br><span class="line">  <span class="built_in">version</span>     Shows corectl <span class="built_in">version</span> information</span><br><span class="line">  ps          Lists running CoreOS instances</span><br><span class="line">  query       Display information about <span class="operator">the</span> running CoreOS instances</span><br><span class="line">  pull        Pulls <span class="operator">a</span> CoreOS image <span class="built_in">from</span> upstream</span><br><span class="line">  run         Starts <span class="operator">a</span> <span class="built_in">new</span> CoreOS instance</span><br><span class="line">  ssh         Attach <span class="built_in">to</span> <span class="operator">or</span> run commands inside <span class="operator">a</span> running CoreOS instance</span><br><span class="line">  <span class="built_in">put</span>         copy <span class="built_in">file</span> <span class="built_in">to</span> inside VM</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      <span class="comment">--debug   adds extra verbosity, and options, for debugging purposes and/or power users</span></span><br><span class="line"></span><br><span class="line">Use <span class="string">"corectl [command] --help"</span> <span class="keyword">for</span> more information about <span class="operator">a</span> <span class="command"><span class="keyword">command</span>.</span></span><br><span class="line"></span><br><span class="line">All flags can also be configured via <span class="built_in">upper</span>-<span class="keyword">case</span> environment variables prefixed <span class="operator">with</span> <span class="string">"COREOS_"</span></span><br><span class="line">For example, <span class="string">"--debug"</span> =&gt; <span class="string">"COREOS_DEBUG"</span></span><br></pre></td></tr></table></figure>
<h2 id="运行CoreOS_VM">运行CoreOS VM</h2><h3 id="加载镜像">加载镜像</h3><p>第一次输入<code>sudo corectl run</code>即会自动下载最新的 CoreOS Alpha 镜像并加载运行，镜像文件放置的位置是<code>$HOME/.coreos/</code></p>
<p>run的参数还有</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line">  corectl run [flags]</span><br><span class="line"></span><br><span class="line">Aliases:</span><br><span class="line">  run, start</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      -<span class="ruby">-cdrom string          append an <span class="constant">CDROM</span> (.iso) to <span class="constant">VM</span></span><br><span class="line"></span>      -<span class="ruby">-channel string        <span class="constant">CoreOS</span> channel (default <span class="string">"alpha"</span>)</span><br><span class="line"></span>      -<span class="ruby">-cloud_config string   cloud-config file location (either a remote <span class="constant">URL</span> <span class="keyword">or</span> a local path)</span><br><span class="line"></span>      -<span class="ruby">-cpus int              <span class="constant">VM</span><span class="string">'s vCPUS (default 1)</span><br><span class="line"></span></span>  -<span class="ruby"><span class="string">d, --detached              starts the VM in detached (background) mode</span><br><span class="line"></span></span>  -<span class="ruby"><span class="string">h, --help                  help for run</span><br><span class="line"></span></span>  -<span class="ruby"><span class="string">l, --local latest          consumes whatever image is latest locally instead of looking online unless there'</span>s nothing available.</span><br><span class="line"></span>      -<span class="ruby">-memory int            <span class="constant">VM</span><span class="string">'s RAM, in MB, per instance (1024 &lt; memory &lt; 8192) (default 1024)</span><br><span class="line"></span></span>  -<span class="ruby"><span class="string">n, --name string           names the VM. (if absent defaults to VM'</span>s <span class="constant">UUID</span>)</span><br><span class="line"></span>      -<span class="ruby">-root string           append a (persistent) root volume to <span class="constant">VM</span></span><br><span class="line"></span>      -<span class="ruby">-sshkey string         <span class="constant">VM</span><span class="string">'s default ssh key</span><br><span class="line"></span></span>      -<span class="ruby"><span class="string">-tap string            append tap interface to VM</span><br><span class="line"></span></span>      -<span class="ruby"><span class="string">-uuid string           VM'</span>s <span class="constant">UUID</span> (default <span class="string">"random"</span>)</span><br><span class="line"></span>      -<span class="ruby">-version string        <span class="constant">CoreOS</span> version (default <span class="string">"latest"</span>)</span><br><span class="line"></span>      -<span class="ruby">-volume value          append disk volumes to <span class="constant">VM</span> (default [])</span><br><span class="line"></span></span><br><span class="line">Global Flags:</span><br><span class="line">      -<span class="ruby">-debug   adds extra verbosity, <span class="keyword">and</span> options, <span class="keyword">for</span> debugging purposes <span class="keyword">and</span>/<span class="keyword">or</span> power users</span><br><span class="line"></span></span><br><span class="line">All flags can also be configured via upper-case environment variables prefixed with "COREOS_"</span><br><span class="line">For example, "--debug" =&gt; "COREOS_DEBUG"</span><br></pre></td></tr></table></figure>
<p>想使用不同的镜像版本可以由<code>--channel alpha/beta/stable</code>指定</p>
<h3 id="数据持久化">数据持久化</h3><p>先新建一个5G的persistent.img盘</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">dd</span> <span class="keyword">if</span>=/dev/zero of= persistent<span class="class">.img</span>  bs=<span class="number">1</span>g count=<span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>格式化成ext4(需要e2fsprogs工具，安装<code>brew install e2fsprogs</code>)</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/Cellar/</span>e2fsprogs<span class="regexp">/1.42.12/</span>sbin<span class="regexp">/mke2fs  -t ext4 -m0 -F persistent.img</span></span><br></pre></td></tr></table></figure>
<p>运行时加上</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">corectl <span class="command">run</span> <span class="comment">--name core --volume absolute_or_relative_path/to/persistent.img</span></span><br></pre></td></tr></table></figure>
<p>启动后persistent.img被挂载在/dev/vda</p>
<p>ssh进入VM将/dev/vda 挂载 在 /data上</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">corectl</span> ssh core</span><br><span class="line"><span class="title">mkdir</span> /<span class="typedef"><span class="keyword">data</span></span></span><br><span class="line"><span class="title">sudo</span> mount /dev/vda /<span class="typedef"><span class="keyword">data</span></span></span><br></pre></td></tr></table></figure>
<p>后面数据就可以写入/data</p>
<h3 id="启动集群">启动集群</h3><p>从<a href="https://discovery.etcd.io" target="_blank" rel="external">https://discovery.etcd.io</a> 获取token</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">curl</span> -X GET <span class="string">'https://discovery.etcd.io/new?size=3'</span></span><br></pre></td></tr></table></figure>
<p>将token写入loud-config文件</p>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"></span><br><span class="line">coreos:</span><br><span class="line">  etcd2:</span><br><span class="line"><span class="comment">    # generate a new token for each unique cluster</span></span><br><span class="line"><span class="comment">    # from https://discovery.etcd.io/new?size=n where n = cluster size</span></span><br><span class="line"><span class="comment">    # discovery url to bootstrap the cluster</span></span><br><span class="line">    discovery: hhttps://discovery.etcd.io/&#123;<span class="variable">$TOKEN&#125;</span></span><br><span class="line"><span class="comment">    # multi-region and multi-cloud deployments need to use $public_ipv4</span></span><br><span class="line"><span class="comment">    # list of member’s client urls to advertise information to the rest of the cluster</span></span><br><span class="line">    advertise-client-urls: <span class="keyword">http</span>://<span class="variable">$public_ipv4</span>:<span class="number">2379</span></span><br><span class="line"><span class="comment">    # this address is used to communicate etcd data around the cluster</span></span><br><span class="line">    initial-advertise-peer-urls: <span class="keyword">http</span>://<span class="variable">$private_ipv4</span>:<span class="number">2380</span></span><br><span class="line"><span class="comment">    # listen on both the official ports and the legacy ports</span></span><br><span class="line"><span class="comment">    # legacy ports can be omitted if your application doesn't depend on them</span></span><br><span class="line"><span class="comment">    # url to listen for client traffic</span></span><br><span class="line">    listen-client-urls: <span class="keyword">http</span>://<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">2379</span>,<span class="keyword">http</span>://<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">4001</span></span><br><span class="line"><span class="comment">    # url to listen for peer traffic</span></span><br><span class="line">    listen-peer-urls: <span class="keyword">http</span>://<span class="variable">$private_ipv4</span>:<span class="number">2380</span>,<span class="keyword">http</span>://<span class="variable">$private_ipv4</span>:<span class="number">7001</span></span><br><span class="line">  fleet:</span><br><span class="line">    public-ip: <span class="variable">$public_ipv4</span></span><br><span class="line">  flannel:</span><br><span class="line">    interface: <span class="variable">$public_ipv4</span></span><br><span class="line">  units:</span><br><span class="line">    - name: etcd2.service</span><br><span class="line">      command: start</span><br><span class="line">    - name: fleet.service</span><br><span class="line">      command: start</span><br></pre></td></tr></table></figure>
<p>启动三个CoreVM</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo corectl <span class="command">run</span> <span class="comment">--cloud_config ./cloud-config-file --name core-1</span></span><br><span class="line">sudo corectl <span class="command">run</span> <span class="comment">--cloud_config ./cloud-config-file --name core-2</span></span><br><span class="line">sudo corectl <span class="command">run</span> <span class="comment">--cloud_config ./cloud-config-file --name core-3</span></span><br></pre></td></tr></table></figure>
<p>随便ssh进一个VM使用<code>etcdctl  member list</code>看到集群已经建立</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etcdctl  member list</span><br><span class="line">28fede81eb6ee920: name=<span class="number">78c956f8</span>b901497fbd<span class="number">909c0a4</span>fa4a9f7 peerURLs=http://<span class="number">192.168.64.30</span>:2380 clientURLs=http://<span class="number">192.168.64.30</span>:2379 isLeader=false</span><br><span class="line">a4661fcb2e28c76a: name=1a7f48cd<span class="number">84c540528</span>b<span class="number">0a61483f07</span>1307 peerURLs=http://<span class="number">192.168.64.31</span>:2380 clientURLs=http://<span class="number">192.168.64.31</span>:2379 isLeader=false</span><br><span class="line">eebd<span class="number">0c9e16e3</span>e5be: name=fd92329bf3004bf<span class="number">98f3a65536</span>06a00b0 peerURLs=http://<span class="number">192.168.64.32</span>:2380 clientURLs=http://<span class="number">192.168.64.32</span>:2379 isLeader=true</span><br></pre></td></tr></table></figure>
<p>更多信息可以参考这个项目<a href="https://github.com/TheNewNormal/coreos-osx" target="_blank" rel="external">coreos-osx</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://sineyuan.github.io/2016/05/29/coreos-osx-without-vagrant/" data-id="cjpny5rtm000fjm13ro1y8xyz" class="article-share-link">Share</a>
      
        <a href="http://sineyuan.github.io/2016/05/29/coreos-osx-without-vagrant/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <a href="/" class="logo">STep by STep</a>
      &copy; 2018 Sine Yuan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    
<script>
  var disqus_shortname = 'sineyuansblog';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/jquery.scrollLoading.js" type="text/javascript"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>